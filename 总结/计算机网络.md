# 计算机网络

- [第一章 计算机网络体系结构](#计算机网络体系结构)
- [第二章 物理层](#物理层)
- [第三章 数据链路层](#数据链路层)
- [第四章 网络层](#网络层)
- [第五章 传输层](#传输层)
- [第六章 应用层](#应用层)

# 计算机网络体系结构

## 计算机网络概述

### 计算机网络的概念

计算机网络是一个**将计算机系统，通过通信设备与线路连接起来**，由**功能完善的软件**实现**资源共享**和**信息传递**的系统

简而言之，计算机网络就是一些互联的、自治的**计算机系统的集合**

在计算机网络发展的不同阶段，人们对计算机网络给出了不同的定义：

#### 广义观点

这种观点认为，计算机网络是**实现远程信息处理的系统或能进一步达到资源共享的系统**

广义的观点定义了一个计算机通信网络，它在物理结构上具有计算机网络的雏形

但**资源共享能力弱**，是计算机网络发展的**低级阶段**

#### 资源共享观点

这种观点认为，计算机网络是以**能够相互共享资源的方式互联起来的自治计算机系统的集合**

该定义包含三层含义：

1. 目的：资源共享
2. 组成单元：分布在不同地理位置的多台独立的自治计算机
3. 网络中的计算机必须遵循的统一规则：网络协议

该定义符合**目前计算机网络的基本特征**

#### 用户透明性观点

这种观点认为，存在一个能为用户自动管理资源的网络操作系统，它能够调用用户所需要的资源，而整个网络就像一个大的计算机系统一样对用户是透明的

用户使用网络就像使用一台单一的超级计算机，无须了解网络的存在、资源的位置信息

用户透明性观点的定义描述了一个分布式系统，它是网络**未来发展追求的目标**

### 计算机网络的组成

1. 从组成部分上看：一个完整的计算机网络**主要由硬件、软件、协议三大部分组成**

   - 硬件：主要由**主机、通信链路、交换设备、通信处理机**（如网卡）等组成
   - 软件：主要包括**实现资源共享**和**方便用户使用的工具软件**，软件部分**多属于应用层**
   - 协议：是计算机网络的**核心**，协议**规定了网络传输数据时所遵循的规范**

2. 从工作方式上看：计算机网络（Internet）可分为**边缘部分和核心部分**

   - 边缘部分：由所有连接到因特网上、供用户直接使用的**主机组成**，用来进行**通信和资源共享**
   - 核心部分：由大量的**网络和连接这些网络的路由器**组成，它为边缘部分**提供连通性和交换服务**

   <img src="..\images\image-20211124201750963.png" alt="image-20211124201750963"  />

3. 从功能组成上看：计算机网络由**通信子网和资源子网**组成（计算机网络基本组成）

   - 通信子网：由各种**传输介质、通信设备和相应的网络协议**组成（即物理层、数据链路层、网络层的功能）

     使网络具有数据传输、交换、控制和存储的能力，**实现联网计算机之间的数据通信**

   - 资源子网：是**实现资源共享功能的设备及其软件**的集合（即会话层、表示层、应用层的功能）

     向网络用户**提供共享其他计算机上的硬件资源、软件资源和数据资源的服务**

### 计算机网络的功能

1. 数据通信：计算机网络**最基本和最重要的功能**

   实现联网**计算机之间各种信息的传输**，并将分散在不同地理位置的计算机联系起来，进行统一的调配、控制和管理

2. 资源共享：资源共享可以是**软件共享、数据共享，也可以是硬件共享**

   它使计算机网络中的**资源互通、分工协作**，从而极大地提高硬件资源、软件资源和数据资源的利用率

3. 分布式处理：将其处理的**某个复杂任务分配给网络中的其他计算机系统**，以提高整个系统的利用率

4. 提高可靠性：计算机网络中的各台计算机可以**通过网络互为替代机**

5. 负载均衡：**将工作任务均衡地分配**给计算机网络中的各台计算机

除以上几大主要功能外，计算机网络还可以实现电子化办公与服务、远程教育、娱乐等功能

### 计算机网络的分类

#### 按分布范围分类

1. 广域网 WAN：广域网的任务是**提供长距离通信**

   覆盖范围通常是直径为几十千米到几千千米的区域，因而有时也称远程网（**国与国之间**）

   广域网是**因特网的核心部分**，连接广域网的各结点交换机的链路一般都是**高速链路**，具有较大的通信容量

2. 城域网 MAN：覆盖范围可以跨越**几个街区甚至整个城市**，覆盖区域的直径范围是 `5～50km`

   城域网大多**采用以太网技术**，因此有时也常并入局域网的范围讨论

3. 局域网 LAN：一般用微机或工作站通过高速线路相连，**覆盖范围较小，直径为几十米到几千米的区域**

   局域网在计算机配置的数量上没有太多的限制，少的可以只有两台，多的可达几百台

4. 个人区域网 PAN：在个人工作的地方将消费电子设备（如手机）用无线技术连接起来的网络，也常称为无线个人区域网 `WPAN`，覆盖区域的直径约为 `10m`

#### 按传输技术分类

1. 广播式网络：所有联网计算机都**共享一个公共通信信道**

   当一台计算机利用共享通信信道发送报文分组时，所有其他的计算机都会收听到这个分组

   接收到该分组的计算机将通过检查目的地址来决定是否接收该分组

   **局域网基本上都采用广播式通信技术**，广域网中的无线、卫星通信网络也采用广播式通信技术

2. 点对点网络：**每条物理线路连接一对计算机**，**广域网基本都属于点对点网络**

   若通信的两台主机之间**没有直接连接的线路**，则它们的分组传输**就要通过中间结点进行接收、存储和转发**，直至目的结点

是否采用分组存储转发与路由选择机制是 点对点式网络 还是 广播式网络 的重要区别

传统上，**局域网使用广播技术，而广域网使用交换技术**，区别局域网和广域网的关键在于**所采用的协议**

#### 按拓扑结构分类

网络拓扑结构指由**网中结点（路由器、主机等）与通信线路之间的几何关系**表示的网络结构，主要指**通信子网的拓扑结构**

网络的拓扑结构主要有：

<img src="..\images\image-20211124202023469.png" alt="image-20211124202023469" style="zoom:150%;" />

1. 总线形网络：用**单根传输线把计算机连接起来**

   优点：建网容易、增/减结点方便、节省线路；缺点：重负载时通信效率不高、总线任意一处对故障敏感

2. 星形网络：每个终端或计算机都**以单独的线路与中央设备相连**

   中央设备早期是计算机，现在一般是交换机或路由器

   优点：便于集中控制和管理；缺点：成本高、中心设备对故障敏感

3. 环形网络：所有计算机接口设备**连接成一个环**

   环形网络最典型的例子是令牌环局域网

   环可以是单环，也可以是双环，**环中信号是单向传输的**

4. 网状网络：每个结点**至少有两条路径与其他结点相连**，其有规则型和非规则型两种

   优点：可靠性高；缺点是控制复杂、线路成本高

以上 4 种基本的网络拓扑结构**可以互联为更复杂的网络**；星形、总线形和环形网络多用于**局域网**，网状网络多用于**广域网**

#### 按使用者分类

1. 公用网 Public Network：指电信公司出资建造的大型网络

   指所有愿意按电信公司的规定**交纳费用的人都可以使用这种网络**，因此也称公众网

2. 专用网 Private Network：指某个部门为满足本单位特殊业务的需要而建造的网络

   这种网络**不向本单位以外的人提供服务**，例如铁路、电力、军队等部门的专用网

#### 按交换技术分类

交换技术是指各台主机通信设备各种组合之间**为交换信息所采用的数据格式和交换装置的方式**

##### 电路交换网络

在源结点和目的结点之间**建立一条专用的通路用于传送数据**，包括**建立连接、传输数据和断开连接**阶段（如传统电话网络）

该类网络的主要特点是整个报文的比特流连续地从**源点直达终点**，好像是在一条管道中传送

优点：数据直接传送、时延小；缺点：线路利用率低、不能充分利用线路容量、不便于进行差错控制

##### 报文交换网络

用户数据加上源地址、目的地址、校验码等**辅助信息**，然后封装成报文

整个报文传送到相邻结点，全部存储后，查表**转发**给下一个结点，重复这一过程直到到达目的结点，也称**存储-转发网络**

优点：较为充分地利用线路容量；不同数据传输速率的转换；格式转换；实现一对多、多对一的访问；实现差错控制

缺点：**增大了资源开销，增加了缓冲时延**，需额外的控制机制来**保证多个报文的顺序不乱序**，缓冲区难以管理（大小不定）

##### 分组交换网络

也称**包交换网络**，将数据分成较短的**固定长度的数据块**，在每个数据块中加上辅助信息组成分组，以**存储-转发方式传输**

其主要特点是单个分组（报文的一部分）传送到相邻结点，**存储后查找转发表**，转发到下一个结点

现在基本使用分组交换网络，除具有报文交换网络的优点外，还有：

1. 缓冲易于管理
2. 包的平均时延更小，网络占用的平均缓冲区更少
3. 更易于标准化
4. 更适合应用

------

注意：电路交换网络**需要连接**，报文和分组交换网络**需要转发**

思考：在存储-转发方式，**包越大转发数据的发送延迟就越大**，但总的辅助信息会减少，所以**发送延迟会变少**

#### 按传输介质分类

传输介质可分为有线和无线两大类，因此网络可以分为**有线网络和无线网络**

- 有线网络：分为双绞线网络、同轴电缆网络等
- 无线网络：分为蓝牙、微波、无线电等类型

### 计网的标准化工作及相关知识*

计算机网络的标准化对计算机网络的发展和推广起到了极为重要的作用

因特网的所有标准都以 RFC 的形式在因特网上发布，经过以下四个阶段就是因特网标准：

1. 因特网草案 Internet Draft：这个阶段还不是 RFC 文档
2. 建议标准 Proposed Standard：把草案发送给机构被通过后，就开始成为 RFC 文档
3. 草案标准 Draft Standard：发到网上被很多人进行评论修改后
4. 因特网标准 Internet Standard：`IETF、IAB` 审核通过后

此外，还有试验的 RFC 和提供信息的 RFC，之间的关系：

![image-20211124202340971](..\images\image-20211124202340971.png)

在国际上，负责制定、实施相关网络标准的标准化组织众多，主要有如下几个：

- 国际标准化组织 ISO：其制定的主要网络标准或规范有 OSI 参考模型、`HDLC` 等
- 国际电信联盟 `ITU`：其下属机构 `ITU-T` 制定了大量有关远程通信的标准
- 国际电气电子工程师协会 IEEE：世界上最大的专业技术团体，最著名的研究成果是 802 标准

### 计算机网络的性能指标

1. 带宽 Bandwidth：**网络的通信线路所能传送数据的能力**，看作**最高数据传输速率**，单位是比特/秒

2. 时延 Delay：指**数据从网络的一端传送到另一端所需要的总时间**，它由以下部分构成：

   - 发送时延：结点**将分组的所有比特推向链路所需的时间**，即发送全部数据所需的时间，因此也称**传输时延**

     计算公式：**发送时延 = 分组长度 / 信道宽度**

   - 传播时延：电磁波在信道中传播一定的距离需要花费的时间，即**一个比特从链路的一端传播到另一端所需的时间**

     计算公式：**传播时延 = 信道长度 / 电磁波在信道上的传播速率**

   - 处理时延：数据在交换结点为**存储转发**而进行的一些必要的处理**所花费的时间**

     例如，分析分组的首部、从分组中提取数据部分、进行差错检验或查找适当的路由等

   - 排队时延：分组在路由器中的**输入/输出队列中排队等待处理所需要的时间**，排队接受数据或排队发送数据

   数据在网络中经历的总时延为：**总时延 = 发送时延 + 传播时延 + 处理时延 + 排队时延**

   注意：若题目没有说明，**排队时延和处理时延一般可忽略不计**

   注意：高速链路提高了数据**发送速率**，减少了数据的**发送时延**，但对传播延迟没有影响（仍然使用电磁波传播）

3. 时延带宽积：发送端发送的**第一个比特到达终点时**，发送端**已经发出了多少个比特**

   又称以比特为单位的链路长度，**时延带宽积 = 传播时延 × 信道带宽**

   一个代表链路的圆柱形管道，其长度表示链路的传播时延，横截面积表示链路带宽，时延带宽积就是它的体积

   <img src="..\images\image-20211124202523869.png" alt="image-20211124202523869" style="zoom:150%;" />

4. 往返时延 `RTT`：**从发送端发送数据开始，到发送端收到来自接收端的确认**，总共经历的时延

   在互联网中，往返时延还包括各中间结点的处理时延、排队时延及转发数据时的发送时延

5. 吞吐量 Throughput：**单位时间内通过某个网络的数据量**，受网络带宽或网络额定速率的限制

6. 速率 Speed：连接到计算机网络上的**主机在数字信道上发送数据的速率**，也称**数据传输速率**、数据率或比特率

   单位是 `b/s、kb/s、Mb/s、Gb/s` 表示，在计算机网络中，**最高数据传输速率称为带宽**

7. 信道利用率：指出某一信道**有百分之多少的时间是有数据通过的**，**信道利用率 = 有数据通过时间 / (有 + 无) 数据通过时间**

   注意：通道利用率越大，时延就会越大

额外：一段时间内，链路有多少比特取决于带宽（或传输速率），而比特跑了多远取决于传播速率

## 计算机网络体系结构与参考模型

### 计算机网络分层结构

为了降低协议设计和调试过程的复杂性，对网络进行研究、实现和维护，促进标准化工作，对计算机网络体系进行分层

计算机网络体系结构 Architecture 是**计算机网络及其功能的定义**，是计算机网络中**各层及其协议和层间接口的集合**

计算机网络体系结构是**抽象的**，具体实现的是计算机的软件和硬件，它的分层的基本原则如下：

1. 每层都实现一种**相对独立的功能**，降低系统的复杂度
2. 各层之间界面自然清晰，易于理解，**相互交流尽可能少**
3. **各层功能的定义独立于具体的实现方法**，可以采用最合适的技术来实现
4. 保持**下层对上层的独立性**，上层单向使用下层提供的服务
5. 整个分层结构应**能促进标准化工作**

分层的体系结构易于更新\替换单个模块，易于调试，易于交流，易于抽象，易于标准化

层次越多，有些功能在不同层中难免重复出现；层次越少，就会使每层的协议太复杂

因此，在分层时应考虑层次的清晰程度与运行效率间的折中、层次数量的折中

在计算机网络的分层结构中，**第 n 层中的活动元素通常称为第 n 层实体**

- 实体：**任何可收发信息的硬件或软件进程**，通常是一个特定的软件模块
- 对等层：**不同机器上的同一层**
- 对等实体：**同一层的实体**
- 第 n 层实体实现的服务为第 n + 1 层所利用，第 n 层称为服务提供者，第 n  + 1 层则服务于用户

**每一层有自己传送的数据单位**，其名称、大小、含义也各有不同

- 服务数据单元 SDU：为**完成用户所要求的功能而应传送的数据**，第 n 层 SDU 为 n-SDU
- 协议控制信息 PCI：**控制协议操作的信息**
- 协议数据单元 PDU：对等层次之间**传送的数据单位**称为该层的 PDU

各个层次中，每个报文都分为数据部分 SDU 和控制信息部分 PCI，**共同组成 PDU**；**高层的 PDU 是 底层的 SDU**

![image-20211126202359934](..\images\image-20211126202359934.png)

具体地，层次结构的含义包括以下几方面：

1. 第 n 层的实体要使用第 n - 1 层的服务，并向第 n + 1 层提供本层的服务，提供本层及其下面服务的总和

2. 最低层只提供服务，是整个层次结构的基础

   中间各层既是下一层的服务使用者，又是上一层的服务提供者

   最高层面向用户提供服务

3. **上一层只能通过相邻层间的接口使用下一层的服务**；下一层所提供服务的**实现细节对上一层透明**

4. 两台主机通信时，对等层在逻辑上有一条直接信道，表现为不经过下层就把信息传送到对方

### 计网协议、接口、服务的概念

#### 协议

协议，就是**规则的集合**，必须遵循一些规则才能在网络中交换数据，规则必须规定所交换的数据的格式及有关的同步问题

网络协议 Network Protocol：**为进行网络中的数据交换而建立的规则**，用于控制两个对等实体进行通信，是**水平的**

协议由语法、语义和同步三部分组成：

- 语法：规定了**传输数据的格式**
- 语义：规定了**所要完成的功能**，解释格式中某部分的含义
- 同步：规定了**执行各种操作的条件、时序关系**等

一个完整的协议通常应具有线路管理（建立、释放连接）、差错控制、数据转换等功能

#### 接口

接口是同一结点内**相邻两层间交换信息的连接点**，是一个系统内部的规定，只能为**紧邻的层次之间**定义接口

在典型的接口上，同一结点相邻两层的实体通过服务访问点 SAP 进行交互，**接口是服务的访问入口**

服务是通过 SAP 提供给上层使用的，第 n 层的 SAP 就是第 n + 1 层可以访问第 n 层服务的地方

每个 SAP 都有一个能够标识它的地址。SAP 是一个**抽象的概念**，它实际上是一个逻辑接口，与硬件接口不一样

#### 服务

服务是指**下层为紧邻的上层提供的功能调用**，它是**垂直的**

对等实体在协议的控制下，使用下一层所提供的服务，使得本层能为上一层提供服务

上层使用下层所提供的服务时必须与下层交换一些命令，这些命令在 OSI 参考模型中称为服务原语：

1. 请求 Request：用户 → 提供者，**请求完成某项工作**
2. 指示 Indication：提供者 → 用户，**指示用户做某件事情**
3. 响应 Response：用户 → 提供者，**作为对指示的响应**
4. 证实 Confirmation：提供者 → 用户，**作为对请求的证实**

这 4 类原语用于不同的功能，如建立连接、传输数据和断开连接等

有应答服务包括全部原语，而无应答服务则只有请求和指示两类原语，下面是它们的关系：

![image-20211126202552956](..\images\image-20211126202552956.png)

协议和服务在概念上是不一样的：

- **只有本层协议的实现才能保证向上一层提供服务**
- 本层的服务用户**只能看见服务而无法看见下层的协议**
- **协议是水平的；服务是垂直的**
- 只有那些**能够被高一层实体“看得见”的功能才称为服务**

协议、接口、服务三者之间的关系下：

![image-20211126202645175](..\images\image-20211126202645175.png)

计算机网络提供的服务按以下分类：

##### 面向连接服务与无连接服务

1. 面向连接服务：**通信前双方必须先建立连接**，分配相应的资源，以保证通信能正常进行，**传输结束后释放连接和资源**

   因此这种服务可以分为连接建立、数据传输和连接释放三个阶段，如 TCP 协议

2. 无连接服务：**不需要先建立连接，可直接发送数据**，把每个带有目的地址的包传送到线路上，由系统选定路线进行传输

   这是一种**不可靠的服务**，这种服务常被描述为尽最大努力交付，如 IP、UDP 协议

##### 可靠服务和不可靠服务

- 可靠服务：网络具有纠错、检错、应答机制，**能保证数据正确、可靠地传送到目的地**

- 不可靠服务：网络只是尽量正确、可靠地传送，而**不能保证数据正确、可靠地传送到目的地**，是一种尽力而为的服务

  不可靠服务的网络，其网络的正确性、**可靠性要由应用或用户来保障**，如用户采取纠错措施把不可靠服务变成可靠服务器

##### 有应答服务和无应答服务

- 有应答服务：**接收方在收到数据后向发送方给出相应的应答**，该应答由传输系统内部自动实现，而不由用户实现
- 无应答服务：**接收方收到数据后不自动给出应答**，若需要应答，则由高层实现

### OSI 参考模型

国际标准化组织 ISO 提出的网络体系结构模型，称为开放系统互连参考模型 OSI/RM，通常简称为 OSI 参考模型

OSI 参考模型有 7 层：**物理层、数据链路层、网络层、传输层、会话层、表示层、应用层**

低三层统称为**通信子网**，它是**为了联网而附加的通信设备**，完成数据的传输功能；高三层统称为**资源子网**，它相当于计算机系统，完成数据的处理等功能；**传输层承上启下**

<img src="..\images\image-20211126203023985.png" alt="image-20211126203023985" style="zoom:150%;" />

#### 物理层 Physical Layer

物理层的**传输单位是比特**，任务是透明地传输比特流，功能是在物理媒体上为数据端设备**透明地传输原始比特流**

主要定义<u>数据终端设备 `DTE` 和数据通信设备 `DCE` 的物理与逻辑连接方法</u>，**物理层协议（物理层规程）也称物理层接口标准**

物理层接口标准很多，如 `EIA-232C`、`EIA/TIA RS-449`、`CCITT` 的 `X.21` 等

这是两个通信结点及它们间的一段通信链路，物理层主要研究以下内容：

![image-20211126203147282](..\images\image-20211126203147282.png)

1. 规定**通信链路与通信结点之间接口的一些参数**，如机械形状和尺寸、交换电路的数量和排列等，如网线接口
2. 规定**通信链路上传输的信号的意义和电气特征**，如高电平是 1 低电平是 0

注意：传输信息所利用的一些**物理媒体**，如双绞线、光缆、无线信道等，**在物理层协议下面**，可以当作第 0 层

#### 数据链路层 Data Link Layer

数据链路层的**传输单位是帧**，任务是**将网络层传来的 IP 数据报组装成帧**

功能为物理寻址、成帧、差错控制、流量控制、传输管理、数据重发等：

- 差错控制：由于外界噪声的干扰，物理层传输时高点平变成低电平，从而发生差错

  两个结点之间规定一些数据链路层协议后，就可以**检测出这些差错**，然后把收到的错误信息**丢弃**

- 流量控制：当两个性能不同的结点传送数据时，**协调两个结点的速率，防止一方数据发送太快导致丢失**

- 通道控制：在广播式网络中，要处理**如何控制对共享信道的访问**（共享通道只能有一个人发送信息）

  数据链路层的一个特殊的子层——介质访问子层，就是专门处理这个问题的

典型的数据链路层协议有 `SDLC、HDLC、PPP、STP` 和帧中继等

#### 网络层 Network Layer

网络层的**传输单位是数据报（分组）**，它关心的是通信子网的运行控制，主要任务是<u>把网络层的协议数据单元从源端传到目的端</u>，为分组交换网上的不同主机提供通信服务

关键问题是对分组进行路由选择，并实现流量控制、拥塞控制、差错控制和网际互联等功能：

- 路由选择：A 到达 B 有多条路径，路由选择就是**根据网络的情况，利用相应的路由算法计算出一条合适的路径**

  ![image-20211127150451197](..\images\image-20211127150451197.png)

- 流量控制：与数据链路层含义一样

- 差错控制：**两节点直接约定检错规则**，如奇偶校验码，接受方在接受分组时，若发现错误就进行**纠正或丢弃**

- 拥塞控制：**采取一定的措施来缓解拥塞状态**，防止拥塞状态让网络中的结点无法正常通信

  拥塞状态：上图中的结点都处于来不及接收分组而要丢弃大量分组的情况

- 网际互连：因特网是由大量异构网络通过路由器相互连接起来的很大的互联网，用于实现通信

  因特网的网络层也称网际层或 IP 层，因为其主要协议是无连接的网际协议 IP 和许多路由选择协议

网络层的协议有 `IP、IPX、ICMP、IGMP、ARP、RARP、OSPF` 等

#### 传输层 Transport Layer

传输层也称运输层，传输单位是**报文段 TCP** 或**用户数据报 UDP**，负责**主机中两个进程之间的通信**（端到端）

功能是**为端到端连接提供可靠的传输服务**，为端到端连接提供流量控制、差错控制、服务质量、数据传输管理等服务

使用传输层的服务，高层用户可以直接进行端到端的数据传输，从而**忽略通信子网的存在**

由于一台主机可同时运行多个进程，因此传输层具有复用和分用的功能：

- 复用：多个应用层进程可**同时使用下面传输层的服务**
- 分用：传输层把收到的信息**分别交付给上面应用层中相应的进程**

传输层的协议有 TCP、UDP

#### 会话层 Session Layer

会话层**允许不同主机上的各个进程之问进行会话**

会话：在传输层的基础上为表示层实体或用户进程建立连接并在连接上有序地传输数据

会话层负责**管理主机间的会话进程**，包括建立，管理及终止进程间的会话

会话层可以**使用校验点使通信会话在通信失效时从校验点继续恢复通信**，实现数据同步

#### 表示层 Presentation Layer

表示层主要处理**在两个通信系统中交换信息的表示方式**

不同机器采用的编码和表示方法不司，使用的数据结构也不同

表示层采用抽象的标准方法定义数据结构，并采用标准的编码形式，**让不同机器实现数据与信息的交换**

**数据压缩、加密和解密**也是表示层可提供的数据表示变换功能

#### 应用层 Application Layer

应用层是 OSI 参考模型的最高层，是**用户与网络的界面**

因为用户的实际应用多种多样，这就要求应用层采用不同的应用协议来解决不同类型的应用要求

应用层是**最复杂**的一层，使用的协议也**最多**

典型的协议有用于文件传送的 FTP、用于电子邮件的 SMTP、用于万维网的 HTTP 等

#### 总结

<img src="..\images\image-20220807180638412.png" alt="image-20220807180638412" style="zoom:150%;" />

### TCP/IP 模型

ARPA 在研究 `ARPAnet` 时提出了 TCP/IP` 模型，模型从低到高依次为**网络接口层、网际层、传输层和应用层**

TCP/IP 由于得到广泛应用而成为事实上的国际标准（现有协议后有标准）

![image-20211126203535560](..\images\image-20211126203535560.png)

#### 网络接口层

类似于 OSI 的物理层 + 数据链路层，**表示与物理网络的接口**

实际上该层只是指出主机必须使用某种协议与网络连接，以便在其上传递 IP 分组

<u>具体的物理网络既可以是各种类型的局域网，如以太网、令牌环网、令牌总线网等</u>（异构网络）

也可以是诸如电话网、`SDH`、`X.25`、帧中继和 ATM 等公共数据网络

网络接口层的作用是从主机或结点**接收 IP 分组，并把它们发送到指定的物理网络上**

#### 网际层（主机-主机）

是 TCP/IP 体系结构的**关键部分**，和 OSI 的网络层很相似

网际层**将分组发往任何网络**，并为之独立地**选择合适的路由**

但它**不保证各个分组有序地到达**，各个分组的有序交付**由高层负责**

网际层定义了标准的分组格式和协议，即 IP 协议，当前采用的 IP 协议是第 4 版，即 `IPv4`，它的下一版本是 `IPv6`

#### 传输层（进程-进程）

的功能同样和 OSI 的传输层类似，即使得**发送端和目的端主机上的对等实体进行会话**

传输层主要使用以下两种协议：

1. 传输控制协议 TCP：**面向连接的**，数据传输的单位是**报文段**，能够提供**可靠的交付**
2. 用户数据报协议 UDP：**无连接的**，数据传输的单位是**用户数据报**，**不保证提供可靠的交付**，只是尽最大努力交付

#### 应用层（用户-用户）

包含**所有的高层协议**，如：

1. 虚拟终端协议 Telnet
2. 文件传输协议 FTP
3. 域名解析服务 DNS
4. 电子邮件协议 SMTP
5. 超文本传输协议 HTTP

------

IP 协议是因特网中的核心协议

TCP/IP 可以为各式各样的应用提供服务（everything over IP）

TCP/IP 也允许 IP 协议在由各种网络构成的互联网上运行（IP over everything）

### 两个模型的比较

TCP/IP 模型与 OSI 参考模型的相似之处：

1. **都采取分层的体系结构**，将庞大且复杂的问题划分为若干较容易处理的、范围较小的问题，而且分层的功能也大体相似
2. **都是基于独立的协议栈的概念**
3. **都可以解决异构网络的互联**，实现世界上不同厂家生产的计算机之间的通信

![image-20211126203649879](..\images\image-20211126203649879.png)

TCP/IP 模型与 OSI 参考模型的差别：

1. OSI 精确地定义了服务、协议和接口；TCP/IP 模型在这三个概念上却没有明确区分

2. OSI 先模型后协议，没有偏向于任何特定的协议，**通用性良好**；但设计者对协议没有经验，**层次划分不够好**

   TCP/IP 先协议后模型，不会出现协议不能匹配模型的情况，但**不适合于任何其他非 TCP/IP 的协议栈**

3. TCP/IP 将网际协议 IP 作为一个**单独的重要层次**

   OSI 在网络层中**划分出一个子层**来完成类似于 TCP/IP 模型中的 IP 的功能

4. OSI 在**网络层支持无连接和面向连接的通信**，但在**传输层仅有面向连接的通信**

   TCP/IP 在**网际层仅有无连接的通信模式**，但**传输层支持无连接和面向连接两种模式**

OSI 的缺点：

1. 基于 OSI 参考模型的**软件效率极低**
2. **缺乏市场与商业动力，结构复杂，实现周期长，运行效率低**

### 五层模型

无论是 OSI 参考模型还是 TCP/IP 模型，都不是完美的，对二者的讨论和批评都很多

因此综合 OSI 和 TCP/IP 的优点，采用一种只有 5 层协议的体系结构：

![image-20211126203750388](..\images\image-20211126203750388.png)

每个协议栈的**最顶端都是一个面向用户的接口**，下面各层是为通信服务的协议

通信就是一个**装包和拆包**的过程：

1. 用户把自己能够理解的自然语言给到应用层
2. 从应用层开始除物理层外每层添加一些控制信息
3. 在物理层把最终数据转换为比特流转发
4. 到达目的端进行拆包，最后拆回自然语言给目的用户

注意：数据链路层除了头部要加信息外，尾部也要加信息

![image-20211126203831425](..\images\image-20211126203831425.png)

# 物理层

## 通信基础

### 基本概念

#### 数据、信号与码元

**通信的目的是传送信息**，如文字、图像和视频等

数据是指传送**信息的实体**，信号则是数据的**电气或电磁表现**，是数据在传输过程中的存在形式

数据和信号都可用模拟的或数字的来修饰：

1. **连续变化**的数据或信号称为**模拟数据或模拟信号**
2. 取值**仅允许为有限的几个离散数值**的数据或信号称为**数字数据或数字信号**

数据传输方式可分为串行传输和并行传输：

1. 串行传输：**1 比特 1 比特地按照时间顺序传输**，远距离通信通常采用串行传输
2. 并行传输：若干比特通过**多条通信 信道同时传输**，常用于计算机内部

码元是**数字信号**的计量单位，是**一个固定时长的信号波形**（数字脉冲），该时长称为**码元宽度**

表示一位 k 进制数字的码元称为 **k 进制码元**，1 码元**携带 $\log_2k$ 比特的信息量**

思考：二进制码元只需分高低电平，多进制码元就会把电平进一步细分

#### 信源、信道与信宿

数据通信是指数字计算机或其他数字终端之间的通信

一个数据通信系统主要划分为信源、信道和信宿三部分：

1. 信源：**产生和发送数据的源头**
2. 信宿：**接收数据的终点**，它们通常都是计算机或其他数字终端装置
3. 信道：**信号的<u>逻辑</u>传输媒介**，一个物理通道可以被划分为多个信道

信源发信息给变换器，转换成在信道上传输的信号后，发送给反变换器转换成原始信息，最后发送给信宿

信道用来**表示向某个方向传送信息的介质**，一条通信线路包含**一条发送信道和一条接收信道**

噪声源是信道上的噪声（即**对信号的干扰**）及分散在通信系统其他各处的噪声的集中表示

这是一个单向通信系统的模型：

![image-20211128191119746](..\images\image-20211128191119746.png)

信道按传输信号形式的不同，可分为**传送模拟信号的模拟信道**和**传送数字信号的数字信道**

信道按传输介质的不同，可分为**无线信道和有线信道**

信道上传送的信号有基带信号和宽带信号之分：

1. 基带传输：基带信号**将数字信号** 1 和 0 直接用两种不同的电压表示，然后**送到数字信道上传输**，短距离

   基带信号就是**信源**发出的**要传输的信息的信号**，如计算机输出的数字信号、我们说话的声波

2. 频带传输：使用调制解调器，发送端把**数字信号调制成模拟信号**；接受端把**模拟信号解调为数字信号**，远距离

3. 宽带传输：宽带信号**将基带信号**进行调制后形**成频分复用模拟信号**，然后**送到模拟信道上传输**，一定采用了频带传输技术

   将链路容量分解成两个或者多个信道，每个信道就可以携带不同的信号，链路容量大大增加

从通信双方信息的交互方式看，可分为三种基本方式：

1. 单向通信：只能一方向另一方发送消息，需要**一条信道**，如电视广播
2. 半双工通信：都可以收发消息，但**不能同时收发信息**，此时需要**两条信道**（逻辑上有两个方向）
3. 全双工通信：双方**可同时收发信息**，也需要**两条信道**

信道的极限容量：信道的**最高码元传输速率**或**信道的极限信息传输速率**

#### 速率、波特率与带宽

速率也称数据率，指的是数据传输速率，表示单位时间内传输的数据量：

1. 码元传输速率，波特率等：单位时间内**传输的码元个数**或脉冲个数或**信号变化的次数**，单位是**波特 Baud/秒**
2. 信息传输速率，信息速率、比特率等：单位时间内**传输的二进制码元个数**，单位是**比特/秒**

注意：一个波特含有多个比特，**信息传输速率 = 码元传输速率 × 一码元含有的比特数**

带宽：原指信号具有的频带宽度，单位是赫兹，现指**单位时间内从网络中的某一点到另一点所能通过的最高数据率**，b/s

选择题：信道数据传输速率就是发送速率，也叫传输时延

### 奈奎斯特定理与香农定理

#### 码间串扰

具体的信道所能通过的频率范围总是有限的

信道带宽：信道能通过的**最高频率和最低频率之差**，如下图 3300 - 300 = 3000：

1. 频率太高时：在传输中会衰减，导致接收端收到的信号波形失去码元之间的清晰界限（码间串扰）
2. 频率太低时：频率可能在传输中衰减没了，自然接收方不能收到东西

![image-20211128204419427](..\images\image-20211128204419427.png)

#### 奈奎斯特定理

又称奈氏准则，规定了：

在理想低通（**没有噪声、带宽有限**）的信道中，为了**避免码间串扰**，**极限码元传输速率为 `2W` 波特**，其中 W 是信道的带宽

若用 V 表示每个码元离散电平的数目（码元的进制数），则**极限数据传输速率** = $2W\log_2V$ 单位 b/s

对于奈氏准则，可以得出以下结论：

1. **码元传输速率是有上限的**，超过此上限，就会出现严重的码间串扰问题
2. 信道的频带越宽（即通过的信号高频分量越多），就可用更高的速率进行码元的有效传输
3. 只对码元传输速率的限制，可以通过每个码元**携带更多比特的信息量来提高数据传输速率**

思考：就像 `sinx` 有正和负两个部分，都可以携带数据，所以极限为频率的两倍

#### 香农定理

给出了**有高斯白噪声干扰的信道的极限数据传输速率**，当用此速率进行传输时，可以做到不产生误差

香农定理定义**极限数据传输速率** = $W\log_2(1 +S/N)$ 单位 b/s，W 为**信道的带宽**，S 为信道所**传输信号的平均功率**，N 为信道内部的**高斯噪声功率**，S/N 为信噪比，转换为**单位为分贝 dB 的信噪比** = $10\log_{10}(S/N)$

对于香农定理，可以得出以下结论：

1. 信道的带宽或信道中的**信噪比越大，信息的极限传输速率越高**
2. 确定传输带宽和信噪比，信息传输速率的上限是确定的
3. 只要**信息传输速率低于信道的极限传输速率**，就能找到某种方法来**实现无差错的传输**
4. 香农定理得出的是**极限信息传输速率**，实际信道能达到的传输速率要比它**低不少**

香农定理从另一个侧面表明，一个码元对应的二进制位数是有限的

注意：题目中没有 Hz 的话，不需要往这两个公式想

思考：奈氏是避免码间串扰，香农是防止噪声损坏数据，做题时若有噪声则求两者，**取较小的为极限（最大）传输速率**

---

选择题：将 1 路模拟信号分别编码为数字信号后，与另外 7 路数字信号采用同步 TDM 方式复用到一条通信线路上。1 路模拟信号的频率变化范围为 `0~1kHz`，每个采样点采用 PCM 方式编码为 4 位的二进制数，另外 7 路数字信号的数据率均为 `7.2kb/s`。复用线路需要的最小通信能力是 `64kb/s`。

1 路加 7 路共 8 路使用[时分复用 TDM 方式](#时分多路复用 TDM)复用一条信道，那么其最小的通信能力是各路中最高传输速率乘 8，第一路的速率为 `2 × 1kHz × 4b = 8kb/s` 大于 `7.2kb.s` 故最小通信能力是 `8×8kb/s = 64kb/s`

### 同步通信与异步通信

计算机网络中，同步的意思很广泛，没有统一的定义，如协议的三个要素之一就是同步

网络编程中，同步主要指某函数的执行方式，即需等待**函数执行完后才能进入下一步**；异步可简单地理解为**非同步**

在数据通信中，同步通信与异步通信区别较大：

- 同步通信：通信双方必须先建立同步，即时钟要**调整到同一个频率**，收发双方才能发送和接收连续的同步比特流

  主要有两种同步方式：

  1. 全网同步：用一个非常精确的主时钟对**全网所有结点上的时钟进行同步**
  2. 准同步：各结点的时钟之间**允许有微小的误差**，然后采用其他措施实现同步传输

  同步通信数据率较高，但实现的代价也较高

- 异步通信：发送字符时，所发送的字符之间的**时间间隔可以是任意的**，但接收端必须时刻做好接收的准备

  每个字符**开始和结束的地方加上标志**，即开始位和停止位，以便接收端能够**正确地将每个字符接收下来**

  异步通信也可以用帧作为发送的单位，但**要给帧定界**，使得接收端能够找出一帧的开始

  异步通信的通信设备简单、便宜，但传输效率较低

下图给出了以字符、帧为单位的异步通信示意图：

![image-20211227130537275](..\images\image-20211227130537275.png)

### 编码与调制

数据无论是数字的还是模拟的，为了传输的目的都必须转变成信号

把数据变换为模拟信号的过程称为**调制**，把数据变换为数字信号的过程称为**编码**

**信号是数据的具体表示形式**，它和数据有一定的关系，但又和数据不同

**数字数据**可以通过**数字发送器**转换为**数字信号**传输，也可以通过**调制器**转换成**模拟信号**传输

**模拟数据**可以通过 **PCM 编码器**转换成**数字信号**传输，也可以通过**放大器调制器**转换成**模拟信号**传输

#### 数字数据编码为数字信号

数字数据编码**用于基带传输中**，即在基本不改变数字数据信号频率的情况下，直接传输数字信号

编码即是用什么数字信号表示 0，用什么数字信号表示 1；编码的规则有多种，只要能**有效地把 1 和 0 区分开即可**

![image-20211128191334805](..\images\image-20211128191334805.png)

1. 归零编码 `RZ`：高电平代表 1、低电平代表 0 或者相反，**每个时钟周期的中间均跳变到低电平**

   优点：接收方**根据该跳变调整本方的时钟基准**，这就为传输双方提供了自同步机制

   缺点：**归零需要占用一部分带宽**，因此传输效率受到了一定的影响

2. 非归零编码 `NRZ`：后半段**不用归零**，**一个周期可以全部用来传输数据**

   但 `NRZ` 编码无法传递时钟信号，**双方难以同步**，因此若想传输高速同步数据，则需要都带有时钟线

3. 反向非归零编码 `NRZI`：用信号的**翻转代表 0、信号保持不变代表 1**

   翻转的信号本身可以作为一种通知机制，USB 2.0 通信的编码方式就是这种编码（每 6 个 1 强插 0 实现时钟同步）

4. 曼彻斯特编码 Manchester Encoding：**前高后低为 1，前低后高为 0**，时钟周期的中间进行跳变

   优点：位中间的跳变既作为时钟信号（**可用于同步**），**又作为数据信号**；缺点：**频带宽度是原始基带宽度的两倍**

   注意：**以太网使用的编码方式就是曼彻斯特编码**

5. 差分曼彻斯特编码：**前半电平与上码元的后半电平相同**时为 1；情形相反时为 0

   优点：曼彻斯特编码优点 + **抗干扰性较好**；缺点：仍需要两倍带宽；常用于**局域网传输**

6. `4B/5B` 编码：将欲发送数据流的每 **4 位作为一组**，然后按照编码规则将其**转换成相应的 5 位码**

   5 位有 32 种组合，用 16 传数据，另外 16 种作为控制码（帧的开始和结束、线路的状态信息等）或保留

#### 数字数据调制为模拟信号

数字数据调制技术在发送端将数字信号转换为模拟信号，而在接收端将模拟信号还原为数字信号，分别对应于**调制解调器的调制和解调**过程，基本的数字调制方法有如下几种：

1. 幅移键控 ASK：改变载波信号的**振幅**来表示数字信号 1 和 0；比较容易实现，但**抗干扰能力差**

2. 频移键控 FSK：改变载波信号的**频率**来表示数字信号 1 和 0，容易实现，**抗干扰能力强**，目前应用较为广泛

3. 相移键控 PSK：改变载波信号的**相位**来表示数字信号 1 和 0，它又分为绝对调相和相对调相

4. 正交振幅调制 QAM：在**频率相同**的前提下，**将 ASK 与 PSK 结合起来**，形成叠加信号

   波特率为 B，采用 m 个相位，每个相位有 n 种振幅，**数据传输速率为 = $B\log_2(mn)$ 单位 b/s**

思考：模拟信号其实就是三角函数 $A\sin(Bx+C)$，振幅是控制 A，频率是控制 B，相位是控制 C

`2ASK` 通过有无幅度别表示 1 和 0；`2FSK` 高低频率表示 1 和 0；`2PSK` 用相位 0 和 $\pi$ 表示的 1 和 0，是绝对调相

![image-20211128191533841](..\images\image-20211128191533841.png)

#### 模拟数据编码为数字信号

这种编码方式最典型的例子是常用于对音频信号进行编码的**脉码调制 PCM**

它主要包括三个步骤，即采样、量化和编码：

1. 采样定理：采样频率 $f_{采样}\space$ 必须**大于等于最大频率 f 的两倍**，才能保证采样后的数字信号**完整保留原始模拟信号的信息**

   模拟信号是由多个 `Asin(Bx+C)` 函数叠加，采样频率大于最大频率两倍时，根据所采的数据能推出这些三角函数

2. 采样：对模拟信号进行**周期性扫描**，把**时间上连续的信号变成时间上离散的信号**

3. 量化：把采样取得的电平幅值按照一定的分级标度**转化为对应的数字值并取整数**

4. 编码：把量化的结果**转换为与之对应的二进制编码**

思考：采样拿到参差不齐的电平；量化把这些电平转整数，如 `2.13V→2`；编码把量化结果转二进制，如 2→10

![image-20211129191114108](..\images\image-20211129191114108.png)

注意：数据传输速率 ≤ 采样速率，否则离散信号不能无失真的代表 被抽样的模拟信号

#### 模拟数据调制为模拟信号

为了实现传输的有效性，可能需要较高的频率。这种调制方式还可以使用频分复用 `FDM` 技术，充分利用带宽资源

电话机和本地局交换机采用模拟信号传输模拟数据的编码方式，模拟的声音数据是加载到模拟的载波信号中传输的

思考：模拟数据的频率不能进入信道，就需要把它的频率调到信道所需的频率（模拟信号），再放入信道

### 电路交换、报文交换与分组交换

#### 电路交换

进行数据传输前，两个结点之间必须**先建立一条专用的物理通信路径**，该路径可能**经过许多中间结点**

这一路径在整个数据**传输期间一直被独**占，直到**通信结束后才被释放**

电路交换技术分为三个阶段：**连接建立、数据传输、连接释放**

电路交换技术的优点如下：

1. 通信时延小：通信**线路为通信双方用户专用，数据直达**，因此传输数据的时延非常小
2. 有序传输：双方通信时**按发送顺序传送数据**，不会失序
3. 没有冲突：不同的通信双方**拥有不同的信道**，不会出现争用物理信道的问题
4. 适用范围广：电路交换**既适用于传输模拟信号，又适用于传输数字信号**
5. 实时性强：物理通路一旦建立，双方就**可以随时通信**
6. 控制简单：电路交换的交换设备及控制均较简单

电路交换技术的缺点如下：

1. 建立连接时间长：电路交换的平均连接建立时间**对计算机通信**来说太长
2. 线路独占，使用效率低：电路交换连接建立后，**通信线路空闲时，也不能供其他用户使用**，因而信道利用率低
3. 灵活性差：通路中的任何一点**出了故障，就必须重新拨号建立新的连接**，这对十分紧急和重要的通信是很不利的
4. 难以规格化：不同类型、不同规格、不同速率的终端很**难相互进行通信**，也**难以在通信过程中进行差错控制**

注意：电路建立后，除源结点和目的结点外，**不存在存储转发所耗费的时间**（中间结点直接转发）

#### 报文交换

数据交换的单位是报文，**报文携带有目标地址、源地址等信息**，报文交换在交换结点采用的是**存储转发**的传输方式

报文交换技术的优点如下：

1. 无须建立连接：**用户可以随时发送报文**，不存在建立连接时延
2. 动态分配线路：交换设备接收报文时，存储整个报文后，**选择一条合适的空闲线路**，将报文发送出去
3. 提高线路可靠性：某条传输路径发生故障，就**选择另一条路径**传输数据
4. 提高线路利用率：通信双方在不同的时间一段一段地**部分占有**这条物理通道
5. 提供多目标服务：一个报文可以**同时发送给多个目的地址**，这在电路交换中是很难实现的

报文交换技术的缺点如下：

1. 由于数据进入交换结点后要经历存储、转发这一过程，因此**会引起转发时延**
2. 报文交换对报文的大小没有限制，这就要求**网络结点需要有较大的缓存空间**

注意：报文交换主要使用在早期的电报通信网中，现在通常**被的分组交换方式所取代**

#### 分组交换

分组交换**限制了每次传送的数据块大小的上限**，把大数据块划分为小数据块，加上控制信息，构成分组 Packet

网络结点接收分组时，暂时保存并排队等待传输，然后**根据控制信息选择下一个结点**，反复直到目的地

分组交换的优点如下：

1. 无建立时延：**用户可随时发送分组**，不存在连接建立时延

2. 线路利用率高：通信双方在不同的时间一段一段地**部分占有**这条物理通路

3. 简化了存储管理：分组的长度固定，相应的**缓冲区的大小也固定**，在交换结点中对缓冲区的管理，相对比较容易

4. 加速传输：**后一个分组的存储操作与前一个分组的转发操作并行**，减少了报文的传输时间

   传输一个分组所需的缓冲区更小，这样因缓冲区不足而等待发送的概率及时间也必然少得多

5. 减少了出错概率和重发数据量：因为分组较短，其出错概率必然减小，且重发的数据量也大大减少

分组交换的缺点如下：

1. 存在传输时延：分组交换**仍存在存储转发时延**，而且其结点交换机必须具有更强的处理能力

2. 需要传输额外的信息量：**每个小数据块都要加上源地址、目的地址、分组编号等信息**，从而构成分组

3. 采用数据报服务：会出现失序、丢失或重复分组，到达终点时，要对分组按编号进行排序等工作，很麻烦

   采用虚电路服务：需要呼叫建立、数据传输和虚电路释放三个过程

#### 三者比较

这是三种数据交换方式的比较：

- 要传送的数据量很大且其**传送时间远大于呼叫时间时**，采用**电路交换**较为合适
- 端到端的通路由多段链路组成时，采用分组交换传送数据较为合适
- 报文交换和分组交换的信道利用率优于电路交换
- <u>分组交换适合于计算机之间的突发式数据通信</u>，它比报文交换的时延小

![image-20211128191935921](..\images\image-20211128191935921.png)

### 数据报与虚电路

**分组交换**进一步分为**面向连接的虚电路**方式和**无连接的数据报**方式，这两种服务方式都**由网络层提供**

思考：TCP/IP 网际层是无连接的，所以虚电路不是 TCP/IP 网际层的协议，实际上 TCP/IP 使用的是数据报服务

#### 数据报

端系统：发送一个报文时，先**把报文拆成若干带有序号的数据单元**，**加上地址等控制信息**后形成数据报分组

中间结点：存储分组，**找最佳的路由**，转发每个分组，不同的分组可以**走不同的路径**，也可以**按不同的顺序到达目的结点**

用下图来说明数据报服务的原理，假定主机 A 要向主机 B 发送分组：

1. 主机 A 先将分组逐个发往与它直接相连的交换结点 A，交换结点 A 缓存收到的分组

2. 然后查找自己的转发表（**不同时刻的网络状态不同，转发表的内容可能不完全相同**）

   有的分组转发给交换结点 C，有的分组转发给交换结点 D

3. 网络中的其他结点收到分组后，类似地转发分组，直到分组最终到达主机 B

![image-20211128192037384](..\images\image-20211128192037384.png)

<u>当分组正在某一链路上传送时，分组并不占用网络的其他部分资源</u>

数据报服务具有如下特点：

1. 发送分组前**不需要建立接**，发送方可随时发送分组，网络中的结点可随时接收分组

2. 传输**不保证可靠性**，可能会丢失；每个分组**独立地选择路由**，转发的路径可能不同，到达序号可能不同

3. 分组**包括发送端和接收端的完整地址**，以便可以独立传输

4. 分组在交换结点存储转发时，需要排队等候处理，这会**带来一定的时延**

   通信量较大或拥塞时，这种时延会大大增加，交换结点还可根据情况丢弃部分分组

5. 网络具有冗余路径，一个交换结点或链路故障时，更新转发表，选择另一条路径，**对故障的适应能力强**

6. 存储转发的延时一般较小，**提高了网络的吞吐量**

7. 收发双方**不独占某条链路**，资源利用率较高

#### 虚电路

虚电路方式 = 数据报方式 + 电路交换方式，试图发挥两者的优点，其通信过程分为：**虚电路建立、数据传输、虚电路释放**

在虚电路的建立过程中确定的信息：

- 在分组发送之前，建立一条逻辑上相连的虚电路，并且<u>连接一旦建立，就固定了虚电路所对应的物理路径</u>
- 端系统每次建立虚电路时，选择一个未用过的虚电路号分配给该虚电路，以区别于本系统中的其他虚电路
- 在虚电路网络中的<u>每个结点上都维持一张虚电路表</u>，表中的每项记录了一个打开的虚电路的信息
- 虚电路表项包括在接收链路和发送链路上的虚电路号、前一结点和下一结点的标识

在传送数据时，**每个数据分组要有它要通过的虚电路号**，以识别发送分组使用的虚电路

虚电路方式的工作原理如下图：

1. 为进行数据传输，主机 A 与主机 B 之间先建立一条逻辑通路

   主机 A 发出一个特殊的呼叫请求分组送往主机 B，若主机 B 同意连接，则发送呼叫应答分组

2. 虚电路建立后，主机 A 就可向主机 B 发送数据分组，主机 B 也可在该虚电路上向主机 A 发送数据

3. 传送结束后主机 A 通过发送释放请求分组来拆除虚电路，逐段断开整个连接

<img src="..\images\image-20211128192156648.png" alt="image-20211128192156648" style="zoom:125%;" />

虚电路服务具有如下特点：

1. **连接建立和拆除需要时间开销**，对交互式应用和小量的短分组情况显得很浪费，但对长时间、频繁的数据交换 效率较高
2. **虚电路的路由选择体现在连接建立阶段**，连接建立后，就确定了传输路径
3. 虚电路提供了**可靠的通信功能**，能**保证每个分组正确且有序到达**，还可以**进行流量控制**
4. 当网络中的**某个结点或某条链路出现故障而彻底失效时，所有经过该结点或该链路的虚电路将遭到破坏**（致命弱点）
5. **分组首部不包含目的地址，包含的是虚电路标识符**，相对于数据报方式，其开销小

**虚电路不是专用的**，一条链路可以被多个虚电路使用，甚至可以多条虚电路所使用的链路是一样的

注意：这里的传输确认（`ACK`）是由高层实现的，这在数据报和虚电路都是没有的

#### 两者比较

![image-20211128192304259](..\images\image-20211128192304259.png)

## 传输介质

也称**传输媒体**，它是数据传输系统中发送设备和接收设备之间的**物理通路**

传输介质可分为导向传输介质和非导向传输介质：

- 导向传输介质：电磁波**沿着固体媒介**（铜线或光纤）传播
- 非导向传输介质：**沿着空气、真空或海水**等传播

注意：传输介质不是物理层的内容，可以看作是第 0 层，只是发送信号，不管信号代表什么

### 双绞线、同轴电缆、光纤

#### 双绞线

双绞线是**最常用的古老传输介质**，由两根采用一定规则并排绞合的、相互绝缘的铜导线组成，以减少**对相邻导线的电磁干扰**

屏蔽双绞线 `STP` 在双绞线的外面**加一层屏蔽层**，以**提高抗电磁干扰能力**；无屏蔽层的双绞线称为非屏蔽双绞线 `UTP`

![image-20211130192627840](..\images\image-20211130192627840.png)

双绞线的价格便宜，是最常用的传输介质之一，在**局域网**和**传统电话网**中普遍使用

双绞线的**带宽取决于铜线的粗细和传输的距离**

模拟传输和数字传输都可使用双绞线，其通信距离一般为几千米到数十千米

距离太远时，对于模拟传输，要用**放大器**放大衰减的信号；对于数字传输，要用**中继器**将失真的信号整形

#### 同轴电缆

同轴电缆由**内导体、绝缘层、网状编织屏蔽层和塑料外层**构成

![image-20211130192655588](..\images\image-20211130192655588.png)

按特性阻抗数值的不同，通常将同轴电缆分为 50Ω 同轴电缆和 75Ω 同轴电缆：

- 50Ω 同轴电缆：传送**基带信号**，又称**基带同轴电缆**，它在**局域网**中应用广泛
- 75Ω 同轴电缆：传送**宽带信号**，又称**宽带同轴电缆**，主要用于**有线电视系统**

同轴电缆**抗干扰特性比双绞线好**，被广泛用于**传输较高速率的数据**，其传输距离更远，但价格较双绞线贵

选择题：利用一根同轴电缆互联主机构成以太网，主机的通信方式为半双工

#### 光纤

**利用光导纤维（光纤）传递光脉冲来进行通信**，有光脉冲表示 1，无光脉冲表示 0

可见光的频率约为 `10MHz`，因此**光纤通信系统的带宽范围极大**

光纤主要由**纤芯（实心）和包层**构成，纤芯直径只有 8 至 $100\mu m$，光波通过纤芯传导，包层较纤芯有较低的折射率

当光线从<u>高折射率的介质射向低折射率的介质</u>时，其折射角将大于入射角

因此，入射角大于某个临界角度，就会出现全反射，这个过程不断重复，光也就沿着光纤传输下去

![image-20211130191630285](..\images\image-20211130191630285.png)

利用光的全反射特性，可以将从不同角度**入射的多条光线**在一根光纤中传输，这种光纤称为**多模光纤**

多模光纤的光源为**发光二极管**，光脉冲在多模光纤中传输时会**逐渐展宽，造成失真**，因此多模光纤只适合于**近距离传输**

![image-20211130191719488](..\images\image-20211130191719488.png)

光纤的**直径为一个光的波长**时，可使光线一直向前传播，而不会产生多次反射，这样的光纤就是**单模光纤**

单模光纤的纤芯很细，直径**只有几微米**，制造成本较高，光源为定向性很好的**半导体激光器**

单模光纤的**衰减较小**，可传输数公里甚至数十千米而不必采用中继器，**适合远距离传输**

![image-20211130191754639](..\images\image-20211130191754639.png)

光纤不仅具有通信容量非常大的优点，还具有如下特点：

1. 传输损耗小，中继距离长，**对远距离传输特别经济**
2. **抗雷电和电磁干扰性能好**，在有大电流脉冲干扰的环境下尤为重要
3. **无串音干扰，保密性好**，也不易被窃听或截取数据
4. **体积小，重量轻**，在现有电缆管道已拥塞不堪的情况下特别有利

### 无线传输介质

#### 无线电波

无线电波具有**较强的穿透能力**，可以**传输很长的距离**，所以它被广泛应用于通信领域，如无线手机通信、`WLAN` 等

无线电波使信号**向所有方向散播**，因此**有效距离范围内的接收设备可与无线电波发射者进行通信连接**（最重要的优点之一）

#### 微波、红外线、激光

目前**高带宽的无线通信**主要使用微波、红外线和激光

它们都需要发送方和接收方之间**存在一条视线通路**，有很强的方向性，都**沿直线传播**，有时统称这三者为视线介质

红外通信和激光通信把要传输的信号分别**转换为各自的信号格式**，即**红外光信号和激光信号**，再直接在空间中传播

微波通信的**频率较高，频段范围也很宽**，载波频率通常为 `2～40GHz`，因而通信信道的容量大

地球是圆的，而微波沿直线传播，因此**在地面的传播距离有限**，要用中继站来接力

利**用卫星作为中继来转发微波信号**，克服地面微波通信距离的限制，三颗相隔 120° 的同步卫星基本能实现全球通信

- 优点：**通信容量大、距离远、覆盖广、广播通信和多址通信**
- 缺点：**传播时延长（`250~270ms`）、受气候影响大、误码率较高、成本高**

### 物理层接口的特性

物理层考虑的是如何在连接到各种计算机的传输媒体上**传输数据比特**流，而**不指具体的传输媒体**

物理层的主要任务可以描述为确定与传输媒体的**接口有关的一些特性**：

1. 机械特性：指明接口所用接线器的形状和尺寸、**引脚数目和排列**、固定和锁定装置等
2. 电气特性：指明在接口电缆的各条线上出现的**电压的范围**
3. 功能特性：指明某条线上出现的某一**电平的电压表示何种意义**，但<u>不涉及具体的电平值</u>
4. 过程特性，规程特性：指明对于不同功能的**各种可能事件的出现顺序**

常用的物理层接口标准有 `EIARS-232-C、ADSL、SONET/SDH` 等

## 物理层设备

### 中继器

通过**信号再生**实现将信号**整形并放大**，以消除失真和衰减，中继器有两个端口，数据从一个端口输入，再从另一个端口发出

端口**仅作用于信号的电气部分**，而不管是否有错误数据或不适于网段的数据

中继器是用来扩大网络规模的最简单廉价的互联设备，其两端的网络部分是**网段**，连接的几个网段**仍然是一个局域网**

中继器若出现故障，对相邻两个网段的工作都将产生影响；中继器**不能连接两个具有不同速率的局域网**

注意：具**有转发存储转发功能的设备才能连接两个不同协议**；中继器没有，它两端的网段只能**使用同一个协议**

<img src="..\images\image-20211130211511659.png" alt="image-20211130211511659" style="zoom:150%;" />

理论中，可以使用无限个中继器；但实际上，网络标准中<u>对信号的延迟范围做了具体的规定</u>，中继器只能在此规定范围内进行有效的工作，否则会引起网络故障

在采用粗同轴电缆的 `10BASE5` 以太网规范中，互相**串联的中继器的个数不能超过 4 个**，而且用 4 个中继器串联的 5 段通信介质中**只有 3 段可以挂接计算机**，这就是所谓的 5-4-3 规则

注意：放大器放大**模拟信号**，原理是将衰减的信号放大；转发器也是物理层设备，可以放大信号

### 集线器

集线器 Hub 实质上是一个**多端口的中继器**

Hub 工作时，一个端口接收到数据信号后，使之**再生**（恢复）到发送时的状态，转发到**除输入端口外，处于工作状态的端口**

<u>同时有两个或多个端口输入，输出时会发生冲突，致使这些数据都无效</u>，会另取一个时间在发

Hub 在网络中只起**信号放大和转发**作用，以扩大网络的传输范围，而**不具备信号的定向传送**能力，是标准的**共享式设备**

使用 Hub 组网灵活，它<u>把所有结点的通信集中在以其为中心的结点上</u>，对结点相连的工作站进行集中管理

![image-20211130211559754](..\images\image-20211130211559754.png)

Hub 的每个端口连接的网络部分是**同一个网络的不同网段**，Hub 只能**在半双工状态下工作**，网络的吞吐率因而受到限制

注意：集线器的**所有端口都属于同一个冲突域**，集线器在**一个时钟周期中只能传输一组信息**

- 多台机器经常需要同时通信时，将导致信息碰撞，使得集线器的工作效率很差
- <u>带宽为 `10Mb/s` 的集线器上连接了 8 台计算机，当这 8 台计算机同时工作时，每台计算机的带宽为 `10/8Mb/s = 1.25Mb/s`</u>

选择题：两个网段在 A 层（物理层或数据链路层）<u>互联</u>（不是互连），A 层及以下层协议相同，A 层以上协议可以不同

# 数据链路层

## 数据链路层的功能

数据链路层在物理层提供服务的基础上向网络层提供服务，将物理层提供的可能出错的物理连接改造为**逻辑上无差错的数据链路**，使之**对网络层表现为一条无差错的链路**

### 数据链路层的基本概念

结点：主机、路由器

链路：网络中两个结点之间的**物理通道**，分为有线链路、无线链路

数据链路：网络中两个结点之间的**逻辑通道**，把实现控制数据传输协议的硬件和软件加到链路上就构成数据链路

帧：链路层的协议数据单元，封装网络层数据报

电路接通：物理连接已经能够传送比特流

数据链路接通：在物理连接的基础上，建立数据链路连接，使具有数据链路层的功能

### 为网络层提供服务

数据链路层通常可为网络层提供如下服务：

1. 无确认的无连接服务：发送数据帧时**不需先建立链路连接**，收到数据帧时**不需发回确认**

   对丢失的帧，交给上层处理，适用于**实时通信**或**误码率较低的通信信道**，如以太网

2. 有确认的无连接服务：发送数据帧时**不需先建立链路连接**，但收到数据帧时**必须发回确认**

   源机器在所规定的时间内未收到确定信号时，就**重传丢失的帧**，适用于**误码率较高**的通信信道，如无线通信

3. 有确认的面向连接服务：帧传输过程分为：**建立数据链路、传输帧、释放数据链路**

   收到**每一帧都要确认**，**收到确认后才能发送下一帧**，可靠性最高，适用于通信要求（**可靠性、实时性**）较高的场合

注意：有连接就一定要有确认，即**不存在无确认的面向连接的服务**

### 链路管理

**数据链路层连接的建立、维持和释放过程称为链路管理**，它主要用于面向连接的服务

链路两端的结点要进行通信：

1. 首先确认对方已处于就绪状态
2. 交换一些必要的信息以对帧序号初始化
3. 建立连接，在传输过程中要能维持连接，在传输完毕后要释放连接

在多个站点共享同一物理信道的情况下，如何在要求**通信的站点间分配和管理信道**也属于数据链路层管理的范畴

### 帧定界、帧同步与透明传输

两台主机之间传输信息时，**必须将网络层的分组封装成帧**，以帧的格式进行传送

将一段数据的**前后**分别添加首部和尾部，就构成了帧

帧定界：首部和尾部中含有很多控制信息，它们的一个重要作用是**确定帧的界限**

帧同步：**接收方**应能从接收到的二进制比特流中**区分出帧的起始与终止**

在 HDLC 协议中，用**标识位 F 来标识帧的开始和结束**，通信过程中，第一次看见 F 表示开始，第二次表示结束

为了提高帧的传输效率，应使帧的数据部分尽量的大，但在协议中**规定了帧的数据部分的长度上限**（最大传送单元 `MTU`）

![image-20211201191430258](..\images\image-20211201191430258.png)

透明传输：采取有效措施**防止发送信息中出现标志，导致被误以为结束**，即无论数据是什么都可以正常传输

### 流量控制

为防止收发双方的工作速率和缓存空间的差异，导致发送速度大于接受速度，而造成的丢包现象

因此，要**限制发送方的数据流量，使其发送速率不超过接收方的接收能力**

需要有一些规则使发送方知道在**什么时候可以发送下一帧，什么时候必须暂停发送**直到收到某种反馈信息后继续发送

流量控制并不是数据链路层特有的功能，许多高层协议中也提供此功能，只不过控制的对象不同而已

对于数据链路层，控制的是相邻两结点之间数据链路上的流量，即**对帧率进行控制**

![image-20211201191640512](..\images\image-20211201191640512.png)

### 差错控制

差错控制：让发送方确定接收方是否正确收到其发送的数据

帧在传输中可能会出现的错误分为位错和帧错；

1. 位错：**帧中某些位出现差错**

   通常**采用循环冗余校验方式发现位错**，通过自动重传请求 `ARQ` 方式来**重传出错的帧**：

   1. 让发送方将要发送的数据帧附加一定的 CRC 冗余检错码一并发送
   2. 接收方根据检错码对数据帧进行错误检测，若发现错误则丢弃，发送方超时重传该数据帧

   这种差错控制方法称为 `ARQ` 法，**只需返回很少的控制信息**来进行确认

2. 帧错：帧的丢失、重复或失序等错误

   在数据链路层引入**定时器和编号**机制：定时器过时时没确认就重传，**保证能到**；编号，**保证只到一次及有序**

## 组帧

数据链路层把比特组合成帧为单位传输，是为了在**出错时只重发出错的帧**，而不必重发全部数据，从而提高效率

组帧：发送方按规则把网络层的分组封装成帧，以便能正确地接收并检查帧，解决帧定界、帧同步、透明传输等问题

注意：组帧时要加首部，尾部；因为在网络中信息是**以帧为最小单位进行传输的**，所以要清楚帧从哪里开始到哪里结束

- 而网络层的报文不会出现位错（帧解决了），就不会出现字符计数法的致命问题
- TCP/IP 中每个帧里面都有一个分组，给帧定界了，就相当于给分组定界了

由于字节计数法脆弱、字符填充法实现上的复杂性与不兼容性，目前**常用的是比特填充法和违规编码法**

### 字符计数法

字符计数法是指在帧头部使**用一个计数字段来标明帧内字符数**（该计数字段包含自己）

目的结点的数据链路层收到字节计数值时，就知道后面跟随的字节数，从而可以确定帧结束的位置

![image-20211201205441510](..\images\image-20211201205441510.png)

**计数字段出错时（位错），会失去了帧边界划分的依据**，导致收发双方将失去同步，从而造成灾难性后果

### 字符填充的首尾定界符法

字符填充法**使用特定字符来定界一帧的开始与结束**

控制字符 SOH 放在帧的最前面，表示帧的首部开始，控制字符 EOT 表示帧的结束

使用**在特殊字符前填充转义字符 ESC** 来避免信息位中的特殊字符（包括 ESC）被误判，实现数据的透明传输

接收方收到转义字符后，就知道其后面紧跟的是数据信息，而不是控制信息

![image-20211201205618710](..\images\image-20211201205618710.png)

### 零比特填充的首尾标志法

零比特填充法**允许数据帧包含任意个数的比特**，也允许**每个字符的编码包含任意个数的比特**

它使用一个特定的比特模式，即 **01111110 来标志一帧的开始和结束**

为了防止信息位中的 01111110 被误判为帧的首尾标志，只要**遇到 5 个连续的 1 时，在其后插入一个 0**

而**接收方做该过程的逆操作**，即每收到 5 个连续的 1 时，自动删除后面紧跟的 0，恢复原信息

![image-20211201205701636](..\images\image-20211201205701636.png)

零比特填充法很容易**由硬件来实现**，性能优于字符填充法

### 违规编码法

违规编码法**采用违规的编码来表示帧的首和尾**

如曼彻斯特编码的违规编码为：高-高电平对和低-低电平对

借用这些**违规编码序列来定界帧的起始和终止**，局域网 IEEE 802 标准就采用了这种方法

违规编码法**不需要采用任何填充技术**，便能实现数据传输的透明性，但它**只适用于采用冗余编码的特殊编码环境**

## 差错控制

**数据的传输差错由噪声引起的**，通信信道的噪声分为两类：

- 热噪声：**通道固有的噪声**，引起的差错是**随机差错**，通过提高信噪比来降低
- 冲击噪声：由**外界电磁干扰引起的噪声**，引起的差错是**突发差错**，是引起差错的主要原因

通常利用编码技术进行比特差错控制，主要有两类：

- `ARQ` 方式：检测出差错时，**通知发送端重发**，使用检错编码实现
- `FEC` 方式：检测出差错时，**进行纠正**，使用纠错编码实现

注意：具体的算法和思路在机组里面有，这里仅作补充说明

### 检错编码

发送前**在有效数据添加冗余位**，接收端根据一定的规则来判断是否出错，常见的检错编码有**奇偶校验码和循环冗余码**

通过循环冗余码 CRC 的检错技术，实现<u>接收端数据链路层接收的帧（收下）都是在传输过程中没有产生差错的帧</u>

注意：**CRC 是具有纠错功能的**，只是数据链路层仅使用了它的检错功能，检测到帧出错则直接丢弃

CRC 可以使用硬件来完成，所以其校验速度很快

### 纠错编码

通过在每个要发送的数据块上附加足够的冗余信息，使接收方能够推导出发送方实际送出的应该是什么样的比特串

最常见的纠错编码是海明码，正常的海明码可以**纠正一位错误，检测两位错误**

- 机组的理论：L - 1 = D + C 且 $D\geq C$ 即编码最小码距 L 越大，其检测错误的位数 D 越大，纠正错误的位数 C 也越大
- 理论推出：根据 $D\geq C$，令 D = C 得 **`L = 2C + 1` 时最大纠错位数为 C**；令 C = 0 得**最大检错 D = L - 1**

## 流量控制与可靠传输机制

### 流量控制、可靠传输

流量控制：**对链路上的帧的发送速率的控制**，以使接收方有足够的缓冲空间来接收每个帧

在面向帧的自动重传请求系统中，当待确认帧的数量增加时，有可能超出缓冲存储空间而造成过载

流量控制的基本方法是**由接收方控制发送方发送数据的速率**，常见的方式有两种停止-等待协议和滑动窗口协议

#### 停止-等待流量控制基本原理

发送方**每发送一帧**，都要**等待接收方的应答信号**，之后才能发送下一帧

接收方**每接收一帧**，都要**反馈一个应答信号**，表示可接收下一帧

如果接收方不反馈应答信号，那么发送方必须一直等待

每次只允许发送一帧，然后就陷入等待接收方确认信息的过程中，因而**传输效率很低**

#### 滑动窗口流量控制基本原理

发送窗口：发送方维持的一组连续的允许发送的帧的序号；接收窗口：接收方维持的一组连续的允许接收帧的序号

发送窗口的大小 $W_T$：在还**未收到对方确认信息的情况下**发送方**最多还可以发送多少个数据帧**

发送端每收到一个确认帧，发送窗口就向前滑动一个帧的位置，当发送窗口内没有可以发送的帧时，发送方就会停止发送，直到收到接收方发送的确认帧使窗口移动，窗口内有可以发送的帧后，才开始继续发送

![image-20211203140351354](..\images\image-20211203140351354.png)

接收端设置接收窗口是为了**控制可以接收哪些数据帧和不可以接收哪些帧**

接收端收到数据帧后，将窗口向前移一个位置，并发回确认帧，若收到的数据帧**落在接收窗口之外，则一律丢弃**

![image-20211203140433833](..\images\image-20211203140433833.png)

滑动窗口有以下重要特性：

1. 接收窗口向前滑动（发送了确认帧）时，**发送窗口才有可能（收到确认帧后才）向前滑动**
2. 从滑动窗口的概念看，三个协议只在**发送窗口大小与接收窗口大小上有所差别**：
   - 停止-等待协议：发送窗口大小 = 1，接收窗口大小 = 1
   - 后退 N 帧协议：发送窗口大小 > 1，接收窗口大小 = 1
   - 选择重传协议：发送窗口大小 > 1，接收窗口大小 > 1
3. **接收窗口的大小为 1 时，可保证帧的有序接收**
4. 数据链路层的滑动窗口协议中，**窗口的大小在传输过程中是固定的**

#### 可靠传输机制

数据链路层的可靠传输使用**确认和超时重传**两种机制来完成：

1. 确认：一种**无数据的控制帧**，这种控制帧使得接收方可以**让发送方知道哪些内容被正确接收**

   有些情况下为了提高传输效率，将确认捎带在一个回复帧中，称为捎带确认

2. 超时重传：发送方在**发送数据帧后就开启一个计时器**，超时没确认，就重新发送该数据帧，直到收到确认

自动重传请求 ARQ：接收方请求发送方**重传出错的数据帧来恢复出错的帧**，用于处理信道所带来的差错

传统自动重传请求分为三种：

- 停止-等待（Stop-and-Wait）ARQ
- 后退 N 帧（Go-Back-N）ARQ
- 选择性重传（Selective Repeat）ARQ

后两种是滑动窗口 + 请求重发，**当窗口尺寸足够大时，帧在线路上可以连续地流动**，又称其为**连续 ARQ 协议**

注意：在**数据链路层中**流量控制机制和可靠传输机制**是交织在一起**的

注意：实际中链路层很少出差错了，故很少采用可靠传输（不同于 OSI 的思路），大多数教材放在提供可靠传输的传输层中讨论，这里根据 408 考纲，就放在数据链路层

### 单帧滑动窗口与停止-等待协议

源站**发送单个帧后等待确认**，在目的站的回答到达源站之前，源站不能发送其他的数据帧

在停止-等待协议中，除数据帧丢失外，还可能出现以下两种差错：

1. 数据帧被破坏：检出后将该帧丢弃，源站装备了计时器，在一个帧发送之后

   如果在**计时器计满时仍未收到确认，那么再次发送相同的帧**，如此重复，直到帧无误到达

2. 确认帧被破坏：发送方收不到确认帧，会重传数据帧

   接收方**收到同样的数据帧时会丢弃该帧**，并**重传一个该帧对应的确认帧**，总窗口为 2 故用 `1bit` 编号

为了**超时重发和判定重复帧**的需要，发送方和接收方都须**设置一个帧缓冲区**

发送端在**发送完数据帧时，在缓存中保留此数据帧的副本**，出差错时重传，收到确认帧时清除副本

注意：**理想情况下确认帧可以不用编号**，但若超时的时候确认帧在半路，重发后会出问题

![image-20211203140615933](..\images\image-20211203140615933.png)

### 多帧滑动窗口与后退 N 帧协议 `GBN`

在后退 N 帧式 ARQ 中，发送方可以连续发送帧，出错时重发**最近确认帧之后的所有未被确认的帧**

如发送方发现某帧在**计时器超时后仍未返回其确认信息**，则该帧被判为出错或丢失，就重传该**出错帧及随后的 N 个帧**

为了减少开销，`GBN` 协议还规定接收端可以在**连续收到好几个正确的数据帧后，对最后一个数据帧发确认信息**，或者可在自己**有数据要发送时将对以前正确收到的帧加以捎带确认**

**`ACKn` 表示对第 n 号帧的确认**，表示接收方已**正确收到第 n 号帧及以前的所有帧**，下一次期望收到第 n + 1 号帧或 0 号帧

**接收端只按序接收数据帧**，差错帧后面的帧即使都正确接收了，也要将这些帧丢弃

为了防止已发送的最后确认帧丢失，应**重复发送**已发送的**最后一个确认帧**

后退 N 帧协议的接收窗口为 1，可以保证**按序接收数据帧**；n 比特的帧编号时，发送窗口的尺寸 W 应满足 $1≤W_T≤2^n-1$

- 当 W = 8, n = 3 时，发送端发送八个包，接受端都接受了并发送确认，但确认帧在路上都丢失了
- 这时发送方超时重发，接受放就会当作新的帧来处理，而不是当作重复帧

优点：连续发送数据帧而提高了信道的利用率；缺点：重传时又必须把原来已传送正确的数据帧进行重传

若信道的传输质量很差导致误码率较大时，**后退 N 帧协议不一定优于停止-等待协议**

![image-20211203140838243](..\images\image-20211203140838243.png)

### 多帧滑动窗口与选择重传协议 SR

通过加大接受窗口，来收下发送序号不连续但仍处在接收窗口中的那些数据帧，这时就可以**只重传需要重传的数据帧**

但**上交给网络层的时候还是有序的**上交的，因此收到头部的帧才滑动窗口，这就是选择重传 ARQ 协议

SR 中，**每个发送缓冲区对应一个计时器**，超时就重传，此外，接收方**怀疑帧出错时，就发送否定帧** `NAK` 来指定要重传的帧

若采用 n 比特对帧编号，为了保证接收方向前移动窗口后，新窗口序号与旧窗口序号没有重叠部分，需要满足条件：

1. **接收窗口 $W_R$ + 发送窗口 $W_T≤2^n$**，道理和 `GBN` 那里相同
2. 接收窗口 $W_R$ 显然不应超过发送窗口 $W_T$，可得 $W_R≤2^{n-1}$
2. 注意：窗口大小 = 接受窗口大小 + 发送窗口大小

在 SR 协议中，一般**接收窗口的大小和发送窗口的大小是相同的**，即 $W_R=W_T=2^{n-1}$

![image-20211203141015402](..\images\image-20211203141015402.png)

选择重传协议需要在接收端要设置具有相当容量的缓冲区来**暂存那些未按序正确收到的帧**

接收端**不能接收窗口范围以外的序号的帧**，因此所需**缓冲区的数目等于窗口的大小**，而不是序号数目

### 通道利用率

信道的效率，也称信道利用率：**发送方在一个发送周期的时间内，有效地发送数据所需要的时间占整个发送周期的比率**

简单来说就是，**通道利用率 = 发送时间 / 发送周期**，而**发送周期 = (发送时间 + 各种延迟)**

- 发送时间：发送方把发送窗口发完所需要的时间（发送时间不会超过发送周期），为发送窗口数 × 发送一帧的时间
- 发送周期：从发送第一帧的开始，到第一帧的确认回来的时间，根据题目要求来算（仔细读题）

**信道吞吐率 = 信道利用率 × 发送方的发送速率**

选择题：多窗口通道利用率最高：**发送窗口 = 发送周期 / 发送时间**；发送窗口发满时，第一帧的确认帧到达，可以继续发

选择题：多窗口通道大于利用率：**发送时间 × 帧数 / 发送周期 ≥ 利用率**，上面利用率最高是 1，限制窗口大小以减少利用率

---

两台主机之间的数据链路层采用后退 N 帧协议传输数据，数据传输速率为 `16kb/s`，单向传播时延为 `270ms`，数据帧长度范围是 `128~512` 字节，接收方总是以与数据帧等长的帧进行确认。为使信道利用率达到最高，帧序号的比特数至少为 4。

- 为使帧长大小为何时，通道利用率都最高，所以按 128 字节来算，发送时间为 `128B × 8 / 16kb = 64ms`，而发送周期为 `64ms × 2 + 270ms × 2 = 668ms` ，所以发送窗口 = `668ms / 64ms = 10.4 = 11`，这帧编号为 12 需要 4 比特

主机甲通过 `128kb/s` 卫星链路，采用滑动窗口协议向主机乙发送数据，链路单向传播时延为 `250ms`，帧长为 1000 字节。不考虑确认帧的开销，为使链路利用率不小于 80%，帧序号的比特数至少是 4。

- 一个帧的发送时间为 `1000B × 8 / 128kb/s = 62.5ms` 由题得方程 `(L × 62.5ms) / (62.5ms + 250ms × 2) ≥ 0.8` 解得 L ≥ 7.2 故 L 取 8，窗口大小为 9，至少需要 4 个比特

## 介质访问控制

主要任务：为使用介质的每个结点**隔离来自同一信道上其他结点所传送的信号**，以协调活动结点的传输

介质访问控制 Medium Access Control，MAC 子层，属于数据链路层的一个子层：决定**广播信道中信道分配**的协议

结点 A、B、C、D、E 共享广播信道，当 A 和 B 都要与 C 发生通信时，由于共用一条信道，通信会因为互相干扰而失败

介质访问控制的内容是，采取一定的措施，**使得两对结点之间的通信不会发生互相干扰的情况**

![image-20211204184437955](..\images\image-20211204184437955.png)

介质访问控制方法：信道划分介质访问控制（静态）、随机访问介质访问控制（动态）、轮询访问介质访问控制（动态）

### 信道划分介质访问控制

将使用介质的每个设备与来自同一通信信道上的其他设备的通信**隔离开来**，把时域和频域资源合理地分配给网络上的设备

多路复用：**传输介质的带宽超过传输单个信号所需的带宽**时，在一条介质上**同时携带多个传输信号**来提高传输系统的利用率

多路复用技术可**把多个输入通道的信息整合到一个复用通道中**，在接收端把收到的信息**分离出来**并传送到对应的输出通道

信道划分的实质就是把广播信道**逻辑上转变为点对点信道**

![image-20211204184605114](..\images\image-20211204184605114.png)

#### 频分多路复用 FDM

频分多路复用是一种**将多路基带信号调制到不同频率载波**上，**再叠加**形成一个复合信号的多路复用技术

在物理信道的**可用带宽超过单个原始信号所需带宽**时，将物理信道的总带宽**分割**成若干与传输单个信号带宽相同的子信道，**每个子信道传输一种信号**，这就是频分多路复用；注意：子信道是逻辑的，带宽指的是赫兹

<img src="..\images\image-20211204185948913.png" alt="image-20211204185948913" style="zoom:125%;" />

每个子信道分配的带宽可不相同，但它们的**总和必须不超过信道的总带宽**

在实际应用中，为了防止子信道之间的干扰，相邻信道之间需要加入保护频带

<img src="..\images\format,f_jpg.jpg" alt="保护频带" style="zoom:125%;" />

优点：**充分利用了传输介质的带宽**，系统效率较高；由于**技术比较成熟**，实现也较容易；缺点：不能用于数字传输

#### 时分多路复用 TDM

时分多路复用是**将一条物理信道按时间分成若干时间片，轮流地分配给多个信号使用**，实现一条物理信道上传输多个信号

<img src="..\images\image-20211204190010501.png" alt="image-20211204190010501" style="zoom:125%;" />

- 某个时刻来看：时分多路复用信道上传送的**仅是某一对**设备之间的信号
- 某段时间来看：传送的是**按时间分割**的多路复用信号

但由于计算机数据的突发性，<u>一个用户对已经分配到的子信道的利用率一般不高</u>

统计时分多路复用 STDM，异步时分多路复用：TDM 的一种改进，采用 STDM 帧，它**按需动态地分配时隙**，当终端有数据要传送时，才会分配到时间片，因此可以**提高线路的利用率**；它会在帧头添加信息表示自己是谁发过来的

<img src="..\images\90bf536f56746576b8cde44b5132f31c.jpg" alt="img" style="zoom:80%;" />

例如线路传输速率为 `8000b/`s，4 个用户：TDM 方式，用户的最高速率为 `2000b/s`；STDM 方式，用户的最高速率 `8000b/s`

#### 波分多路复用 WDM

波分多路复用即**光的频分多路复用**，它在一根光纤中传输多种不同波长（频率）的光信号，由于波长（频率）不同，各路光信号互不干扰，最后再用波长分解复用器将各路波长分解出来

由于光波处于频谱的高频段，有很高的带宽，因而可以实现多路的波分复用

![image-20211204190256918](..\images\image-20211204190256918.png)

#### 码分多路复用 CDM

码分多路复用是**采用不同的编码来区分各路原始信号**，它**既共享信道的频率，又共享时间**

例子：假设 A 站要向 C 站运输黄豆，B 站要向 C 站运输绿豆，A 与 C、B 与 C 之间有一条公共的道路，类比为广播信道

- 频分复用：公共道路被划分为两个车道，两类车可以同时行走，但只分到了公共车道的一半，**只共享了时间**
- 在时分复：先让 A 到 C 的车走一趟，再让 B 到 C 的车走一趟，**只共享了空间**
- 码分复用：黄豆与绿豆放在同一辆车上运送，到达 C 后，把车上的黄豆和绿豆分开，**既共享了空间，也共享了时间**

![image-20211204190330043](..\images\image-20211204190330043.png)

也叫码分多址 Code Division Multiple Access，CDMA，原理：

1. 每个比特时间再划分成 m 个短的时间槽，称为码片（**各个站点的码片序列相互正交**），通常 m 的值是 64 或 128
2. 每个站点被指派一个唯一的 m 位码片序列，发送 1 时，站点**发送它的码片序列**；发送 0 时，站点**发送该码片序列的反码**
3. 当两个或多个站点同时发送时，各路数据在信道中**线性相加**
4. 到达目的后，将数据分离，**使用每个站点的码片与接受的信息进行规格化内积**，结果为 1 发送 1；为 -1 发送 0；为 0 没发

举例说明 CDMA 的原理，站点 A 和站点 B 同时向站点 C 发送数据，和站点 C 接受数据后的分离：

站点 A 的码片序列被指派为 00011011，按惯例将码片中的 0 写为 -1，将 1 写为 +1，A 码片是 -1-1-1+1+1-1+1+1

令 S 表示 A 站、T 表示 B 站码片向量，**两个不同站的码片序列正交的规格化内积为 0** ：$S\cdot T\equiv\dfrac 1m\displaystyle\sum^m_{i=1}S_iT_i=0$

**一个码片和自身的规格化内积都是 1，和反码的的规格化内积是 -1**，如：$S\cdot S\equiv\dfrac 1m\displaystyle\sum^m_{i=1}S_iS_i=\dfrac 1m\displaystyle\sum^m_{i=1}S_i^2=\dfrac 1m\displaystyle\sum^m_{i=1}(\pm1)^2=1$

令 B 站的向量 T 为 -1-1+1-1+1+1+1-1，其反码为 +1+1-1+1-1-1-1+1

当 A 站向 C 站发送数据 1 时，发送了 -1-1-1+1+1-1+1+1 当 B 站向 C 站发送数据 0 时，就发送了 +1+1-1+1-1-1-1+1

两个向量到了公共信道上就进行叠加，即线性相加，得到 S - T = (0 0 -2 2 0 -2 0 2)

到达 C 站后，**使用叠加原理进行数据分离**，如要取 A 站的数据 $S\cdot(S-T)=S\cdot S-S\cdot T=1$，取 B 站数据 $T\cdot(S-T)=-1$

优点：**频谱利用率高、抗干扰能力强**、保密性强、语音质量好等

可以减少投资和降低运行成本，主要用于无线通信系统，特别是**移动通信系统**

### 随机访问介质访问控制

在随机访问协议（争用型协议）中，用户能**根据自己的意愿随机地发送信息，占用信道全部速率**

在总线形网络中，当有两个或多个用户同时发送信息时，就会**产生帧的冲突**，导致**所有冲突用户的发送均以失败告终**

为了解决随机接入发生的碰撞，每个用户需要按照一定的规则反复地重传它的帧，直到该帧无碰撞地通过

这些规则就是随机访问介质访问控制协议：ALOHA 协议、CSMA 协议、CSMA/CD 协议和 CSMA/CA 协议等

采用随机访问控制机制，各结点之间的通信就可**既不共享时间，也不共享空间**

随机介质访问控制实质上是一种**将广播信道转化为点到点信道的行为**

![image-20211204190532478](..\images\image-20211204190532478.png)

#### ALOHA 协议

##### 纯 ALOHA 协议

纯 ALOHA 协议的基本思想：当网络中的任何一个站点需要发送数据时，可以**不进行任何检测就发送数据**

如果在一段时间内未收到确认，就认为传输过程中发生了冲突，会**等待一段时间后再发送数据**，直至发送成功

![image-20211204190642748](..\images\image-20211204190642748.png)

工作原理：每个站均**自由地发送数据帧**，发生冲突时，让各站**等待一段随机的时间**再进行重传，直到重传成功

![image-20211204190742626](..\images\image-20211204190742626.png)

纯 ALOHA 网络的吞吐量为 $S=Ge^{-2G}$，当 G = 0.5 时，$S=0.5e^{-1}\approx0.184$ 达到最高，**纯 ALOHA 网络的吞吐量很低**

- 网络负载 G： $T_0$ 时间内所有站点发送成功和因冲突未发送成功的帧，即**所有发送信息的数量**
- 网络的吞吐量 S： $T_0$ 时间内成功发送的平均帧数

##### 时隙 ALOHA 协议

把所有各站在时间上同步起来，并**将时间划分为一段段等长的时隙**，规定**只能在每个时隙开始时才能发送一个帧**

这样避免了用户发送数据的随意性，减少了数据产生冲突的可能性，提高了信道的利用率

工作原理：时隙的长度 $T_0$ 使得**每个帧正好在一个时隙内发送完毕**；每个帧在到达后，**等到时隙开始再发送出去**；一个时隙内有多个帧到达时，在下一个时隙开始时会产生碰撞，另找随机时间发送

![image-20211204190928434](..\images\image-20211204190928434.png)

时隙 ALOHA 网络的吞吐量 S 与网络负载 G 的关系是 $S=Ge^{-G}$；注意：这里网络负载 = $\dfrac{总负载}{时隙个数}$

当 G = 1 时，$S=e^{-1}\approx0.368$ 达到最高，**比纯 ALOHA 网络的吞吐量大了 1 倍**

#### CSMA 协议

若每个站点在**发送前都先侦听一下共用信道**，发现信道空闲后再发送，则就会大大降低冲突的可能，从而提高信道的利用率

载波侦听多路访问 Carrier Sense Multiple Access，CSMA 协议依据的正是这一思想

CSMA 协议是 **ALOHA 的一种改进协议**，比 ALOHA 多了一个**载波侦听装置**

根据侦听方式和侦听到信道忙后的处理方式不同，CSMA协议分为三种

##### 1 - 坚持 CSMA

基本思想：一个结点要发送数据时，先侦听信道：**空闲则发；忙则等待，直到空闲；冲突则随机时间后，再侦听**

坚持的含义：侦听到信道忙后，**继续坚持侦听信道**；侦听到信道空闲后，立刻发送数据

传播延迟对 1 - 坚持 CSMA 协议的性能影响较大：

1. A 结点侦听信道空闲，发消息，过了一会但消息没传到 B 结点，B 结点侦听信道也空闲，发送了消息，发生冲突
2. A、B 结点侦听信道忙，都坚持侦听，当信道空闲时，两个同时发消息，发生冲突

##### 非坚持 CSMA

基本思想：一个结点要发送数据时，首先侦听信道：**空闲则发；忙则随机时间后再侦听**

优点：**降低了多个结点等待信道空闲后同时发送数据导致冲突的概率**；缺点：**增加数据在网络中的平均延迟**

可见，信道利用率的提高是以增加数据在网络中的延迟时间为代价的

##### p - 坚持 CSMA

**用于时分信道**（时隙 ALOHA 那样的信道）基本思想与 1 - 坚持类似：一个结点要发送数据时，首先帧听信道：

- 如果信道忙，就下一个时隙再侦听
- 如果信道空闲，**以概率 p 发送数据，以概率 1 - p 推迟到下一个时隙再侦听**

概率发送是为了：降低 1 - 坚持 CSMA 协议中**多个结点检测到信道空闲后同时发送数据的冲突概率**

坚持侦听是为了：克服非坚持 CSMA 协议中由于**随机等待而造成的延迟时间较长的缺点**

p - 坚持 CSMA 协议是非坚持 CSMA协议和 1 - 坚持 CSMA 协议的折中方案

##### 三种的比较

![image-20211204191113115](..\images\image-20211204191113115.png)

#### CSMA/CD 协议

载波侦听多路访问/碰撞检测 CSMA/CD 协议是 CSMA 协议的改进方案，适用于**总线形网络或半双工网络环境**

- 载波帧听：发送数据前先要检测总线上是否有其他站点正在发送数据，若有则等待信道变为空闲时再发送
- 碰撞检测：适配器**边发送数据边检测信道上信号电压**的变化情况，**判断其他站点是否也在发送数据**

CSMA/CD 协议已成功应用于使用**有线连接的局域网**

##### 工作流程

工作流程可简单概括为**先听后发，边听边发，冲突停发，随机重发**：

1. 适配器从网络层获得一个分组，封装成以太网帧，**放入适配器的缓存**，准备发送
2. 适配器侦听信道：空闲则发；忙则侦听到空闲再发
3. 在发送过程中，适配器持续检测信道：**未碰撞则发送完毕；碰撞则中止发送**，并发送拥塞信号，让所有用户知道
4. 在中止发送后，适配器就**执行指数退避算法，等待一段随机时间**后返回到步骤 2

##### 窗口争用期

**某个时刻检测到信道空闲时，此时信道并不一定是空闲的**，可能信道有数据但没传播到这里

例子如下图（碰撞检查是查看信道的电压与发送的信息的电压是否一样）：

1. 设 $\tau$ 为单程传输时延，在 t = 0 时 A 发送数据，在 $t = \tau-\delta$ 时 B 检测信道空闲也发送消息
2. 在 $t = \tau-\dfrac2\delta$ 时，两数据碰撞，在  $t=\tau$ 时 A 发送的数据到达 B，B 检查到碰撞停止发送数据
3. 在 $t=2\tau-\delta$ 时，B 发送的数据也到达 A，A 检查到碰撞停止发送数据

![image-20211204191227039](..\images\image-20211204191227039.png)

CSMA/CD 中的站**不可能同时进行发送和接收**，因此采用 CSMA/CD 协议的以太网**只能进行半双工通信**

当 A 发送数据 $\tau$ 时间后，B 再发送数据就会监听到信道忙而进行等待，所以 **A 经过 $2\tau$ 后就知道有没有发生冲突**（$\delta\to0$）

因此**把以太网端到端往返时间 $2\tau$ 称为争用期**，<u>经过争用期这段时间还未检测到碰撞时，才能确定这次发送不会发生碰撞</u>

##### 最小帧长

CSMA/CD 作用是在发送数据时检查到碰撞而停止发送，帧太短发完了才检查到碰撞，协议就没作用了

为了让本协议起作用，所以**数据的发送时间应该大于等于争用期**，得**最小帧长 = 总线传播时延 × 数据传输速率 × 2**

收到帧长小于最小帧长时，**把它当作无效帧立即丢弃**；发送帧长小于最短帧时，**在数据字段后面增加填充字段填充若干字节**

例如：以太网规定取 **`51.2us` 为争用期的长度**，对于 `10Mb/s` 的以太网，在争用期内可发送 `512bit`，即 `64B`

**以太网规定最短帧长为 `64B`**，凡长度小于 `64B` 的帧都是由于冲突而异常中止的无效帧，收到这种无效帧时应立即丢弃

##### 二进制指数退避算法

CSMA/CD 采用二进制指数退避算法来解决碰撞问题，算法精髓如下：

1. **确定基本退避时间**，一般取**争用期**：两倍的总线端到端传播时延 $2\tau$
2. 定义参数 k，它等于重传次数，但 k 不超过 10，即 **k = min[重传次数, 10]**
3. 从集合 $[0,1,\cdots,2^k-1]$ 中随机取出一个数 r，重传所需要**退避的时间就是 r 倍的基本退避时间**，即 $2r\tau$
4. **当重传达 16 次仍不能成功时**，说明网络太拥挤，认为此帧永远无法正确发出，**抛弃此帧并向高层报告出错**

例子：第 1 次重传时，随机数 r 从整数 {0, 1} 中选择，第 2 次重传时，随机数 r 从整数 {0, 1, 2, 3} 中选择

使**重传时推迟的平均时间随重传次数的增大而增大**（动态退避），能降低发生碰撞的概率，有利于整个系统的稳定

#### CSMA/CA 协议

在无线局域网环境下，不能使用 CSMA/CD 协议，主要有两个原因（这一节都是 **802.11 的规定**）：

1. **接收信号远小于发送信号的强度**，且信号强度的动态变化范围很大，要实现碰撞检测，则硬件上的花费就会过大
2. 在无线通信中，**并非所有的站点都能够听见对方**，即存在隐蔽站问题

802.11 标准定义**应用于无线局域网的 CSMA/CA 协议**，它对 CSMA/CD 协议进行了修改，把碰撞检测改为碰撞避免

碰撞避免是指**尽量降低碰撞发生的概率**：802.11 无线局域网不使用碰撞检测，即使**发生碰撞时仍然会完全的发送该帧**，会严重降低网络的效率，因此要采用碰撞避免技术降低碰撞的可能性

##### 帧间间隔

无线信道的通信质量远不如有线信道，使用确认/重传 ARQ 方案，**发完一帧要收到确认才能发送下一帧**

帧间间隔 IFS：为了尽量避免碰撞，所有的站**完成发送后，必须再等待一段很短的时间才能发送下一帧**

帧间间隔的长短取决于该站要发送的帧的类型：

1. `SIFS`，短 IFS：最短 IFS，用来**分隔属于一次对话的各帧**；有 `ACK`、CTS、RTS 帧
2. `PIFS`，点协调 IFS：中等长度的 IFS，在 `PCF` 操作中使用
3. `DIFS`，分布式协调 IFS：**最长的 IFS**，用于异步帧竞争访问的时延（**发送帧**和管理帧）

##### 工作原理

CSMA/CA 的退避算法与 CSMA/CD 稍有不同：信道**从忙态变为空闲态时**，要发送数据帧，不仅都要**等待一个时间间隔**，而且要**进入争用窗口（刚开始是 [0, 31]）计算随机退避时间**，这样可以降低了碰撞发生的概率

当且仅当检测到**信道空闲且要发送的第一个数据帧**时，才**不使用退避算法**，其他所有情况都必须使用退避算法，具体为：

1. 在发送第一个帧前检测到信道忙
2. 每次重传
3. 每次成功发送后要发送下一帧

CSMA/CA 算法归纳如下（[详细](https://zhuanlan.zhihu.com/p/20721272)）：

1. 若站点最初有数据要发送，且检测到信道空闲，在**等待时间 `DIFS` 后**，就发送整个数据帧

2. 否则，站点执行 CSMA/CA 退避算法，选取一个随机回退值

   检测到信道忙时，**退避计时器就保持不变**；只有信道空闲时，**退避计时器才进行倒计时**

3. 当**退避计时器减到 0 时**，这时信道只可能是空闲的，站点就**发送整个帧并等待确认**

4. 发送站若**收到确认**，就知道已发送的帧被目的站正确接收

   否则超时重传从步骤 2 开始，直到被确认或失败太多被抛弃

5. 要发送第二帧，就要从步骤 2 开始

![image-20211205191510492](..\images\image-20211205191510492.png)

![img](..\images\16def232e6120952e14b1047592dead3_1440w.png)

##### 处理隐蔽站问题

隐蔽站问题：站 A 和 B 都在 AP 内，但听不见对方；当 A 和 B 检测到信道空闲时，都向 AP 发送数据，导致碰撞的发生

![image-20211204191510456](..\images\image-20211204191510456.png)

为了避免该问题，允许**发送站对信道进行预约**，源站要发送数据帧之前先**广播一个短请求发送 RTS 控制帧**，它包括源地址、目的地址和这次通信（含相应的确认帧）所持续的时间，该帧**能被其范围内包括 AP 在内的所有站点听到**

若信道空闲，则 AP **广播一个允许发送 CTS 控制帧**，它包括这次通信所需的持续时间（从 RTS 复制）

CTS 帧有两个目的：①**给源站明确的发送许可**；②**指示其他站点在预约期内不要发送**

![image-20211204191553655](..\images\image-20211204191553655.png)

使用 RTS 和 CTS 帧会使网络效率有所下降，但这两种帧都很短，与数据帧相比开销不算大

若不使用这种控制帧，一旦发生碰撞而导致数据帧重发，则浪费的时间更多

协议设有三种情况供用户选择：

1. 使用 RTS 和 CTS 帧
2. 只有当数据帧的长度超过某一阈值时才使用 RTS 和 CTS 帧
3. 不使用 RTS 和 CTS 帧

#### CSMA/CD 与 CSMA/CA 的区别

1. CSMA/CD 可以检测冲突，但无法避免；CSMA/CA **不能边发边检查**，接收结点冲突与本结点冲突无关，只能尽量避免
2. 传输介质不同：CSMA/CD 用于**总线形以太网**；CSMA/CA 用于**无线局域网** `802.11a/b/g/n` 等
3. 检测方式不同：CSMA/CD 通过**电缆中的电压变化**来检测；而 CSMA/CA 采用**能量检测、载波检测、能量载波混合检测**三种检测信道空闲的方式

CSMA/CA 协议的基本思想：**发送数据时先广播告知其他结点，让其他结点在某段时间内不要发送数据**

CSMA/CD 协议的基本思想：**发送前侦听，边发送边侦听，一旦出现碰撞马上停止发送**

### 轮询访问介质访问控制

#### 介质访问控制

在轮询访问中，通过一个集中控制的监控站，以循环方式轮询每个结点，再决定信道的分配

**某结点使用信道时，其他结点都不能使用信道**；典型的协议是令牌传递协议，它主要用在**令牌环局域网**中

令牌传递协议中，**一个令牌在各结点间以某个固定次序交换**，令牌是由**一组特殊的比特组合**而成的帧

- 必须要**拥有令牌才可以发送帧**，帧中包括目的站的地址，以标识哪个站应接收此帧
- 帧在环上传送时，**所有站点都进行转发**，直到该帧回到它的始发站，并由该**始发站撤销该帧**
- 帧的目的站还应针**对该帧维持一个副本**（接受，及防止丢包），并通过在帧的尾部**设置响应比特来指示已收到**
- 站点在**发送完一帧后，应释放令牌**，以便让其他站使用，当计算机都**不需要发送数据时，令牌就在环形网上游荡**

![img](..\images\a1f7155aca9455da2c3eca3546d8b914.jpg)

在令牌传递网络中，传输介质的**物理拓扑是星形或环形**，但在**逻辑上是一个环**

轮询介质访问控制非常适合负**载很高的广播信道**，即多个结点在同一时刻发送数据概率很大的信道（不会发生冲突）

轮询介质访问控制**既不共享时间，也不共享空间**，它在随机介质访问控制的基础上，限定了发送数据的结点只能有一个

通过介质访问控制机制**使广播信道逻辑上变为点对点的信道**，所以说数据链路层研究的是点到点之间的通信

#### 基本原理

令牌环网的每一站通过电缆与环接口干线耦合器 TCU 相连

TCU 的主要作用：**传递所有经过的帧，为接入站发送和接收数据提供接口**

TCU 的状态有：收听状态和发送状态，数据在某个**特定的方向**上逐比特地传送，每个 TCU **重新产生并重新传输每一比特**

![image-20211206192950305](..\images\image-20211206192950305.png)

令牌沿着环形总线在入网结点计算机间**依次传递**，令牌是一个**特殊格式的 MAC 控制帧**，它**不包含信息**，仅控制信道的使用

只有**取得令牌后才能发送数据帧**，对所有入网计算机而言，访问权是公平的

令牌环网中令牌和数据的传递过程如下：

1. 网络空闲时，环路中只有令牌帧在循环传递

2. 站点要发送数据时先等待令牌，然后**修改令牌中的一个标志位**，在令牌中**附加传输数据**，变成一个数据帧再发送出去

3. 数据帧沿着环路传输，接收到的站点一边转发数据，一边查看帧的目的地址

   目的地址和自己的**地址相同**，就**复制该数据帧**以便进一步处理

4. 数据帧沿着环路传输，直到到达该帧的源站点，源站点**检验数据传输过程中是否有错**，若有错则重传该帧

5. 源站点传送完数据后，**重新产生一个令牌，并将令牌传递给下一个站点**，以交出对媒体的访问权限

令牌环网在**物理上是星形拓扑结构，逻辑上是环形拓扑结构**，其标准由 IEEE 802.5 定义

## 局域网

### 局域网的基本概念和体系结构

局域网 Local Area Network，LAN：在一个**较小的地理范围内**，将各种计算机、外部设备和数据库系统等通过双绞线、同轴电缆等连接介质互相连接起来，组成资源和信息共享的计算机互联网络

主要特点如下:

1. 为一个单位所拥有，且**地理范围和站点数目均有限**
2. 所有站点**共享较高的总带宽**
3. **较低的时延和较低的误码率**
4. 各站为**平等关系**而非主从关系 
5. **能进行广播和组播**

局域网特性主要由**拓扑结构、传输介质、介质访问控制方式**决定，最重要的是介质访问控制方式，它决定局域网的技术特性

1. 拓扑结构主要有：星形结构、环形结构、总线形结构、星形和总线形结合的复合型结构
2. 传输介质主要有：双绞线、铜缆、光纤等，其中**双绞线为主流传输介质**
3. 介质访问控制方法主要有：CSMA/CD、令牌总线、令牌环，前两种主要用于**总线形局域网**，令牌环主要用于环形局域网

三种特殊的局域网拓扑实现如下：

- 以太网，IEEE 802.3：目前使用范围最广的局域网，**逻辑拓扑是总线形结构，物理拓扑是星形**
- 令牌环，IEEE 802.5：**逻辑拓扑是环形结构，物理拓扑是星形结构**
- 光纤分布数字接口 `FDDI`，IEEE 802.8：逻辑拓扑是环形结构，物理拓扑是双环结构

IEEE 802 标准定义的局域网参考模型**只对应于 OSI 参考模型的<u>数据链路层和物理层</u>**

IEEE 802 标准将数据链路层拆分为：

- 逻辑链路控制 LLC 子层：**与传输媒体无关**，它**向网络层提供服务**，如差错控制、给帧加序号

- 媒体接入控制 MAC 子层：**与传输媒体有关**，它向上层屏蔽对物理层访问的各种差异，提供对物理层的统一访问接口

  用于**处理与物理层相关的东西**，如组帧和拆卸帧、比特传输差错检测、透明传输

注意：由于以太网在局域网取得了垄断地位，因此现在许多网卡仅装有 MAC 协议而没有 LLC 协议

![image-20211206192146946](..\images\image-20211206192146946.png)

### 以太网与 IEEE 802.3

IEEE 802.3 标准是一种**基带总线形**的局域网标准，它**描述物理层和数据链路层的 MAC 子层的实现方法**

以太网逻辑上采用总线形拓扑结构，所有计算机**共享同一条总线，信息以广播方式发送**，通信使用 CSMA/CD 方式

以太网指 `DIX Ethernet V2` 标准的局域网，但它与 IEEE 802.3 标准只有很小差别，因此将 802.3 局域网也简称为以太网

以太网采用两项措施以简化通信：

1. 采用**无连接**的工作方式，**不对发送的数据帧编号**，也**不要求接收方发送确认**（不可靠），对于**差错的纠正则由高层完成**
2. **使用曼彻斯特编码**的信号，每个码元的中间出现一次电压转换，接收以此同步信号

选择题：在总线的以太网中（**没有交换机等**），一个结点发送消息，包括该结点在内的所有结点都可以收到

注意：以太网的 MAC 帧也叫 CSMA/CD 帧；而无线网的帧也叫 CSMA/CA 帧

#### 以太网的传输介质与网卡

以太网常用的传输介质有：粗缆、细缆、双绞线和光纤，适用情况为（**要背**）：

![image-20211206192324900](..\images\image-20211206192324900.png)

注意：`10BASE-T` 虽然最大最多结点数是 2，但它连接集线器，在逻辑上仍然是一个总线网，属于一个冲突域

计算机与外界局域网的连接是通过主机箱内插入的一块**网络接口板**（也称网络适配器或网络接口卡）实现的

网卡上装有处理器和存储器工作在**数据链路层和物理层**：

- 在数据链路层：实现将电缆的串行转换为 I/O 总线的并行，以及 MAC 层的功能
- 在物理层：控制主机对介质的访问

介质访问控制 MAC 地址：每块网卡在**出厂时都有唯一的代码**，用于控制主机在网络上的数据通信

网桥和二层交换机，本身是没有 MAC 地址的；**注意：在计网中的物理地址就是指 MAC 地址**

#### 以太网的 MAC 帧

MAC 地址也称物理地址：它**长 6 字节**，一般用由连字符或冒号分隔的 12 个十六进制数表示，如 `02-60-8c-e4-b1-21`

高 24 位为厂商代码，低 24 位为厂商自行分配的网卡序列号，**局域网的地址是每个站的名字或标识符**

由于使用广播通信，网卡每收到一个 MAC 帧，先检查 MAC 帧中的 MAC 地址，**如果是自己的，那么就收下，否则丢弃**

以太网 MAC 帧格式有两种标准：`DIX Ethernet V2` 标准和 IEEE 802.3 标准，下面介绍最常用的 **`V2` 标准 MAC 帧格式**

![image-20211206192521205](..\images\image-20211206192521205.png)

帧要加头部和尾部：这里头部是目的地址、源地址、类型，尾部是校验码

- 前导码：**使接收端与发送端时钟同步**，在帧前面插入的 8 字节分为两个字段：

  - 第一个字段：7 字节，是前同步码，用来快速**实现 MAC 帧的比特同步**
  - 第二个字段：**帧开始定界符**，表示后面的信息就是 MAC 帧

  注意：MAC 帧并**不需要帧结束符**，因为以太网在传送帧时，**各帧之间必须有一定的间隙**，对于曼切斯特编码来说，停止传送是很明显的，因为传送一位时中间会有一次跳转，若没有跳转就知道没有传送，就知道帧结束了

- 地址：通常使用 6 字节的 MAC 地址

- 类型：2 字节，指出数据域中携带的数据应交给哪个协议实体处理

  **对于 802.3 这里是数据的长度**，实践中这里是长度/类型，前 1500 表长度，1501 ~ 65535 用于类型段识别符

- 数据：**46 ~ 1500 字节**，包含高层的协议消息，**少于 46 字节时会进行填充**

  由于 CSMA/CD 算法的限制，以太网最短帧是 64 字节，头尾占了 18 字节，所以数据起码要 46 字节

- 校验码 `FCS`：4 字节，校验范围从**目的地址段到数据段的末尾**，32 位循环冗余码

#### 高速以太网

**速率达到或超过 `100Mb/s` 的以太网称为高速以太网**

1. `100BASE-T` 以太网：**在双绞线上传送 `100Mb/s` 基带信号的星形拓扑结构**以太网，它使用 CSMA/CD 协议

   这种以太网**既支持全双工方式，又支持半双工方式**，在全双工方式下无冲突发生（使用交换机无冲突）

   MAC 帧格式仍然是 802.3 标准规定的，**保持最短帧长不变**，将一个网段的**最大电缆长度减小到 `100m`**，并把**帧间时间间隔从原来的 `9.6us` 改为现在的 `0.96us`**

2. 吉比特以太网：允许在 **`1Gb/s`** 下用**全双工和半双工**两种方式工作，使用**光纤或 `UTP5` 类线**（超五类非屏蔽双绞线）

   使用 802.3 协议规定的帧格式，仅在半双工方式下使用 CSMA/CD 协议，与 `10BASE-T` 和 `100BASE-T` 技术向后兼容

3. 10 吉比特以太网：使用 802.3 协议规定的帧格式，**使用光纤作为传输媒体**，且**只工作在全双工方式**

以太网从 `10Mb/s` 到 `10Gb/s` 的演进证明了以太网是可扩展的、灵活的（多种传输媒体、全/半双工、共享/交换），易于安装，稳健性好

### IEEE 802.11

#### 有固定基础设施无线局域网

对于有固定基础设施的无线局域网，IEEE 制定了无线局域网的 802.11 系列协议标准，包括 `802.11a/b/g/n` 等

使用**星形拓扑**，其中心称为**接入点 AP**，MAC 层使用 CSMA/CA 协议；使用 802.11 系列协议的局域网又称 `Wi-Fi`

规定无线局域网的**最小构件是基本服务集 BSS**，一个基本服务集包括**一个基站和若干移动站**

和本 BSS 内的站都可**以直接通信**，和本 BSS 外的站通信时都必须**通过本 BSS 的基站**

**AP 就是基本服务集中的基站** base station，安装 AP 时，为该 AP 分配一个不超过 32 字节的**服务集标识符 `SSID` 和一个信道**

基本服务集覆盖的地理范围称为**基本服务区** BSA，无线局域网的基本服务区的直径一般不超过 `100m`

基本服务集可以是孤立的，也**可通过 AР 连接到一个分配系统 `DS`**，然后连接到另一个基本服务集，构成一个扩展的服务集`ESS`，`ESS` 还可以通过一种称为门桥 Portal 的设备**为无线用户提供到有线连接的以太网的接入**，门桥的作用相当于一个网桥

![image-20211206192734560](..\images\image-20211206192734560.png)

移动站 A 如果要和另一个基本服务集中的移动站 B 通信，就必须经过两个接入点 `AP1` 和 `AP2`

移动站 A 移动到另一个基本服务集时，**仍然可保持与移动站 B 的通信**，但使用的 AP 改变了，AP 的切换叫漫游

#### 无固定基础设施移动自组织网络

自组网络没有上述基本服务集中的 AP，而是**由一些平等状态的移动站相互通信组成的临时网络**

各结点之间地位平等，**中间结点都为转发结点**，因此都具有路由器的功能

自组网络中的每个移动站都要参与网络中的其他移动站的路由发现和维护，同时由移动站构成的网络拓扑可能随时间变化得很快，因此<u>在固定网络中行之有效的一些路由选择协议对移动自组网络已不适用</u>

![image-20211206192846929](..\images\image-20211206192846929.png)

自组网络和移动 IP 并不相同：

- 移动 IP 技术：使漫游的主机可以用多种方法连接到因特网，**基于固定网络中的各种路由选择协议**
- 自组网络：把移动性扩展到无线领域中的自治系统，**具有自己特定的路由选择协议**，并且可以不和因特网相连

#### 802.11 的 MAC 帧头格式

802.11 帧共有数据帧、控制帧、管理帧三种类型，数据帧由三大部分组成：

1. MAC 首部，共 30 字节
2. 帧主体，即帧的数据部分，不超过 2312 字节
3. 帧检验序列 FCS 是尾部，共 4 字节

![image-20220816205255400](..\images\image-20220816205255400.png)

RA 是目的结点的 AP 的地址，TA 是源结点的 AP 的地址，SA 源结点的地址，DA 是目的结点的地址

![image-20211206213918823](..\images\image-20211206213918823.png)

- `IBSS`：一个服务集内的移动站点不通过基站的直接通信，`BSSID` 是一个特定的字符串
- To AP：服务集内的移动站点向基站的通信，`BSSID` 是 AP 的 ID
- From AP：服务集内基站向移动站的通信
- `WDS`：不同服务集内的两个移动站之间的通信，是两个 AP 之间的帧

注意：第一种是没有 AP 时才用的，可能是手机开热点给别人

思考：无论是哪个，**Address 1 就是该帧接受设备，Address 2 就是该帧发送设备**

思考：AP 是链路层设备，故通信时要先通过 ARP 拿到目的的 MAC 地址

### VLAN 基本概念与基本原理

虚拟局域网 Virtual LAN：分割局域网和广播域，分割出的逻辑上的 VLAN 与地理位置无关

`802.3ac` 定义了 802.1Q 帧以支持 VLAN：**在以太网帧中插入一个 4 字节的标识符**，称为 VLAN 标签，**指明发送该帧的计算机属于哪个虚拟局域网**，最大帧长从原来的 1518 字节变为 1522 字节

![image-20220816224520986](..\images\image-20220816224520986.png)

VLAN 标签结构：

- 前两个字节置为 `0x8100`，表示这是一个 802.1Q 帧
- 后两个字节中，前 4 位没有用，后 12 位是该 VLAN 的标识符 VID，**共有 4096 个 VLAN**
- 插入 VID 后，`802.1Q` 帧的 **FCS 必须重新计算**

![image-20220816224555947](..\images\image-20220816224555947.png)

这里的 VLAN-10 和 VLAN-20 中的 10 和 20 是 VID 由交换机管理员设置，且 VID 仅交换机知道

同 VLAN 间的主机属于**同一个广播域**，不同 VLAN 的主机属于**不同的广播域**

802.1Q 帧，**仅在两个交换机之间才使用**，交换机收到主机的 MAC 帧向交换机转发时要转变成 802.1Q 帧，插入 VLAN 标签

- 如 A 向 E 发送：交换机 1 把 A 的 MAC 帧变成 802.1Q 帧发给交换机 2，交换机 2 把 802.1Q 帧转成 MAC 帧发给 E
- 而 A 发给 C 时：交换机先检查转发表找到 C 的端口，然后去 VLAN 表发现不在同一个 VLAN 故发送失败

![image-20220816230649102](..\images\image-20220816230649102.png)

注意：交换机内部有转发表和 VLAN 表，转发表判断要发给哪个端口，VLAN 表判断这个端口是否可以发送

VLAN 的优点：**①有效共享网络资源；②简化网络管理；③提高网络安全性；④限制广播域**

思考：交换机间使用 trunk 是为了让交换机发送 802.1Q 帧，以便把 VLAN 信息的发送过去

选择题：划分 VLAN 的方式：①基于端口；②基于 MAC 地址；③基于 IP 地址

## 广域网

### 广域网的基本概念

广域网指**覆盖范围很广**的长距离网络，是因特网的核心部分，其任务是**长距离运送主机所发送的数据**

连接广域网各结点交换机的链路都是**高速链路**，它可以是长达几千千米的光缆线路、或长达几万千米的点对点卫星链路

因此广域网首要考虑的问题是**通信容量必须足够大**，以便支持日益增长的通信量

广域网不等于互联网，互联网可以**连接不同类型的网络**，通常**使用路由器**来连接

局域网可以通过广域网与另一个相隔很远的局域网通信

![image-20211207180841378](..\images\image-20211207180841378.png)

广域网由一些**结点交换机及连接这些交换机的链路**组成（广域网是单个网络用结点交换机就好了）

- 注意：结点交换机和路由器都用来转发分组，工作原理也类似；**结点交换机在单个网络使用，路由器在多个网络使用**

结点交换机的功能：**将分组存储并转发**，使用**点到点连接**，为了提高网络的可靠性，其通常与多个结点交换机相连

从层次上考虑，广域网和局域网的区别很大，**局域网使用的协议主要在数据链路层，而广域网使用的协议主要在网络层**

![image-20211207180945848](..\images\image-20211207180945848.png)

广域网中的一个重要问题是路由选择和分组转发：路由选择协议负责搜索分组从某个结点到目的结点的最佳传输路由，以便构造路由表，然后从路由表再构造出转发分组的转发表，分组是通过转发表进行转发的

PPP 协议和 HDLC 协议是目前最常用的两种广域网**数据链路层控制协议**

### PPP 协议

Point-to-Point Protocol 是使用**串行线路**通信的**面向字节**的协议，该协议应用在直接连接两个结点的链路上

设计的目的：通过拨号或专线方式建立点对点连接发送数据，使各种主机、网桥和路由器之间进行简单连接

PPP 协议是在 SLIP 协议的基础上发展而来的，它**既可以在异步线路上传输，又可在同步线路上使用**

PPP 协议有三个组成部分：

1. 链路控制协议 `LCP`：一种扩展链路控制协议，**用于建立、配置、测试和管理数据链路**
2. 网络控制协议 `NCP`：每个不同的网络层协议要用一个相应的 `NCP` 来配置，**为网络层协议建立和配置逻辑连接**
3. 将 IP 数据报封装到串行链路的方法：IP 数据报在 PPP 帧中就是其信息部分

![image-20211207181122726](..\images\image-20211207181122726.png)

PPP 帧的结构：

1. 标志字段 F：`7E`，01111110，前后各占 1 字节，**标志帧开始和结束**

2. 地址字段 A：规定为 FF，保留

3. 控制字段 C：规定为 03，保留

4. 协议字段：说明信息段中运载的**分组的种类**

   - 以比特 0 开始：是诸如 `IP、IPX、AppleTalk` 这样的**网络层协议**
   - 以比特 1 开始：被**用来协商的其他协议**，包括 `LCP` 及每个支持的网络层协议的一个不同的 `NCP`

5. 信息部分：长度可变，`0 ~ 1500B`，当信息段中出现和标志字段一样的比特组合时，必须采用一些措施来改进

   注意：因为 PPP 是点对点，不使用 CSMA/CD 所以没有最短帧

6. 帧检验序列 `FCS`：**循环冗余码**检验中的冗余码，检验区包括**地址字段、控制字段、协议字段和信息字段**

PPP 链路的建立、使用、撤销过程，如下图：

1. 当线路处于**静止状态时，不存在物理层连接**
2. 当线路检测到载波信号时，**建立物理连接，变为建立状态**
3. `LCP` 开始选项商定，**商定成功后就进入身份验证状态**
4. **双发身份验证通过后，进入网络状态**
5. 采用 `NCP` 配置网络层，**配置成功后，进入打开状态**，然后就可**进行数据传输**
6. 当**数据传输完成后，线路转为终止状态**，载波停止后则回到静止状态

![image-20211207181209998](..\images\image-20211207181209998.png)

PPP 协议中需要注意的是：

1. PPP 提供**差错检测**但不提供纠错功能，只保证无差错接收；是**不可靠的传输协议**，因此也**不使用序号和确认机制**
2. 它**仅支持点对点的链路通信**，不支持多点线路
3. **PPP 只支持全双工链路**
4. PPP 的两端**可以运行不同的网络层协议**，但仍然可使用同一个 PPP 进行通信
5. PPP 是面向字节的，当信息字段出现和标志字段一致的比特组合时的处理方法：
   - 若 PPP 用在**异步线路**，默认：则**采用字节填充法**，填充 `7D`
   - 若 PPP 用在 `SONET/SDH` 等**同步线路**：采用硬件来完成**比特填充**
6. PPP 还支持非 IP 分组和数据压缩

额外：PPP 是 TCP/IP 的协议，而 HDLC 不是

### HDLC 协议*

高级数据链路控制 HDLC 协议是 ISO 制定的**面向比特**的数据链路层协议，其特点有：

1. 该协议不依赖于任何一种字符编码集
2. 数据报文可透明传输，用于实现透明传输的是 **0 比特插入法**
3. **全双工通信**，有较高的数据链路传输效率
4. 所有帧采用 CRC 检验，**对信息帧进行顺序编号**，可防止漏收或重发，**传输可靠性高**
5. 传输控制功能与处理功能分离，具有较大的灵活性

HDLC 有非平衡配置和平衡配置两种适用于链路的基本配置：

1. 非平衡配置的特点：**一个主站控制整个链路的工作**
2. 平衡配置的特点：**链路两端的两个站都是复合站**，都可以平等地发起数据传输

#### 站

HDLC 有主站、从站、复合站三种站类型：

- 主站：**负责控制链路的操作**，主站发出的帧称为**命令帧**
- 从站：按主站的命令进行操作，发出的帧称为**响应帧**
- 复合站：**有主站和从站的功能**，它可以发出命令帧和响应帧

#### 数据操作方式

HDLC 有 3 种数据操作方式：

1. 正常响应方式：非平衡结构操作方式，**主站向从站传输数据，从站响应传输**（从站收到主站许可后，才可进行响应）
2. 异步平衡方式：平衡结构操作方式，每个复合站**都可以对另一站进行数据传输**
3. 异步响应方式：非平衡结构操作方式，但从站**未受到主站的允许，也可进行传输**

#### HDLC 帧

HDLC 的帧格式由标志、地址、控制、信息和帧校验序列等字段构成：

1. 标志字段 F：`7E`，采用[零比特填充的首尾标志法](#零比特填充的首尾标志法)实现透明传输
2. 地址字段 A：**非平衡方式**传送数据时，是**从站的地址**；**平衡方式**传送数据时，是**应答站的地址**
3. 控制字段 C：最复杂的字段，HDLC 的许多重要功能都靠控制字段来实现

![image-20211207181330915](..\images\image-20211207181330915.png)

根据控制字段第 1 位或第 1、2 位的取值，可将 HDLC 帧划分为三类：

1. **信息帧** I，以 0 开头：用来传输数据信息，或使用捎带技术对数据进行确认
2. **监督帧** S，以 10 开头：用于流量控制和差错控制，执行对信息帧的确认、请求重发和请求暂停发送等功能
3. **无编号帧** U，以 11 开头：用于提供对链路的建立、拆除等多种控制功能

PPP 帧和 HDLC 帧的格式有以下几点不同：

1. PPP 协议是**面向字节**的，HDLC 协议是**面向比特**的
2. PPP 帧比 HDLC 帧**多一个 2 字节的协议字段**，当协议字段值为 `0x0021` 时，表示信息字段是 IP 数据报
3. PPP **不能提供可靠传输**，只保证无差错接收；HDLC 能够**提供可靠传输**

## 数据链路层设备

### 网桥的概念及其基本原理*

多个以太网通过网桥连接后，就成为一个覆盖范围更大的以太网，而原来的**每个以太网就称为一个网段**

网桥工作在**链路层的 MAC 子层**，可以为以太网各网段**隔离碰撞域**

由于各网段相对独立，因此**一个网段的故障不会影响到另一个网段的运行**

注意：网桥的数据对象是**帧**，工作在数据链路层；中继器、放大器的数据对象是**信号**，工作在物理层

网络 A、C 通过网桥连接，网桥接收 A 的数据帧后检查目的地址，<u>是 B 的地址不需要转发就丢弃，是 C 的地址就转发</u>

设每个网段的数据率都是 `10Mb/s`，三个网段合起来的最大吞吐量就变成了 `30Mb/s`

![image-20211208143034466](..\images\image-20211208143034466.png)

网桥的基本特点：

1. 网桥必须具备**寻址和路径选择能力**，以确定帧的传输方向

2. 从源网络接收帧，以目的网络的介质访问控制协议**向目的网络转发该帧**

3. 网桥在**不同或相同类型的 LAN 之间存储并转发帧**，必要时还进行链路层上的**协议转换**

   注意：存储转发类设备都能进行协议转换，即**连接的两个网段可以使用不同的协议**

4. 网桥对接收到的帧**不做任何修改**，或只对帧的**封装格式做很少的修改**

5. 网桥应有足够大的缓冲空间，因为在短时间内帧的到达速率可能高于转发速率

网桥的优点：

1. 能过滤通信量
2. 扩大了物理范围
3. 可使用不同的物理层
4. 可互联不同类型的局域网
5. 提高了可靠性
6. 性能得到改善

网桥的缺点：

1. 增大了时延
2. MAC 子层**没有流量控制功能**，流量控制是 LLC 子层的
3. 不同 MAC 子层的网段桥接在一起时，需要进行**帧格式的转换**
4. **只适合于用户数不多和通信量不大的局域网**，否则广播信息太多而产生网络拥塞（广播风暴）

根据路径选择算法的不同，可将网桥分为透明网桥和源路由网桥

#### 透明网桥（非最佳路由）

接收与之连接的所有 LAN 传送的每一帧，到达帧的路由选择过程取决于源 LAN 和目的 LAN：

1. 如果源 LAN 和目的 LAN **相同，那么丢弃该帧**
2. 如果源 LAN 和目的 LAN **不同，那么转发该帧**
3. 如果目的 LAN **未知，那么扩散该帧**（广播）

当网桥刚连接到以太网时，其转发表是空的，网桥按照自学习算法处理收到的帧

该算法的基本思想是：

1. 网桥**每收到一个帧**，就记下其**源地址和进入网桥的端口**，作为转发表中的一个项目（源地址、进入的接口和时间）
2. 网桥转发帧是先根据目的地址**查找转发表**，如果找到就**直接转发**，如果没有就**向其他端口广播出去**

为了**避免转发的帧在网络中兜圈子**，透明网桥使用了一种**生成树算法**，以确保每个源到每个目的地**只有唯一的路径**

生成树使得整个扩展局域网**在逻辑上形成树形结构**，所以工作时逻辑上没有环路，但**生成树一般不是最佳路由**

额外：每过一段时间会刷新转发表，刷新后就要重新学习，这是为了防止 MAC 地址更换，造成冲突

#### 源路由网桥（最佳路由）

在源路由网桥中，**路由选择由发送数据帧的源站负责**，网桥只根据数据真正的路由信息对帧进行接收和转发

源路由网桥**对主机是不透明**的，主机必须通过发送发现帧来选择路由

源路由的生成过程是：

1. 在**未知路径**前，源站要先**发送一个发现帧**
2. 途中的每个网桥**都转发此帧**，最终可能从多个途径到达目的站
3. 目的站**都响应应答帧**，每个应答帧将通过**原路径返回**
4. 途经的网桥把自己的标志记录在应答帧中
5. 源站选**择出一个最佳路由**（时间最短或路由最短）
6. 以后凡是该源站向该目的站发送帧，帧头都**携带这一路由信息**

发送帧还可以帮助源站确定整个网络可以通过的帧的最大长度，但若**发现帧的数量太多，可能会使网络严重拥塞**

#### 两种网桥的比较

- 源路由网桥：**利用最佳路由**，若在两个以太网之间使用并联的源路由网桥，则**使通信量较平均地分配给每个网桥**
- 透明网桥：**使用生成树**，不能保证所用的路由是最佳的，也不能在不同的链路中进行负载均衡

注意：最佳路由是**发送帧往返时间最短的路由**时，才能**负载平衡**；往返时间长说明某个路由器超载了，那就换时间短的路

### 局域网交换机及其工作原理

#### 局域网交换机

桥接器的任一时刻通常只能执行**一个帧的转发操作**；局域网交换机，也称以太网交换机在任一时刻可以执行**多个帧转发**

以太网交换机是**一个多端口的网桥**，它工作在**数据链路层**，能将网络**分成小的冲突域**，为每个工作站提供更高的带宽

以太网交换机**对工作站是透明的**，因此管理开销低廉，简化了网络结点的增加、移动和网络变化的操作

利用以太网交换机还可以方便地实现**虚拟局域网** Virtual LAN，VLAN 可以**隔离冲突域和广播域**

注意：一般的交换机是链路层设备没有 IP 的，但三层交换机是网络层设备，需要配 IP

#### 原理

检测从以太端口来的数据帧的目的和源的 MAC 地址，然后在动态查找表进行查找并转发

若数据帧的 MAC 地址不在查找表中，则将该地址加入查找表，然后广播出去

#### 特点

以太网交换机的特点如下：

1. 以太网交换机的每个端口都**直接与单台主机相连**，而网桥端口连接的是网段，并且工作在**全双工方式**
2. 以太网交换机**能同时连通许多对端口**，使每对相互通信的主机都能**无碰撞地传输数据**
3. 以太网交换机和透明网桥一样是一种**即插即用设备**，其**转发表是通过自学习算法逐渐建立起来的**
4. 以太网交换机由于使用了专用的交换结构芯片，因此交换速率较高
5. 以太网交换机独占传输媒体的带宽

对于 `10Mb/s` 带宽的以太网，若有 N 个用户，使用以太网交换机：

- 如果是半双工通信：**每个端口的带宽是 `10Mb/s`，交换机的总容量为 `N × 10Mb/s × 0.5`**
- 如果是全双工通信：**每个端口的带宽是 `20Mb/s`，交换机的总容量为 `N × 10Mb/s`**

以太网交换机一般都**具有多种速率的端口**，如具有 `10Mb/s、100Mb/s、1Gb/s` 的端口的组合，方便了各种不同情况的用户

#### 两种交换模式

以太网交换机主要采用两种交换模式：

1. 直通式交换机：**只检查帧的目的地址**，这使得帧在接收后几乎能马上被传出去

   这种方式**速度快**，但缺乏智能性和安全性，也无法支持具有不同速率的端口的交换，转发时只有 **6 字节的转发延迟**

2. 存储转发式交换机：将接收到的帧**缓存到高速缓存器**中，并**检查数据是否正确**，正确才将该帧发送出去，否则丢弃

   存储转发式的优点是**可靠性高**，并能支持不同速率端口间的转换，缺点是**延迟较大**，转发时有**整个帧长的转发延迟**

#### 自学习功能

过滤：决定转发还是丢弃一个帧；转发：决定一个帧移动到哪个接口；过滤和转发借助于交换表完成的

交换表的一个表项包含：MAC 地址和对应的接口；如下图，以太网交换机有 4 个接口，各连一台计算机

![image-20220817204503308](..\images\image-20220817204503308.png)

首先 A 向 B 发送一帧，先从接口 1 发给交换机：

- 交换机**把 A 的 MAC 和其接口 1 放入交换表**，并找 MAC 地址为 B 的表项
- 找不到对应表项，向其他接口广播发出去（只有 B 检查目的地址后会接受，C 和 D 会丢弃）

然后 B 通过接口 3 向 A 发送一帧：

- 交换机把 B 的 MAC 和其接口 3 放入交换表，查交换表直接把帧转发到接口 1

交换表中的**每个表项都设有一定的有效时间**，过期的表项会自动删除，因为交换机**所连的主机会随时变化**

### 冲突域和广播域

冲突域，碰撞域：一块网卡发送信息时，只要有可能和另一块网卡冲突，**可能发送冲突的网卡的集合**

广播域：一块网卡发出一个广播时，**能收到这个广播的所有网卡的集合**

一般来说，一个网段就是一个冲突域，一个局域网就是一个广播域

![image-20211208202720343](..\images\image-20211208202720343.png)

# 网络层

## 网络层的功能

互联网在网络层的设计思路是，向上只提供**简单灵活的、无连接的**、尽最大努力交付的数据报服务（**不可靠**）

如果主机中的进程之间的通信需要是可靠的，那么可以**由更高层的传输层来负责**

采用这种设计思路的好处是：网络的**造价大大降低**，运行方式灵活，能够适应多种应用

互联网能够发展到今日的规模，充分证明了当初采用这种设计思想的正确性

### 异构网络互联

要在全球范围内把数以百万计的网络互联起来，并且能够互相通信，是一项非常复杂的任务，要解决许多问题

用户的需求是多样的，没有一种单一的网络能适应所有用户的求；**网络层需要将这些异构的网络实现互联**

网络互联：<u>将多个计算机网络，通过一定的方法，用通信处理设备（即中间设备）相互连接起来</u>，构成更大的网络系统

中间设备又称中间系统或中继系统，根据所在的层次，中继系统分为以下 4 种：

1. 物理层中继系统：**中继器，集线器 Hub**
2. 数据链路层中继系统：**网桥或交换机**
3. 网络层中继系统：**路由器**
4. 网络层以上的中继系统：**网关**

物理层或数据链路层的中继系统，**把一个网络扩大了**，但从网络层的角度看，它**仍然是同一个网络**，不能称之为网络互联

网络互联指用<u>路由器进行网络互联和路由选择</u>，路由器是一台专用计算机，用于在互联网中进行路由选择

注意：由于历史原因，许多有关 TCP/IP 的文献也把网络层的路由器称为网关

TCP/IP 在网络互联上的做法是在**网络层（IP 层）采用标准化协议**，但**相互连接的网络可以是异构的**

计算机网络通过一些路由器进行互联，且都**使用相同的网际协议 IP**，可以把互联后的计算机网络视为一个虚拟 IP 网络

![image-20211208214938510](..\images\image-20211208214938510.png)

虚拟互联网络就是**逻辑互联网络**，即虽然物理网络的**异构性是存在的**，但是**通过 IP 就可以在网络层上让它们看起来是一个网络**，这种使用 IP 的虚拟互联网络可简称为 IP 网络

虚拟互联网络的好处是：当互联网上的主机进行通信时，就好像在一个网络上通信一样，看不见互联的具体的网络异构细节

选择题：要求路由器互联的多个局域网的**物理层、数据链路层、网络层可以不同，但高层要相同**，因为路由器不能处理高层

### 路由与转发

路由器主要完成两个功能：路由选择：确定转发路径；分组转发：分组到达时所采取的动作

1. 路由选择：按照复杂的分布式算法，根据相邻路由器所得到的关于整个网络拓扑的变化情况，**动态地改变所选择的路由**
2. 分组转发：指路由器**根据转发表**将用户的 IP 数据报**从合适的端口转发出去**

路由表是根据路由选择算法得出的，而**转发表是从路由表得出的**

转发表的结构使**查找过程最优化**，路由表则需要对**网络拓扑变化的计算最优化**

在讨论路由选择的原理时，往往不去区分转发表和路由表，而是笼统地使用路由表一词

### SDN 的基本概念

将网络层抽象地划分为数据层面和控制层面：**转发是数据层面实现的功能，路由选择是控制层面实现的功能**

软件定义网络 SDN，采用集中式的控制层面和分布式的数据层面，两个层面相互**分离**

![image-20220818195701580](..\images\image-20220818195701580.png)

传统互联网与 SDN 的对比：

- 传统：路由选择算法运行在每台路由器中，每台路由器**都有转发和路由选择两种功能**

- SDN：控**制平面从路由器物理上分离**，路由器仅实现转发，远程控制器计算和分发转发表以供每台路由器所使用

  路由器给远程控制器（多个服务器组成）发送路由选择信息，远程控制器计算完成后发送转发表（流表）给路由器

路由器中的路由选择控制器的作用：

- 传统：执行路由选择协议，为路由器**计算转发表**
- SDN：与远程控制器通信，发送信息和**接收转发表**

![image-20220818204317650](..\images\image-20220818204317650.png)

SDN 的控制平面的组成：

- SDN 控制器：**维护准确的网络状态信息**，并提供给网络控制应用程序（逻辑集中，在多台服务器上实现）
- 网络控制应用程序：使用 SDN 控制器提供的方法，监视、编程和控制下面的网络设备

SDN 控制器的三个层次：

1. 对于网络控制应用程序的接口：网络控制应用程序使用**北向接口**与 SDN 控制器交互，在状态管理层之间读写网络状态
2. 网络范围状态管理层：由 SDN 控制平面决定，**对有关网络的主机、链路等最新状态信息进行管理**
3. 通信层：SDN 控制器通过**南向接口**与受控网络设备之间的通信（`OpenFlow` 协议）

SDN 控制器集群内部控制器之间的通信接口称为东西向接口，用于增强整个控制层面的可靠性和可拓展性

SDN 的优点：

1. 全局集中式控制和分布式高速转发，利于**控制层面的全局优化**和**高性能的网络转发**
2. **灵活可编程与性能的平衡**，控制和转发功能分离后，使得网络可以由专有的自动化工具以编程方式配置
3. 控制和数据层面分离后，网络设备的制造与功能软件的开发相分离，**有效降低了成本**

SDN 的问题：

1. **安全风险**，集中管理容易受攻击，如果崩溃，整个网络会受到影响
2. **瓶颈问题**，原本分布式的控制层面集中化后，随着网络规模扩大，控制器可能成为网络性能的瓶颈

SDN 把整个互联网都改造成集中控制模式，是不现实的，但在某些具体条件下，使用 SDN 可以使网络的运行效率更高

### 拥塞控制

在通信子网中，因出现过量的分组而引起网络性能下降的现象称为**拥塞**

当路由器速率 $r_m$ 接近带宽 R 时，平均时延急剧增加，大量的分组被丢弃（路由缓冲有限），整个网络的吞吐量会骤降

![image-20211208215140345](..\images\image-20211208215140345.png)

判断网络是否进入拥塞状态的方法是，**观察网络的吞吐量与网络负载的关系**：

- 随着网络负载的增加，网络的吞吐量也增加，但明显**小于正常的吞吐量**，那么网络就可能已进入**轻度拥塞状态**
- 吞吐量随着网络负载的**增大而下降**，那么网络就可能已进入**拥塞状态**
- 网络的负载继续增大，而网络的吞吐量**下降到零**，那么网络就可能已进入**死锁状态**

拥塞控制主要解决的问题是如何**获取网络中发生拥塞的信息**，从而利用这些信息进行控制

拥塞控制的作用是确保子网能够承载所达到的流量，这是一个**全局性的过程**，单一地增加资源并不能解决拥塞

流量控制和拥塞控制的区别：

- 流量控制：在发送端和接收端之间的**点对点通信量**的控制，如抑制发送端发送数据的速率，以便使接收端来得及接收
- 拥塞控制：确保通信子网能够传送待传送的数据，是一个**全局性的问题**

拥塞控制的方法有两种：

1. 开环控制：**事先将有关发生拥塞的因素考虑周到**，力求网络在工作时不产生拥塞

   一种**静态的预防方法**，一旦整个系统启动并运行，中途就不再需要修改，做决定时**不考虑当前网络的状态**

   开环控制手段包括确定何时可接收新流量、何时可丢弃分组及丢弃哪些分组，确定何种调度策略等

2. 闭环控制：**事先不考虑有关发生拥塞的各种因素**，采用监测网络系统去监视，**是一种动态的方法**

   及时检测哪里发生了拥塞，然后将拥塞信息传到合适的地方，以便调整网络系统的运行，并解决出现的问题

## 路由算法

### 静态路由与动态路由

路由器转发分组是通过路由表转发的，而路由表是通过各种算法得到的

从能否随网络的通信量或拓扑自适应地进行调整变化来划分，路由算法可以分为如下两大类：

1. 静态路由算法，非自适应路由算法：**由网络管理员手工配置的路由信息**

   当发生变化时，网络管理员需要手工去修改路由表中相关的静态路由信息，用于简单的小型网络

   优点：简便和开销较小，在**拓扑变化不大的小网络中运行效果很好**

2. 动态路由算法，自适应路由算法：指路由器上的路由表项是**按照一定的算法计算出来的**，且会**不断更新**

   优点：改善网络的性能并有助于流量控制；缺点：算法复杂，**增加网络的负担**

常用的动态路由算法可分为两类：距离-向量路由算法和链路状态路由算法

### 距离-向量路由算法

距离-向量路由算法中，所有结点都**定期**地将它们的**整个路由选择表**传送给所有与之**直接相邻的结点**

这种路由选择表包含：每条路径的目的地；路径的代价，也称距离

这种算法中，**所有结点都必须参与距离向量交换**，以保证路由的有效性和一致性，在下列情况更新它们的路由选择表：

1. **被通告一条新的路由**，该路由在本结点的路由表中不存在，此时本地系统**加入这条新的路由**
2. 被通告一条已有路由，但通告的路由**距离更短，则替换原有路由**

距离-向量路由算法的实质：**迭代计算一条路由中的站段数或延迟时间**，从而得到到达一个目标的最短通路

- 第一次交换得到 1 跳的路由信息，第 n 此交换得到 n 跳的路由信息

**更新报文的大小与通信子网的结点个数成正比**，大的通信子网将导致很大的更新报文，因此**适合于小型网络**

最常见的距离-向量路由算法是 RIP 算法，它采用跳数作为距离的度量

### 链路状态路由算法

链路状态路由算法：每个参与该算法的结点都**具有完全的网络拓扑信息**，它们执行下述两项任务：

1. **主动测试所有邻接结点的状态**，两个共享一条链接的结点是相邻结点
2. **定期地将链路状态传播给所有其他结点**；典型的链路状态算法是 OSPF 算法

每个结点都用这种方式从网上所有其他的结点接收包含直接链路状态的路由选择信息

- 每个结点都群发连接的链路状态，因此**每个结点都会接受到整个网络的拓扑消息**，使用 Dijkstra 计算路由表

一旦链路状态发生变化，结点就对更新的网络图**利用 Dijkstra 最短路径算法重新计算路由**

链路状态路由算法主要有三个特征：

1. 向本自治系统中**所有路由器**发送信息，这里使用的方法是**泛洪法**
2. 发送的信息是**与路由器相邻的所有路由器的链路状态**，但这只是路由器所知道的部分信息
3. 只有当**链路状态发生变化时，路由器才向所有路由器发送此信息**

链路状态路由算法的主要优点是：

1. 每个路由结点都使用同样的原始状态数据独立地计算路径，而**不依赖中间结点的计算**
2. 链路状态报文不加改变地传播，因此采用该算法易于查找故障
3. 当一个结点从所有其他结点接收到报文时，它可以**在本地立即计算正确的通路**，保证一步汇聚
4. 链路状态**报文大小只与邻接结点数有关**，因此链路状态算法比距离-向量算法有更好的规模可伸展性

距离-向量路由算法与链路状态路由算法的比较：在距离-向量路由算法中，每个结点仅与它的**直接邻居**交谈；在链路状态路由算法中，每个结点通过广播的方式与**所有其他结点**交谈；相比之下，距离-向量路由算法有可能遇到**路由环路**等问题

### 层次路由

因特网**将整个互联网划分为许多较小的自治系统**（包含多个局域网），每个自治系统**决定本系统内使用的路由选择协议**

如果两个自治系统需要通信，那么就需要一种在两个自治系统之间的协议来屏蔽这些差异

因特网把路由选择协议划分为两大类：

1. **自治系统内部使用**的路由选择协议称为**内部网关协议 `IGP`**，也称域内路由选择，具体的协议有 RIP 和 OSPF 等
2. **自治系统之间使用**的路由选择协议称为**外部网关协议 `EGP`**，也称域间路由选择，处理自治系统间的交换，具体的协议有 `BGP`

使用层次路由时，使用 OSPF **把一个自治系统再划分为多个区域**，每个路由器都**仅知道在本区域内转发的细节**

划分区域会令交换信息种类增多，和 OSPF 更复杂，但使区域内部交换路由信息的通信量大大减小，因而使 OSPF 协议能够用于规模很大的自治系统中

## IPv4

### IPv4 分组

#### IPv4 分组的格式

一个 IP 分组由首部和数据部分组成，首部**前一部分的长度固定，共 `20B`**，是所有 IP 分组必须具有的

在首部固定部分的后面是一些可选字段，其长度可变，用来提供错误检测及安全等机制

![image-20211210135127303](..\images\image-20211210135127303.png)

IP 首部的部分重要字段含义如下：

1. 版本：指 IP 的版本，目前广泛使用的版本号为 4

2. 首部长度：**以 `32bit` 为单位**，最大值为 `60B`，常用的首部长度是 `20B` 即 101

3. 总长度：**首部和数据之和的长度，单位为字节**，数据报的最大长度为 `65535B`

4. 标识：一个计数器，每产生一个数据报就加 1，并赋值给标识字段（不是序号，分片用的）

5. 标志：

   标志字段的**最低**位为 `MF`，**`MF` = 1 表示后面还有分片，`MF` = 0 表示最后一个分片**

   标志字段**中间**的一位是 `DF`，只有当 **`DF` = 0 时才允许分片**

6. 片偏移：较长的分组在分片后，**某片在原分组中数据部分的相对位置**，片偏移**以 8 个字节为偏移单位**

7. 生存时间 TTL：数据报在网络中**可通过的路由器数的最大值**，确保分组**不会永远在网络中循环**

   路由器在**转发分组前，先把 TTL 减 1**（重新计算首部校验和），若 TTL 被减为 0，则该分组必须丢弃

8. 协议：指出此分组携带的数据**使用何种协议**

   ![image-20211210142601351](..\images\image-20211210142601351.png)

9. 首部校验和：IP 数据报的首部校验和**只校验分组的首部**，而不校验数据部分

10. 源地址字段：标识发送方的 IP 地址

11. 目的地址字段：标识接收方的 IP 地址

#### IP 数据报分片

一个数据链路层数据报能承载的最大数据量称为最大传送单元 MTU

IP 的数据报最终会封装成帧，**数据报大于 MTU 时就要分成多份**，这就是给数据报**分片**

为了让接收方可以把拆开的数据报可以合起来，让它们**每个都带个 IP 头**，形成的小 IP 数据报叫做**片**

- 创建一个 IP 数据报时，源主机为该数据报**加上一个标识号**
- 当一个**路由器或主机**需要将一个数据报**分片**时，形成的每个数据报**都具有原始数据报的标识号**
- **目的主机**收到来自同一发送主机的一批数据报时，**检查数据报的标识号来确定属于同一个原始数据报的片**
- **目的主机**在对片进行**重组**时，**使用片偏移字段来确定片应放在原始 IP 数据报的哪个位置**

如一个长 `4000B` 的 IP 数据报，首部部分 `20B` 数据部分 `3980B` 到达一个路由器，需要转发到一条 MTU 为 `1500B` 的链路上，假定原始数据报的标识号为 777 那么分成的 3 片如下：

![image-20211210135331709](..\images\image-20211210135331709.png)

额外：分片时会修改**总长度、标志、片偏移字段**；如上面第二个的总长度为 1500，标志为 001，片偏移为 185

注意：**数据部分必须是 8 的倍数**，如果不是可以少发一点凑够 8 的倍数，如 MTU=800 其中 20 为 IP 头，780 中只有 776 能用

#### 网络层转发分组的流程

在转发表中，每条路由必须有两条信息（目的网络，下一跳地址）

转发表中的两种特殊路由：

1. 主机路由：用 **`a.b.c.d/32` 表示主机路由**，`a.b.c.d` 是特定主机的 IP，**前缀最长**，用于管理员控制和测试网络
2. 默认路由：用 **0.0.0.0/0 表示默认路由**，目的网络不在转发表时使用

网络层的路由器执行的分组转发算法如下：

1. 从数据报的首部提取目的主机的 IP 地址 D，得出目的网络地址 N

2. 若网络 N 与此路由器**直接相连**，则直接交付给目的主机 D，这称为路由器的直接交付；否则是间接交付，执行步骤 3

   思考：**直接交付**指目的网络在与路由器直接连接的网络中，**不需要转发**；**间接交付**指**需要给其他路由器转发**

3. 若路由表中有目的地址为 D 的**特定主机路由**，则交付给路由表中所指明的下一跳路由器；否则，执行步骤 4

4. 若路由表中有**到达网络 N 的路由**，则交付给路由表指明的下一跳路由器；否则，执行步骤 5

5. 若路由表中有一个**默认路由**，则交付给路由表中所指明的默认路由器；否则，执行步骤 6

6. 报告转发分组出错

注意：这里拿到的下一条地址**用来转换成 MAC 地址进行通信**，而且如果使用的是 PPP 协议的话，直接通过对应的端口转发

注意：路由器转发时，MAC 帧中的源地址和目的地址**会发生变化**，而网桥在转发时**不会**

注意：路由表中，**到互联网的路由使用默认路由**，到局域网内某一特定主机使用主机路由

#### IPv4 地址与 NAT

##### IPv4 地址

IP 地址：连接到因特网上的**每台主机或路由器的一个 32 比特的唯一标识符**，IP 地址又分为 A、B、C、D、E 五类

无论哪类 IP 地址，都由**网络号和主机号**两部分组成，即 IP 地址 = {<网络号>, <主机号>}

**网络号标志主机或路由器所连接到的网络**，它在整个因特网范围内必须是唯一的

**主机号标志该主机或路由器**，它在所在的网络内是唯一的

![image-20211210135515811](..\images\image-20211210135515811.png)

在各类 IP 地址中，有些 IP 地址具有特殊用途，不用做主机的 IP 地址：

- 主机号全为 0 表示**本网络本身**，都不能做

- 主机号全为 1 表示**本网络的广播地址**，又称直接广播地址，只能做目的地址

- 网络号全为 0 表示**本网络内某个特定主机**，只能做源地址

- 127.0.0.0 保留为环回自检地址，此地址**表示任意主机本身**，都可以做

  目的地址为环回地址的 IP 数据报永远不会出现在任何网络上

- 32 位全为 0 表示本**网络上的本主机**，只能做源地址

- 32 位全为 1 表示**整个 TCP/IP 网络的广播地址**，又称受限广播地址，只能做目的地址

  实际使用时，由于路由器对广播域的隔离，255.255.255.255 等效为本网络的广播地址

常用的三种类别 IP 地址的使用范围如下：

![image-20211210135552518](..\images\image-20211210135552518.png)

每类地址的**网络号不可委派而减 1**，用于表示本网络内某个特定的主机；A 类网络因为 **127 被占用所以减 2**

IP 地址有以下重要特点：

1. 每个 IP 地址都由网络号和主机号两部分组成，是一种**分等级的地址结构**，分等级的好处是：

   1. **IP 地址管理机构只分配网络号**，而主机号由**该网络的单位自行分配**，方便了 IP 地址的管理
   2. 路由器**仅根据网络号来转发分组**，从而减小了路由表所占的存储空间

2. IP 地址是**标志一台主机或路由器和一条链路的接口**

   一台主机同时连接到两个网络时，该主机就必须**同时具有两个不同网络号的 IP 地址**，路由器也是一样

3. 用转发器或桥接器连接的若干 LAN 仍然是同一个网络，IP 地址的网络号必须相同，但主机号必须不同

4. 在 IP 地址中，**所有分配到网络号的网络都是平等的**

5. **同一个局域网**上的主机或路由器的 IP 地址中的**网络号必须一样**；路由器的**每个端口都有一个不同网络号的 IP 地址**

##### 网络地址转换

网络地址转换 NAT 是指**通过将专用网络地址转换为公用地址从而对外隐藏内部管理的 IP 地址**

它使得整个专用网只需要一个全球 IP 地址就可以与因特网连通，它隐藏了内部网络结构，降低内部网络受到攻击的风险

划出了部分 IP 地址为私有 IP 地址，**私有 IP 地址只用于 LAN**，并且**允许私有 IP 地址被重用**，有效解决 IP 地址不足的问题

私有IP地址网段如下：

- A类：1 个 A 类网段，即 **10**.0.0.0 ~ **10**.255.255.255
- B类：16 个 B 类网段，即 **172.16**.0.0 ~ **172.31**.255.255
- C 类：256 个 C 类网段，即 **192.168.0**.0 ~ **192.168.255**.255

在因特网中的所有路由器，**对目的地址是私有地址的数据报一律不进行转发**

这种采用私有 IP 地址的互联网络称为**专用互联网或本地互联网**，私有 IP 地址也称**可重用地址**

使用 NAT 时需要在专用网连接到因特网的路由器上**安装 NAT 软件**，NAT 路由器**至少有一个有效的外部全球地址**

使用本地地址的主机和外界通信时，NAT 路由器使用 NAT 转换表**将本地地址转换成全球地址**，或**将全球地址转换成本地地址**

NAT 转换表中存放着 {本地 IP 地址: 端口} 到 {全球 IP 地址: 端口} 的映射，让**多个私有 IP 地址映射到同一个全球 IP 地址**

注意：普通路由器在转发 IP 数据报时，**不改变源 IP 和目的 IP**；NAT 路由器在转发 IP 数据报时，**一定更换 IP 地址**

![image-20220819190001255](..\images\image-20220819190001255.png)

NAT 路由器的工作原理：

1. 主机 `10.0.0.1:3345` 向服务器 `128.119.40.186:80` 发送请求
2. NAT 路由器收到 IP 分组后，将 IP 分组的源地址更改为 `138.76.29.7:5001`，并在 NAT 转换表中增加一个表项
3. 服务器处理请求后，发送响应给 `138.76.29.7:5001`
4. 响应分组到达 NAT 路由器后，查找 NAT 转换表，修改目的地址为 `10.0.0.1:3345` 并转发

思考：要让一台内网的服务器被外界访问，就必须在路由器之间配置好 NAT 转换表，把服务器的端口映射出去

选择题：NAT 表项需要管理员添加，若主机发送的分组在 NAT 表项中找不到，则不转发丢弃

### 子网划分与子网掩码、CIDR

#### 子网划分

在 IP 地址中又增加了一个子网号字段，使两级 IP 地址变成了三级 IP 地址，这种做法称为**子网划分**

子网划分的基本思路如下：

- 子网划分纯属一个单位内部的事情，单位对外仍然表现为没有划分子网的网络

- **从主机号借用若干比特作为子网号**，三级 IP 地址的结构如下：IP 地址 = {**<网络号>, <子网号>, <主机号>**}

- 其他网络根据 IP 数据报的目的网络号，先发送给连接到本单位网络上的路由器

  该路由器收到 IP 数据报后，按目的网络号和子网号找到目的子网，把 IP 数据报直接交付给目的主机

注意：

1. 划分子网不改变 IP 地址原来的网络号，因此从一个 IP 地址本身或 IP 数据报的首部，其网络看不出是否进行了子网划分

2. RFC 950 规定，对分类的 IPv4 地址进行子网划分时，子网号不能为全 1 或全 0

   这是因为无法分清 192.168.1.255 是子网的广播还是本网络的广播，所以去掉子网号全 1 全 0 的情况

   无类别域间路由 CIDR 消除了 A/B/C 类型网络，就可以使用全 1 和全 0 了，但要注意路由器是否支持 CIDR

3. 不论是分类的 IPv4 地址还是 CIDR，其子网中的主机号为全 0 或全 1 的地址都不能被指派

   子网中**主机号全 0 的地址为子网的网络号，主机号全 1 的地址为子网的广播地址**

选择题：使用变长子网划分，得到的最小子网的可分配 IP 地址数最少，而最长划分就是等分

- 变长子网划分：指 0、10、110、111 这样的划分方式

#### 子网掩码

使用子网掩码来表达对原网络中主机号的借位，子网掩码长 `32bit` 的二进制串，它由一串 1 和跟随的一串 0 组成

其中 1 对应于 IP 地址中的网络号及子网号，而 0 对应于主机号，**将 IP 地址和子网掩码逐位与，可得出子网的网络地址**

因特网标准规定：**所有的网络都必须使用子网掩码**，如果一个网络未划分子网，那么就采用默认子网掩码，<u>A、B、C 类地址的默认子网掩码分别为 255.0.0.0、255.255,0.0、255.255.255.0</u>

路由器在相互之间**交换路由信息时子网掩码也要告诉对方**

在使用子网掩码的情况下：

1. 一台主机在设置 IP 地址信息的同时，必须设置子网掩码
2. 同属于一个子网的**所有主机及路由器的相应端口**，必须设置相同的子网掩码
3. 路由器的路由表中，所包含信息的主要内容必须有目的**网络地址、子网掩码、下一跳地址**

使用子网掩码时路由器的分组转发算法如下：

1. 从收到的分组的首部提取目的 IP 地址，记为 D
2. **用各相邻的网络的子网掩码和 D 逐位相与**，若**与其网络地址匹配**，则将分组直接交付，否则间接交付，执行 3
3. 若路由表中有目的地址为 D 的**特定主机路由**，则转发给路由表中所指明的下一跳路由器，否则，执行 4
4. 对路由表中的**每一行的子网掩码和 D 逐位相与**，若结果**与该行的网络地址匹配**，则转发给下一跳路由器；否则，执行 5
5. 若路由表中有一个默认路由，则转发给**默认路由器**；否则，执行 6
6. 报告转发分组出错

#### 无分类编址 CIDR

无分类域间路由选择是一种**消除传统 A、B、C 类网络划分**，可以在软件的支持下**实现超网构造**的一种地址的划分方法

它可以大幅度提高 IP 地址空间的利用率，减小路由器的路由表大小，提高路由转发能力

CIDR 的主要特点如下：

1. 消除了传统 A、B、C 类地址及划分子网的概念，因而可以更有效地分配 IPv4 的地址空间
   
   CIDR **使用网络前缀的概念代替子网络**的概念，IP 地址的无分类两级编址为：IP ={<网络前缀>, <主机号>}
   
   CIDR 还使用斜线记法，即 **IP 地址/网络前缀所占比特数**，网络前缀所占比特数是**子网掩码中连续 1 的个数**
   
   对于 128.14.32.5/20 这个地址，通过逐位相与的方法得到该地址的网络前缀：
   $$
   逐位与\left\{\begin{matrix}IP=10000000.00001110.00100000.0000011\\掩码=11111111.11111111.11110000.00000000\end{matrix}\right.
   \\网络前缀=10000000.00001110.00100000.00000000（128.14.32.0）
   $$
   **分配到一个 CIDR 地址块的组织，仍可以在本组织内根据需要再划分出一些子网**
   
   如某组织分配到地址块/20，再继续划分为 8 个子网后，每个子网的网络前缀是 23 位，全 0 和全 1 的主机地址不使用
   
2. **将网络前缀都相同的连续 IP 地址组成 CIDR 地址块**，这种地址的聚合称为**路由聚合**或**构成超网**

   路由聚合让**路由表的一个项目表示多个传统分类地址的路由**，减少路由器之间的路由选择信息的交换，提高网络性能

如下图：`R1` 有到网络 1、2 的两个路由表项，**下一跳都是 `R2`**，所以使用路由聚合合并位一个路由表项 `206.1.0.0/16`

![image-20211210140053130](..\images\image-20211210140053130.png)

CIDR 地址块中的地址数一定是 **2 的整数次幂**，实际可指派的地址数通常为 $2^N-2$，N 表示主机号的位数

优点：网络前缀长度的灵活性；上层网络的路由表的项目较少；内部又可采用延长网络前缀的方法来灵活地划分子网

最长前缀匹配，最佳匹配：使用 CIDR 时，路由表中的每个项目由网络前缀和下一跳地址组成：

- 若**在查找路由表时得到不止一个匹配结果，就选择网络前缀最长的那一个**（地址块越小，路由越具体）

CIDR 查找路由表的方法：为了更加有效地查找最长前缀匹配，将无分类编址的路由表存放在一种**层次式数据结构**中，然后自上而下地按层次进行查找，常用的是二叉线索

### ARP、DHCP 与 ICMP

#### IP 地址与硬件地址

IP 地址是网络层使用的地址，它是**分层次等级的**；硬件地址是数据链路层使用的地址，它是**平面式的**

通过数据封装，把 IP 数据报分组封装为 MAC 帧后，数据链路层看不见数据报分组中的 IP 地址

**在网络层使用 IP 地址来完成寻址**，而**在目标 LAN 中通过数据链路层的 MAC 地址以广播方式寻址**，以提高路由选择的效率

1. 在 IP 层抽象的互联网上只能看到 IP 数据报
2. 路由器只**根据目的 IP 地址的网络号进行路由选择**
3. 在局域网的数据链路层，只能看见 MAC 帧，因此 IP 数据报在被路由器转发时，**帧的 MAC 地址是不断改变**的
4. 尽管互联在一起的网络的硬件地址体系各不相同，但 **IP 层抽象的互联网却屏蔽了下层这些复杂的细节**

注意：路由器由于互联多个网络，因此它不仅**有多个 IP 地址，也有多个硬件地址**

#### 地址解析协议 ARP

在实际网络的链路上传送数据帧时，**必须使用硬件地址**，因此使用**地址解析协议 ARP 来完成 IP 地址到 MAC 地址的映射**

每台主机都设有 **ARP 高速缓存**，用来存放**本局域网上**各主机和路由器的 **IP 地址到 MAC 地址的映射表**，称 ARP 表

ARP 工作在网络层，主机 A 向本局域网的主机 B 发送 IP 数据报的过程：

1. 先**在 ARP 高速缓存中查看有无主机 B 的 IP 地址**，有就将此硬件地址写入MAC 帧，并把 MAC 帧发往此硬件地址
2. 若没有，就把帧的**目的 MAC 地址设为 FF-FF-FF-FF-FF-FF**（广播地址） 并**广播 ARP 请求分组**，里面包含 B 的 IP
3. B 收到该 ARP 请求后，对比 IP 发现是自己，**向 A 发出响应 ARP 分组**，包含 B 的 IP 与 MAC 地址的映射关系
4. 主机 A 在**收到后将此映射写入 ARP 缓存**，回到 1

额外：ARP 表每过一段时间会进行刷新，这是为了防止其他主机的 MAC 地址更换

注意：ARP 由于看到了 IP 地址，所以它工作在**网络层**；NAT 路由器由于看到了端口，所以它工作在**传输层**

ARP 的 4 种典型情况总结如下：

1. 主机发送 IP 数据报给本网络的主机：用 ARP **找到目的主机的硬件地址**
2. 主机发送 IP 数据报给另一个网络的主机：用 ARP 获取**网关路由器的硬件地址**，剩下的工作由该路由器来完成
3. 路由器发送 IP 数据报给本网络的主机：用 ARP **找到目的主机的硬件地址**
4. 路由器发送 IP 数据报给另一个网络的主机：用 ARP 获取**下一跳路由器的硬件地址**，剩下的工作由该路由器完成

从 IP 地址到硬件地址的解析是自动进行的，主机的用户并不知道这种地址解析过程

思考：谁发送数据帧源 MAC 地址就是谁；要把数据帧发送给谁，目的 MAC 地址就是谁；PPP 协议除外

思考：<u>通过子网掩码发现不是同一网络时，用网关 IP 拿到 MAC 地址，然后把数据报转发给网关</u>

#### 动态主机配置协议 DHCP

动态主机配置协议：**给主机动态地分配 IP 地址**，它提供了即插即用的联网机制，DHCP 是**基于 UDP 的应用层协议**

DHCP 的工作原理如下：

1. C/S 方式，需要 IP 地址的主机**在启动时就向 DHCP 服务器广播发送发现报文**，源 IP 是 0.0.0.0 目的 IP 是 `FF.FF.FF.FF`
2. 广播域内主机都能收到此广播报文，但**只有 DHCP 服务器才回答此广播报文**
3. DHCP 服务器先**在其数据库中查找该计算机的配置信息**，若找到，则返回找到的信息
4. 若找不到，则**从服务器的 IP 地址池中取一个地址分配给该计算机**，DHCP 服务器的回答报文称为**提供报文**

DHCP 服务器和 DHCP 客户端的交换过程如下：

1. DHCP 客户机**广播 DHCP 发现消息**，试图找到网络中的 DHCP 服务器来获得一个 IP 地址

2. DHCP 服务器收到 DHCP 发现消息后，向网络中**广播 DHCP 提供消息**，包括提供客户机的 IP 地址和相关配置信息

3. DHCP 客户机收到 DHCP 提供消息后，如果**接受 DHCP 服务器所提供的相关参数**

   那么**广播 DHCP 请求消息**向 DHCP 服务器请求提供 IP 地址（让其他 DHCP 知道选择了谁）

4. DHCP 服务器**广播 DHCP 确认消息**，将 IP 地址分配给 DHCP 客户机

网络上有多台 DHCP 服务器时，DHCP 客户机发出的 DHCP 请求可能**收到多个应答消息**，DHCP 客户机**挑选最先到达的**

DHCP 服务器**分配给 DHCP 客户的 IP 地址是临时的**，因此 DHCP 客户只能在一段有限的时间内使用这个分配到的 IP 地址

DHCP 称这段时间为**租用期**，租用期的数值应由 DHCP 服务器自己决定，DHCP 客户也可提出对租用期的要求

DHCP 执行初期，**客户端不知道服务器端的 IP 地址**，执行中间，**客户端并未被分配 IP 地址**，所以采用广播的方式

连对方的 IP 地址都不知道，更不可能使用 TCP 连接，所以使用 UDP 协议（TCP 不能发广播，UDP 可以）

额外：只有应用层才有的两种工作方式：C/S 方式和 P2P 方式

#### 网际控制报文协议 ICMP

为了提高 IP 数据报交付成功的机会，在网络层使用了网际控制报文协议来**让主机或路由器报告差错和异常情况**

**ICMP 报文作为 IP 层数据报的数据**，加上数据报的首部，组成 IP 数据报发送出去，**ICMP 是 IP 层协议**

ICMP 报文的种类有两种：ICMP 差错报告报文和 ICMP 询问报文

##### ICMP 差错报告报文

**ICMP 差错报告报文用于**目标主机或到目标主机路径上的路由器**向源主机报告差错和异常情况**，共有以下 5 种类型：

1. 终点不可达：当路由器或主机**不能交付数据报**时，就向源点发送**终点不可达报文**

2. 源点抑制：当路由器或主机**由于拥塞而丢弃数据报**时，就向源点发送**源点抑制报文**，使源点把发送速率放慢

3. 时间超过：向源点发送**时间超过报文**

   当路由器**收到生存时间为零的数据报**时，丢弃该数据报

   当终点**在预先规定的时间内不能收到一个数据报的全部数据报片**时，丢弃已收到的数据报片

4. 参数问题：路由器或目的主机**收到的数据报的首部中有的字段的值不正确**时，丢弃该数据报，向源点发送**参数问题报文**

5. 改变路由：路由器把**改变路由报文**发送给主机，让主机知道下次应**将数据报发送给另外的（更好的）路由器**

不应发送 ICMP 差错报告报文的几种情况如下：

1. 对 **ICMP 差错报告报文**不再发送 ICMP 差错报告报文
2. 对**第一个分片的数据报片的所有后续**数据报片都不发送 ICMP 差错报告报文
3. 对**具有组播地址**的数据报都不发送 ICMP差错报告报文
4. 对**具有特殊地址**（如 127.0.0.0 或 0.0.0.0）的数据报不发送 ICMP 差错报告报文

##### ICMP 询问报文

ICMP 询问报文有：**回送请求和回答报文、时间戳请求和回答报文**、掩码地址请求和回答报文、路由器询问和通告报文

1. 回送请求和回答报文：收到此报文的主机必须给源主机发送回送回答报文，**测试目的站是否可达以及了解其相关状态**
2. 时间戳请求和回答报文：请某个主机或路由器回答当前的日期和时间，**进行时钟同步和测量时间**

ICMP 的两个常见应用是分组网间探测 PING 和 Traceroute：

- PING：用来测试两台主机之间的连通性，使用 ICMP **回送请求和回答报文**
- Traceroute：用来跟踪分组经过的路由，使用了 ICMP **时间超过报文**，通过发不同的 TTL 的数据报来跟踪

注意：PING 工作在应用层，它直接使用网络层的 ICMP，Traceroute/Tracert 工作在网络层

##### ICMP 报文的格式*

ICMP 报文的格式：

![image-20211211152011561](..\images\image-20211211152011561.png)

ICMP 差错报告报文格式：

![image-20211211151710543](..\images\image-20211211151710543.png)

## IPv6

### IPv6 的主要特点

解决 IP 地址耗尽问题的措施有以下三种：

1. 采用无类别编址 CIDR，使 IP 地址的分配更加合理
2. 采用网络地址转换 NAT 方法以节省全球 IP 地址
3. 采用具有更大地址空间的新版本的 IPv6，**从根本上解决了 IP 地址的耗尽问题**

IPv6 的主要特点如下：

1. 更大的地址空间：IPv6 将地址从 IPv4 的 32 位**增大到了 128 位**
2. 扩展的地址层次结构
3. 灵活的首部格式，**减少了首部条目，头部固定**，扩展头部在数据部分
4. 改进的选项
5. 允许协议继续扩充
6. 支持即插即用（即自动配置，不需要 DHCP）
7. 支持资源的预分配
8. **IPv6 只在包的源结点才能分片**，是端到端的，所以从一般意义上说，**IPv6 不允许分片**，若路由器接不能转发就丢弃
9.  **IPv6 首部长度必须是 `8B` 的整数倍**，而 IPv4 首部是 `4B` 的整数倍
10. 增大了安全性，身份验证和保密功能是 IPv6 的关键特征（**支持质量服务 `QoS`**）

虽然 IPv6 与 IPv4 不兼容，但总体而言它与所有其他的因特网协议兼容，只是在少数地方做了必要的修改

IPv6 相当好地满足了预定的目标，主要体现在：

1. IPv6 的地址用 16 个字节表示，从长远来看，**这些地址是绝对够用的**
2. 简化了 IP 分组头，它包含 8 个域，这一改变使得路由器能够更快地处理分组，从而可以改善吞吐率
3. **更好地支持选项**，一些从前必要的段现在变成了可选段。此外，表示选项的方式的改变还能加快分组的处理速度
4. IPv6 **将 IPv4 的校验和字段彻底移除**，以减少每跳的处理时间

### IPv6 地址

IPv6 数据报的目的地址可以是以下三种基本类型地址之一：

1. 单播：单播就是传统的点对点通信
2. 多播：多播是一点对多点的通信，分组被交付到一组计算机的每台计算机
3. 任播：任播的**目的站是一组计算机，但只交付给其中的一台计算机**，通常是距离最近的一台计算机

在 IPv6 地址表示：**每 4 位用一个十六进制数表示，并用冒号分隔 16 位**，如 `4BF5:AA12:0216:FEBC:BA5F:039A:BE9A:2170`

当 16 位域的开头有一些 0 时，可以采用一种缩写表示法，但在**域中必须至少有一个数字**

- 如把地址 `4BF5:0000:0000:0000:BA5F:039A:000A:2176` 缩写为 `4BF5:0:0:0:BA5F:39A:A:2176`

有相继的 0 值域时，这些域可以用双冒号缩写，但在**一个地址中仅能出现一次**，上面地址可以写成 `4BF5::BA5F:39A:A:2176`

IPv6 使用以下 3 个等级：

- 第一级：指明全球都知道的公共拓扑，顶级
- 第二级：指明单个场点，场点级
- 第三级：指明单个网络接口

IPv6 地址采用多级体系主要是为了使路由器能够更快地查找路由

IPv4 向 IPv6 过渡只能采用**逐步演进**的办法，同时还必须使新安装的 IPv6 系统能够<u>向后兼容</u>

IPv4 向 IPv6 过渡可以采用双协议栈和隧道技术两种策略：

- 双协议栈技术：在一台设备上**同时装有 IPv4 和 IPv6 协议栈**，有两个协议的地址，可以实现两个协议的通信
- 隧道技术：**将整个 IPv6 数据报封装到 IPv4 数据报的数据部分**，使得 IPv6 数据报可以在 IPv4 网络的隧道中传输

### IPv6 数据报格式*

![image-20211212110102062](..\images\image-20211212110102062.png)

头部大小 `40B`，红色部分，扩展头部在数据部分

1. 版本：IP 版本
2. 流标签：分片用的标识符
3. 有效载荷长度：有效载荷（扩展首部 + 数据）的长度
4. 下一个首部：下个首部的位置，首部与扩展首部用单链表连起来

## 路由协议

### 自治系统

自治系统 Autonomous System，AS：一个有权自主地决定在本系统中应采用各种路由协议的小型单位

有共同的协议与度量，一个自治系统的所有路由器**在本自治系统内都必须是连通的**

### 域内路由与域间路由

自治系统内部的路由选择称为**域内路由选择**，自治系统之间的路由选择称为**域间路由选择**

因特网有两大类路由选择协议：

1. 内部网关协议 Interior Gateway Protocol，`IGP`：**在一个自治系统内部使用的路由选择协议**，如 RIP 和 OSPF
2. 外部网关协议 External Gateway Protocol，`EGP`：**在多个自治系统间使用的路由选择协议**，如 BGP-4

下面是两个自治系统互联的示意图：

![image-20211212183506854](..\images\image-20211212183506854.png)

### 路由信息协议 RIP

路由信息协议 Routing Information Protocol，RIP 是内部网关协议中最先得到广泛应用的协议

RIP 是一种分布式的**基于距离向量**的路由选择协议，其最大优点就是简单

#### RIP 规定

1. 网络中的每个路由器都要维护**从它自身到其他每个目的网络的距离记录**，这组距离称为距离向量

2. 距离也称跳数，规定从一个路由器到**直接连接网络的距离为 1**，而**每经过一个路由器距离加 1**

3. RIP 认为好的路由就是它通过的路由器的数目少，即**优先选择跳数少的路径**

4. RIP 允许一条路径最多只能包含 15 个路由器，因此**距离等于 16 时，它表示网络不可达**

   规定路径上的最高跳数**防止数据报不断循环在环路上**，减少网络拥塞的可能性

   思考：主机发送数据给网关（路由器）网关一检查，目的主机距离为 15 中间 14 台路由器，则两主机间有 15 个路由器

5. RIP 默认**每 30 秒广播一次 RIP 路由更新信息**，以便**自动建立并维护路由表**

6. RIP 中不支持子网掩码的 RIP 广播；`RIP2` 中，支持变长子网掩码和 CIDR

#### RIP 的特点

1. 仅和**相邻路由器**交换信息
2. 路由器交换它**所知道的全部信息**，即自己的路由表
3. 按固定的时间间隔交换路由信息，如每隔 30 秒

RIP 通过距离向量算法来完成路由表的更新：

1. 最初，每个路由器只知道与自己直接相连的网络
2. 经过 1 次 RIP 广播后，每个路由器知道距离自己跳数为 1 的网络
3. 经过若干 RIP 广播后，**所有路由器都知道整个 IP 网络的路由表**，称 RIP 最终是**收敛的**
4. 通过 RIP 收敛后，每个路由器到每个目标网络的路由都是**距离最短的（跳数最短，不是时间最短）**

注意：通告：主动向别的路由器发信息；更新：每个路由器和隔壁交换信息

#### 距离向量算法

每个路由表项目都有三个关键数据：**<目的网络 N，距离 d，下一跳路由器地址 X>**

对于每个相邻路由器 X 发送过来的 RIP 报文，执行如下步骤：

1. 修改此报文中的所有项目：把**下一跳字段中的地址都改为 X**，并把所有**距离字段的值加 1**

2. 对修改后的 RIP 报文中的每个项目，执行如下步骤：

   1. 当原来的路由表中**没有目的网络 N** 时，把该项目**添加到路由表中**

   2. 当原来的路由表中**有目的网络 N，且下一跳路由器的地址是 X** 时，就**替换原路由表中的项目**

   3. 当原来的路由表中**有目的网络 N，且下一跳路由器的地址不是 X** 时

      如果收到的项目中的**距离 d 小于路由表中的距离**，那么就**替换原路由表中的项目**；否则什么也不做

3. 如果 180 秒（默认超时时间）还没有收到更新路由表，就**把此相邻路由器的距离设置为 16**（不可达）

4. 返回

优点：实现简单、开销小、收敛过程较快；缺点：

1. RIP 限制了网络的规模，它能使用的最大距离为 15，**只适用于小型互联网**

2. 路由器之间交换的是路由器中的完整路由表，因此网络规模越大，开销也越大

3. 网络出现故障时，会出现慢收敛现象，俗称**坏消息传得慢**，使更新过程的收敛时间长

   A 的直接网络出错了，距离改为 16，但交换信息时会误以为可以从临近路由到达（每次交换距离加 1，直到加到 16）

RIP 是**应用层协议**，它使用 **UDP** 传送数据，端口 520

例子：`R1-R2-C` 当 `R2` 发现 C 不可达修改为 16，然后更新（同时交换）`R1` 到 C 接受 `R2` 变成 16，`R2` 到 C 接受 `R1` 变成 3

### 开放最短路径优先 OSPF 协议

#### OSPF 协议的基本特点

开放最短路径优先协议是使用分布式**链路状态路由算法**的典型代表，也是**内部网关协议**的一种

OSPF 与 RIP 相比有以下 4 点主要区别：

1. OSPF 向本自治系统中的**所有路由器**发送信息，这里使用的方法是**洪泛法**；RIP 仅向自己**相邻的路由器**发送信息

   泛洪：将从某个接口收到的数据流向除该接口之外的所有接口发送出去

2. OSPF 发送的信息是**相邻的所有路由器的链路状态**；RIP 发送的信息是**整个路由表**

   链路状态：该链路连接的路由器是谁，该链路的度量（代价）是多少

3. OSPF 中**链路状态发生变化时**才发送信息，且**更新过程收敛得快**；RIP 中会**定期交换路由表的信息**

4. OSPF 是**网络层协议，用 IP 数据报传送**，协议字段为 89；RIP 是**应用层协议，用 UDP 协议传送**

OSPF 还有以下特点：

1. OSPF 对于不同类型的业务可计算出不同的路由，十分灵活
2. 可以将通信量分配给多条路径实现多路径间的**负载平衡**
3. 所有在 OSPF 路由器之间交换的分组都具有鉴别功能，因而保证了仅在可信赖的路由器之间交换链路状态信息
4. 支持可变长度的子网划分和**无分类编址 CIDR**
5. 每个链路状态都带上一个 32 位的序号，序号越大，状态就越新

#### OSPF 的基本工作原理

1. 各路由器之间频繁地交换链路状态信息，所有路由器最终都能建立一个链路状态数据库

   这个数据库实际上就是**全网的拓扑结构图**，它在全网范围内是一致的（称为链路状态数据库的同步）

2. 每个路由器根据这个全网拓扑结构图，**使用 Dijkstra 算法计算到各目的网络的最优路径**，以此构造自己的路由表

3. 此后，当**链路状态发生变化时**，每个路由器重新计算到各目的网络的最优路径，**构造新的路由表**

注意：虽然使用 Dijkstra 算法能计算出完整的最优路径，但路由表中<u>只存储下一跳</u>

为使 OSPF 能够用于规模很大的网络，OSPF **将一个自治系统再划分为若干更小的范围**，称为**区域**

划分区域的好处：将利用洪泛法的范围**局限于每个区域**，减少了整个网络上的通信量

一个区域内部的路由器**只知道本区域的完整网络拓扑**，而不知道其他区域的网络拓扑情况

这些区域也有层次之分：处在上层的域称为**主干区域**，负责**连通其他下层的区域和其他自治域**

#### OSPF 的五种分组类型

OSPF 共有以下五种分组类型：

1. 问候分组：用来**发现和维持邻站的可达性**
2. 数据库描述分组：向邻站给出自己的链路状态数据库中的所有链路状态项目的**摘要信息**
3. 链路状态请求分组：向对方请求发送某些链路状态项目的详细信息
4. 链路状态更新分组：用洪泛法对全网更新链路状态
5. 链路状态确认分组：对链路更新分组的确认

通常每隔 10 秒，每两个相邻路由器要交换一次问候分组，以便知道哪些站可达

在路由器刚开始工作时，工作过程如下：

1. 使用问候分组建立邻居关系
2. 让每个路由器使用数据库描述分组和相邻路由器**交换本数据库中已有的链路状态摘要信息**
3. 路由器使用链路状态请求分组，向对方**请求发送自己所缺少的某些链路状态项目的详细信息**
4. 经过一系列的这种分组交换，就建立了全网同步的链路数据库
5. 当链路状态发生变化时，该路由器就要**使用链路状态更新分组，用洪泛法向全网更新链路状态**
6. 其他路由器在更新后，**发送链路状态确认分组对更新分组进行确认**

思考：刚开始交换信息拿到全网的拓扑，使用 Dijkstra 得到最佳路径，生成路由表，以后收到链路变化信息时，修改拓扑再生成路由表；路由器内记录了拓扑图和路由表，路由表是为了方便查询

思考：互发摘要来确认自己缺失什么链路状态，然后发链路请求来获取缺少的链路状态，而不是交互整个链路状态数据库

![image-20211212181133892](..\images\image-20211212181133892.png)

为了确保链路状态数据库与全网的状态保持一致，OSPF 还规定<u>每隔一段时间（如 30 分钟）刷新一次数据库中的链路状态</u>

由于一个路由器的链路状态只涉及与相邻路由器的连通状态，因而与整个互联网的规模并无直接关系

**当互联网规模很大时，OSPF 要比 RIP 好得多**，而且 OSPF 协议没有坏消息传播得慢的问题

### 边界网关协议 BGP

边界网关协议 Border Gateway Protocol，BGP：**不同自治系统的路由器之间交换路由信息**的协议，是一种**外部网关协议**

边界网关协议用于互联网的网关之间，路由表包含**已知路由器列表、路由器能够达到的地址、到达路由器的路径的跳数**

边界网关协议只能力求寻找一条**能够到达目的网络且比较好的路由**（无圈非最佳路由），主要原因如下：

1. 因特网的规模太大，使得自治系统之间路由选择非常困难
2. 对于自治系统之间的路由选择，要寻找最佳路由是很不现实的（自治区权重不一样）
3. 自治系统之间的路由选择必须考虑有关策略

BGP 采用的是**路径向量路由选择**协议，BGP 是**应用层协议，它是基于 TCP 的**

#### BGP 的工作原理

1. 每个自治系统的管理员要**选择至少一个路由器作为该自治系统的 BGP 发言人**
2. 一个 BGP 发言人与其他自治系统中的 BGP 发言人要交换路由信息，就要**先建立 TCP 连接**
3. 在此连接上交换 BGP 报文以**建立 BGP 会话**，再利用 BGP 会话**交换路由信息**
4. 当所有 BGP 发言人都相互交换网络可达性的信息后，各 BGP 发言人就可找出到达各个自治系统的较好路由

每个 BGP 发言人除必须运行 BGP 外，**还必须运行该 AS 所用的内部网关协议**

BGP 所交换的网络可达性信息就是**要到达某个网络所要经过的一系列 AS**

![image-20211212181252769](..\images\image-20211212181252769.png)

#### BGP 的特点

1. BGP 交换路由信息的结点数量级是自治系统的数量级，要比这些自治系统中的网络数少很多
2. 每个**自治系统中 BGP 发言人的数目是很少的**，这样就使得自治系统之间的路由选择不致过分复杂
3. BGP **支持 CIDR**，因此 BGP 的路由表当包括**目的网络前缀、下一跳路由器、要经过的各个自治系统序列**
4. 在 BGP 刚运行时，BGP 的邻站**交换整个 BGP 路由表**，但以后只需在发生变化时**更新有变化的部分**

BGP-4 共使用 4 种报文：

1. 打开 Open 报文：用来与相邻的另一个 BGP 发言人建立关系
2. 更新 Update 报文：用来发送某一路由的信息，以及列出要撤销的多条路由
3. 保活 Keep alive 报文：用来确认打开报文并周期性地证实邻站关系
4. 通知 Notification 报文：用来发送检测到的差错

### 三种协议的比较

![image-20211212181344972](..\images\image-20211212181344972.png)

## IP 组播

### 组播的概念

组播机制是让源计算机**一次发送**的单个分组可以抵达用**一个组地址标识的若干目标主机**，并被它们正确接收

组播一定**仅应用于 UDP**，它可以把一个报文同时发送给多个接收者

源主机把单个分组发送给一个**组播地址**，该组播地址**标识一组地址**，网络把这个分组的副本投递给该组中的每台主机

因特网中的 IP 组播也使用组播组的概念，每个组都有一个特别分配的地址，使用这个地址作为分组的**目标地址**

主机**使用 IGMP 的协议加入组播组**，使用该协议通知本地网络上的路由器，要**接收某个组播组的分组的愿望**

主机组播时仅发送一份数据，只有数据在传送路径出现**分岔时**才将分组复制后继续转发

![image-20211213152003204](..\images\image-20211213152003204.png)

### IP 组播地址

IP 组播使用 **D 类地址格式**，范围是 224.0.0.0～239.255.255.255，**每个 D 类 IP 地址标志一个组播组**

组播的 IP 数据报是使用 **D 类 IP 地址作为目的地址**，并且首部中的**协议字段值是 2**，表明使用 IGMP

需要注意的是：

1. 组播数据报也是“尽最大努力交付”，**不提供可靠交付**
2. 组播地址**只能用于目的地址**，而不能用于源地址
3. 对组播数据报**不产生 ICMP 差错报文**
4. 并非所有的 D 类地址都可作为组播地址

IP 组播可以分为两种：**只在本局域网**上进行硬件组播；在**因特网的范围**内进行组播

在因特网上进行组播的最后阶段，还是要把组播数据报在局域网上用硬件组播交付给组播组的所有成员

### 硬件组播

`IANA` 的**以太网组播地址范围**：`01-00-5E-00-00-00` 到 `01-00-5E-7F-FF-FF`

可见只有 **23 位可用作组播**，和 D 类 IP 地址中的 23 位有一一对应关系

D 类 IP 地址可供分配的有 28 位，可见在这 28 位中，**前 5 位不能用来构成以太网的硬件地址**

![image-20211213152104133](..\images\image-20211213152104133.png)

但 224.128.64.32 和 224.0.64.32 转换成以太网的硬件组播地址都是 `01-00-5E-00-40-20`，因此**收到组播数据报的主机，还要在 IP 层利用软件进行过滤**，把不是本主机要接收的数据报丢弃

### IGMP 与组播路由算法

因特网组管理协议 Internet Group Management Protocol，IGMP：使**路由器知道组播组成员的信息**

- IGMP 让连接到**本地局域网**上的组播路由器知道本局域网上**是否有主机参加或退出了某个组播组**

组播路由选择协议：使连接到**局域网上的组播路由器和因特网上的其他组播路由器协同工作**

IGMP 应视为 TCP/IP 的一部分，其工作可分为两个阶段：

- 第一阶段：

  当某台主机**加入新的组播组**时，该主机应**向组播组的组播地址发送一个 IGMP 报文**，声明自己要成为该组的成员

  本地的组播路由器收到 IGMP 报文后，**将组成员关系转发给因特网上的其他组播路由器**

- 第二阶段：

  本地组播路由器要**周期性地探询本地局域网上的主机**，以便知道这些主机是否仍继续是组的成员

  只要对某个组**有一台主机响应**，那么组播路由器就认为这个**组是活跃的**

  但一个组在经过几次的探询后仍然**没有一台主机响应**时，则不再将该组的成员关系转发给其他的组播路由器

组播路由选择选择：**找出以源主机为根结点的组播转发树**，其中每个分组在每条链路上只传送一次

- <u>不同的多播组对应于不同的多播转发树</u>；同一个多播组，对<u>不同的源点也会有不同的多播转发树</u>

在许多由路由器互联的网络上<u>实现因特网组播</u>，主要有三种路由算法：

1. 基于链路状态的路由选择
2. 基于距离-向量的路由选择
3. **协议无关的组播 `PIM`**：可以建立在任何路由器协议之上

思考：IGMP 处理局域网相关的组播，组播路由选择协议处理局域网间的组播信息

### 思考：组播的过程

以下全是思考得到的，没有依据：

1. 发送者向组播 IP 发送信息，局域网广播发送
2. 到达路由器后，查看 IP 发现是组播 IP 根据组播路由选择协议组发给其他组播内的路由器
3. 到达最后的路由器后，转换成 MAC 组播地址在局域网内广播
4. 接受者发现自己是组播的一员，就处理消息

接受者先根据 MAC 地址检测这是不是自己的组播，再根据 IP 地址检测，若是才处理

```python
## 这是发送端
mcast_group_ip = '239.255.255.252'  # 组播 IP
mcast_group_port = 23456  # 组播给哪个端口

send_sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, socket.IPPROTO_UDP)  # 使用 UDP 协议
message = "this message send via mcast !"
send_sock.sendto(message.encode(), (mcast_group_ip, mcast_group_port))  # 发送组播

## 这是接受端
sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, socket.IPPROTO_UDP)  # 使用 UDP 协议
sock.bind((socket.gethostbyname(socket.gethostname()), mcast_group_port))  # 绑定接受端口

mreq = struct.pack("=4sl", socket.inet_aton("239.255.255.252"), socket.INADDR_ANY)
sock.setsockopt(socket.IPPROTO_IP, socket.IP_ADD_MEMBERSHIP, mreq)  # 加入广播

message, addr = sock.recvfrom(1024)  # 接受消息
print(message.decode())
```

## 移动 IP

### 移动 IP 的概念

支持移动性的因特网体系结构与协议共称为移动 IP，它是为了满足**移动结点在移动中保持其连接性而设计的**

移动 IP 的目标是**把分组自动地投递给移动结点**，移动结点是<u>从一个网络或子网改变到另一个网络或子网的主机</u>

思考：其实就是实现去了其它的局域网，但可以继续使用原局域网的功能

基于 IPv4 的移动 IP 定义三种功能实体：移动结点、归属代理、外部代理；归属代理和外部代理统称为**移动代理**

1. 移动结点：**具有永久 IP 地址的移动结点**
2. 归属网络：在一个网络环境中，**一个移动结点的永久居所**
3. 本地代理，归属代理：在归属网络中**代表移动结点执行移动管理功能的实体**
4. 转交地址，辅地址：移动站点**在外部网络使用的临时地址**（或路由器地址）
5. 外部代理：在外部网络中**帮助移动结点完成移动管理功能的实体**（路由器或移动结点）

### 移动 IP 通信过程

在移动 IP 中，**移动结点都有唯一的本地地址，移动时本地地址不变**，在本地网络上还有一个**本地代理来为它维护位置信息**

移动结点连接到外地网络上时，**转交地址就用来标识移动结点现在所处的位置**，以便进行路由选择

移动结点得到转交地址时，**向本地代理注册转交地址**，以便让本地代理即时了解移动结点的当前位置

移动 IP 技术的基本通信流程如下：

1. 移动结点**在本地网时，按传统的 TCP/IP 方式进行通信**

2. 移动结点漫游到一个外地网络时，仍然使用固定的 IP 地址进行通信

   移动结点需要**向本地代理注册当前的位置地址**，即转交地址，**以收到通信对端发给它的 IP 分组**

3. 本地代理接收注册后，构建一条通向转交地址的隧道，**将截获的发给移动结点的分组通过隧道送到转交地址处**

4. 转交地址处**解除隧道封装，恢复原始的 IP 分组，送到移动结点**，这样就收到发到归属网络的移动结点的信息了

5. 移动结点在外网**通过外网的路由器或外部代理向通信对端发送 IP 数据包**（会在转交地址处进行隧道封装）

6. 移动结点来到另一个外网时，向本地代理**更新注册的转交地址**，就可继续通信

7. 移动结点回到本地网时，向本地代理**注销转交地址**，按传统的 TCP/IP 方式进行通信

思考：移动结点的主地址永不改变，去到其他网络时要申请辅地址，并在本地代理注册后，才能在通信（代理技术）

思考：当归属网络收到移动结点的分组时，会转发给本地代理，本地代理与外部代理建立隧道，发送分组，外部代理收到后转发给移动结点；当移动结点要发送分组也需要给外部代理通过隧道发给内部代理在转发出去

## 网络层设备

### 路由器的组成和功能

路由器是**具有多个输入/输出端口的专用计算机**，其任务是**连接不同的网络并完成路由转发**

当源主机要向目标主机发送数据报时：

- 如果源主机和目标主机在同一个网络上，那么**直接交付**而**无须通过路由器**

- 如果不在同一个网络上，那么**按照转发表将数据报转发给下一个路由器**，这称为**间接交付**

路由器可以连接不同的 LAN、VLAN、WAN，或者把 LAN 和 WAN 互联起来，路由器**隔离了广播域**

从结构上看，路由器由**路由选择和分组转发**两部分构成；从模型上看，路由器是网络层设备，它**实现了网络模型的下三层**

![image-20211214132843925](..\images\image-20211214132843925.png)

路由选择部分也称控制部分，包括：**路由选择处理机、路由选择协议、路由表**

- 路由选择处理机【核心构件】：根据所选定的路由选择协议**构造出路由表**，通过交换路由信息不断**更新和维护路由表**

分组转发部分由三部分组成：

1. 一组输入端口：从物理层接收到的比特流中提取出数据链路层帧，进而从帧中**提取出网络层数据报**

2. 一组输出端口：执行与输入端口恰好相反的操作

3. 交换结构【关键部件】：**根据转发表对分组进行处理**，将某个输入端口进入的**分组从一个合适的输出端口转发出去**

   常用的交换方法：通过**存储器进行交换**、通过**总线进行交换**、通过**互联网络进行交换**

注意：如果一个**存储转发设备**实现了某个层次的功能，那么它就可以**互联两个在该层次上使用不同协议的网段**

路由器主要完成两个功能：

1. 分组转发：**处理通过路由器的数据流**，关键操作是转发表查询、转发及相关的队列管理和任务调度等
2. 路由计算：通过和其他路由器进行基于路由协议的交互，**完成路由表的计算**

现今的路由器一般都提供多种协议的支持，包括 `OSI、TCP/IP、IPX` 等

### 路由表与路由转发

路由表是**根据路由选择算法得出**的，主要用途是路由选择，其结构应**对网络拓扑变化的计算最优化**

标准的路由表有 4 个项目：**目的网络 IP 地址、子网掩码、下一跳 IP 地址、接口**

![image-20211214132948199](..\images\image-20211214132948199.png)

`R1` 的路由表见表：

![image-20211214133007708](..\images\image-20211214133007708.png)

转发表是**从路由表得出**的，其表项和路由表项有直接的对应关系；它和路由表的**格式不同**，其结构应**使查找过程最优化**

转发表中含有一个分组将**要发往的目的地址，以及分组的下一跳**（即下一步接收者的目的地址，实际为 MAC 地址）

使用一个默认路由代替所有相同下一跳的项目，并将默认路由设置得**比其他项目的优先级低**，以**减少转发表的重复项目**

![image-20211214133055858](..\images\image-20211214133055858.png)

路由表总是用**软件**来实现的；转发表可以用**软件**来实现，甚至也可以用**特殊的硬件**来实现

# 传输层

## 传输层提供的服务

### 传输层的功能

传输层向它上面的应用层提供通信服务，它是面向**通信部分的最高层**，也是**用户功能中的最低层**

传输层位于网络层之上，它**为运行在不同主机上的进程之间提供了逻辑通信**，而网络层提供主机之间的逻辑通信

只有**主机的协议栈才有传输层和应用层**，而路由器在转发分组时都只用到下三层的功能（**通信子网中没有传输层**）

![image-20211218152842763](..\images\image-20211218152842763.png)

传输层的功能如下：

1. 传输层提供应用进程之间的**逻辑通信**，即**端到端通信**；而网络层提供的是主机之间的逻辑通信

2. 复用和分用：

   - 复用：发送方<u>不同的应用进程都可使用同一个传输层协议</u>传送数据
   - 分用：接收方的传输层在剥去报文的首部后<u>能够把这些数据正确交付到目的应用进程</u>

   注意：网络层也有复用分用的功能：

   - 复用：发送方<u>不同协议的数据都可以封装成 IP 数据报</u>发送出去
   - 分用：接收方的网络层在剥去首部后<u>把数据交付给相应的协议</u>

3. 传输层还要对收到的整个报文进行**差错检测**；而网络层只检查 IP 数据报的首部

4. 提供两种不同的传输协议，即**面向连接的 TCP 和无连接的 UDP**；而网络层无法同时提供

传输层向高层用户屏蔽了低层网络核心的细节，让进程间存在一条逻辑通信信道，但使用的协议不同也会有很大差别：

- 采用 TCP 时，这种逻辑通信信道就相当于一条全双工的**可靠信道**

- 采用 UDP 时，这种逻辑通信信道仍然是一条**不可靠信道**

### 传输层的寻址与端口

#### 端口的作用

应用进程将数据通过端口交付给传输层，传输层将数据通过端口交付给应用进程，**端口是传输层服务访问点 `TSAP`**

在协议栈层间的抽象的协议端口是软件端口，它与路由器的硬件端口是完全不同的概念：

- 硬件端口：**不同硬件设备进行交互的接口**
- 软件端口：应用层的各种协议进程与传输实体进行**层间交互的一种地址**

传输层使用的是**软件端口**

#### 端口号

应用进程通过端口号进行标识，**端口号长度为 `16bit`，能够表示 65536 个不同的端口号**

端口号**只具有本地意义**，在因特网中，不同计算机的相同端口号是没有联系的

根据端口号范围可将端口分为两类：

1. 服务器端使用的端口号，它又分为两类：

   1. **熟知端口号：数值为 0 ~ 1023**，互联网地址指派机构 `IANA` 把这些端口号指派给了 TCP/IP 最重要的一些应用程序

      一些常用的熟知端口号如下：

      ![image-20211218153029279](..\images\image-20211218153029279.png)

   2. **登记端口号：数值为 1024 ~ 49151**，供没有熟知端口号的应用程序使用

2. 客户端使用的端口号，短暂端口号：数值为 49152 ~ 65535，这类端口号**仅在客户进程运行时才动态地选择**

   通信结束后，刚用过的客户端口号就不复存在，从而这个端口号就可供其他客户进程以后使用

#### 套接字

通过 IP 地址来找到主机，通过端口号找到应用进程；**端口号拼接到 IP 地址即构成套接字 Socket**

在网络中**采用发送方和接收方的套接字来识别端点**，套接字 Socket = (IP 地址, 端口号)，它唯一地标识网络中的一个端点

在网络通信中，主机 A 发给主机 B 的**报文段包含目的端口号和源端口号**，源端口号是返回地址的一部分

### 无连接服务与面向连接服务

- 面向连接服务：通信前建立连接，通信中实时地监控和管理连接，通信结束释放连接
- 无连接服务：通信不需要建立连接；通信时，直接发送信息，尽力而为地往目的地传送

TCP/IP 协议族在 IP 层之上使用了两个传输协议：

1. 面向连接的**传输控制协议 TCP**：传输层向上提供的是一条**全双工的可靠逻辑信道**

   TCP **不提供广播或组播服务**，由于提供了面向连接的可靠传输服务，因此增加了许多开销

   这不仅使协议数据单元的头部增大很多，还要占用许多的处理机资源

   因此 TCP 主要适用于**可靠性更重要的场合**，如 FTP、HTTP、TELNET 等

2. 无连接的**用户数据报协议 UDP**：传输层向上提供的是一条**不可靠的逻辑信道**

   UDP 在 IP 之上仅提供**多路复用和对数据的错误检查**两个附加服务

   UDP 在传送数据之前不需要先建立连接，远程主机的传输层收到 UDP 报文后，不需要给出任何确认

   由于 UDP 比较简单，因此**执行速度比较快、实时性好**，使用 UDP 的应用主要包括 `TFTP`、DNS、`SNMP`、`RTP`

注意：可靠协议：使用**确认机制**对传输数据进行确认

## UDP 协议

### UDP 数据报

#### UDP 概述

UDP 仅在 IP 的数据报服务之上增加了两个最基本的服务：**复用和分用以及差错检测**

如果应用开发者选择 UDP 而非 TCP，那么应用程序几乎直接与 IP 打交道，但 UDP 具有如下优点：

1. UDP 无须建立连接，因此 **UDP 不会引入建立连接的时延**

2. UDP 不维护连接状态，也**不跟踪拥塞控制等参数**，某些专用应用服务器使用 UDP 时，能支持更多的活动客户机

3. **分组首部开销小**，TCP 有 `20B` 的首部开销，而 UDP 仅有 `8B` 的开销

4. 应用层能更好地控制要发送的数据和发送时间，UDP 没有拥塞控制，因此**网络中的拥塞不会影响主机的发送效率**

   某些实时应用要求以稳定的速度发送，能容忍一些数据的丢失，但不允许有较大的时延，而 UDP 正好满足需求

5. UDP **支持一对一、一对多、多对一和多对多的交互通信**

UDP 常用于**一次性传输较少数据的网络应用**；UDP 也常用于**多媒体应用**，如实时视频会议（UDP 延迟小）

UDP 不保证可靠交付，但这并不意味着应用对数据的要求是不可靠的，所有维护**可靠性的工作可由用户在应用层来完成**

UDP 是**面向报文的**，发送方 UDP 对应用层交下来的报文，在**添加首部后就向下交付给 IP 层**；接收方 UDP 对 IP 层交上来 UDP 数据报，在**去除首部后就原封不动地交付给上层应用进程**；因此，应用程序必须选择合适大小的报文

#### UDP 的首部格式

UDP 数据报包含两部分：UDP 首部和用户数据，UDP 首部有 `8B`，由 4 个字段组成，每个字段的长度都是 `2B`

各字段意义如下：

1. 源端口：源端口号，在**需要对方回信时选用**，不需要时可用全 0
2. 目的端口：目的端口号，**必须使用**
3. 长度：UDP 数据报的长度，**包括首部和数据**，其最小值是 8
4. 校验和：**检测 UDP 数据报在传输中是否有错**，有错就丢弃；**可选字段**，不使用时，则直接令该字段为全 0

![image-20211218213310008](..\images\image-20211218213310008.png)

当传输层从 IP 层收到 UDP 数据报时，就**根据首部中的目的端口**，把 UDP 数据报通过相应的端口**上交给应用进程**

如果接收方 UDP 发现**不存在对应于目的端口号的应用进程**，那么就丢弃该报文，并由 ICMP **发送端口不可达**

![image-20211218213357580](..\images\image-20211218213357580.png)

### UDP 校验

在计算校验和时，要在 UDP 数据报之前增加 `12B` 的伪首部：

- 伪首部只是在计算校验和时，临时添加在 UDP 数据报的前面，得到一个临时的 UDP 数据报
- 校验和就是**按照这个临时的 UDP 数据报来计算的**
- **伪首部既不向下传送又不向上递交**，而只是为了计算校验和

下面是伪首部的格式：

![image-20211218213451915](..\images\image-20211218213451915.png)

UDP 校验和的计算方法和 IP 数据报首部校验和的计算方法相似：

1. 发送方首先把**全零放入校验和字段**并**添加伪首部**，其中 UDP 数据报**必须是偶数个字节**

2. 若 UDP 数据报的数据部分**不是偶数个字节**，则要**在末尾填入一个全零字节**（不发送）

3. 然后按二进制反码**计算出这些 16 位字的和**，将此**和的二进制取反码再写入校验和字段**，并发送

   直接相加，若**加法时发生溢出时，要加 1**，结果取反后写入校验字段；使用 16 进制来相加会简单很多

4. 接收方把收到的 UDP 数据报加上伪首部后，按二进制反码求这些 16 位字的和

5. **无差错时其结果应为全 1**，否则就表明有差错出现，接收方就应该丢弃这个 UDP 数据报

下图为例子：UDP 数据报的长度是 `15B`，因此需要添加一个全 0 字节：

![image-20211218213535980](..\images\image-20211218213535980.png)

注意：

1. 校验时，若 UDP 数据报部分的**长度不是偶数个字节，则需填入一个全 0 字节**，此字节是不发送的
2. 如果校验出 UDP 数据报是错误的，**可以丢弃或交付给上层**，但交付时需要附上错误报告

这种简单的差错检验方法的检错能力并不强，但它的好处是**简单、处理速度快**

注意：计算结果为 0 时，填全 1，因为加法溢出时要加 1，接受方校验结果也是全 1

## TCP 协议

### TCP 协议的特点

TCP 是**在不可靠的 IP 层之上实现的可靠的数据传输协议**，它的主要特点如下：

1. TCP 是面向连接的传输层协议
2. 每条 TCP 连接只能有两个端点，每条 TCP 连接**只能是点对点的**
3. TCP 提供可靠的交付服务，保证传送的数据**无差错、不丢失、不重复且有序**
4. TCP 提供**全双工通信**，为此 TCP 连接的两端都**设有发送缓存和接收缓存**，用来临时存放双向通信的数据
   - 发送缓存用来暂时存放以下数据：TCP **准备发送**的数据；TCP **已发送但尚未收到确认**的数据
   - 接收缓存用来暂时存放以下数据：按序到达但尚**未被接收应用程序读取**的数据；**不按序到达**的数据
5. TCP 是**面向字节流**的，它把应用程序交下来的数据仅视为一连串的无结构的字节流

注意：UDP 报文的长度由发送应用进程决定；TCP 报文的长度则根据**接收方给出的窗口值和当前网络拥塞程度**来决定

如果应用进程传送到 TCP 缓存的数据块太长，TCP 就把它**划分得短一些再传送**；如果太短，TCP 也可以等到**积累足够多的字节后再组成报文段发送出去**

### TCP 报文段

**TCP 传送的数据单元称为报文段**，TCP 报文段可以用来运载数据、建立连接、释放连接和应答

一个 TCP 报文段分为首部和数据两部分，整个 TCP 报文段作为 IP 数据报的数据部分封装在 IP 数据报中

首部的前 `20B` 是固定的，TCP 报文段的首部**最短为 `20B`**，后面有 `4N` 字节是根据需要而增加的选项，**长度为 `4B` 的整数倍**

![image-20211219154359807](..\images\image-20211219154359807.png)

TCP 的全部功能体现在其首部的各个字段中，各字段意义如下：

1. 源端口和目的端口：各占 `2B`，和 UDP 端口作用一样

2. 序号：占 `4B`，范围为 $0\sim2^{32}-1$，**本报文段所发送的数据的第一个字节的序号**

3. 确认号：占 `4B`，**期望收到对方下一个报文段的第一个数据字节的序号**

   若确认号为 N，则表明到序号 N - 1 为止的所有数据都已正确收到

4. 数据偏移，即首部长度：占 4 位，表示首部长度，它**指出 TCP 报文段的数据起始位置**，数据**偏移的单位是 32 位**

5. 保留：占 6 位，保留为今后使用，但目前应置为 0

6. 紧急位 `URG`：`URG` = 1 时，表明**紧急指针字段有效**，它告诉系统此报文段中**有紧急数据，应尽快传送**（发送方使用）

   但 `URG` 需要**和紧急指针配合使用**，即数据**从第一个字节到紧急指针所指字节就是紧急数据**

7. 确认位 ACK：仅**当 ACK = 1 时确认号字段才有效**；TCP 规定，在<u>连接建立后所有传送的报文段都必须把 ACK 置 1</u>

8. 推送位 `PSH`：**接收方** TCP 收到 `PSH` = 1 的报文段，就**尽快地交付给接收应用进程**，不用等到缓存填满后再向上交付

9. 复位位 `RST`：`RST` = 1 时，<u>表明 TCP 连接中出现严重差错，必须释放连接，然后再重新建立运输连接</u>

10. 同步位 SYN：同步 SYN = 1 表示**这是一个连接请求或连接接受报文**

    当 SYN = 1，ACK = 0 时，表明这是一个连接请求报文；若对方同意建立连接，则在响应报文中使用 SYN = 1，ACK = 1

11. 终止位 FIN：用来**释放一个连接**，当 FIN = 1 时，表明数据已发送完毕，并要求释放传输连接

12. 窗口：占 `2B`，范围为 $0\sim2^{16}-1$，它指出现在**允许对方发送的数据量**

    接收方的数据缓存空间是有限的，因此用窗口值作为接收方让发送方设置其发送窗口的依据

    注意：滑动窗口过小会产生过多的 ACK，而过大会使路由器变得拥塞，导致主机丢失分组

13. 校验和：占 `2B`，检验的范围包括首部和数据两部分，**计算方法和 UDP 一样**，唯一不同是**伪首部的第 4 字段是 6**

14. 紧急指针：占 `2B`，仅在 `URG` = 1 时才有意义，它指出在本报文段中**紧急数据共有多少字节**

15. 选项：长度可变，TCP 最初只有最大报文段长度 MSS 一种选项，MSS 是 TCP **报文段中的数据字段的最大长度**

16. 填充：**使整个首部长度是 `4B` 的整数倍**

思考：TCP 没有长度字段是因为在 IP 上给出分组的长度，减一下就得到 TCP 的长度，UDP 那个长度字段是冗余的

### TCP 连接管理

TCP 是面向连接的协议，因此每个 TCP 连接都有三个阶段：连接建立、数据传送、连接释放

在 TCP 连接建立的过程中，要解决以下三个问题：

1. 要使每一方能够**确知对方的存在**
2. 要允许双方**协商一些参数**，如最大窗口值、时间戳选项等
3. 能够**对运输实体资源进行分配**，如缓存大小等

TCP 把连接作为最基本的抽象，每条 TCP 连接有两个端点，**TCP 连接的端点为套接字 socket 或插口**

**TCP 连接的建立采用 C/S 方式**，主动发起连接建立的应用进程称为客户，而被动等待连接建立的应用进程称为服务器

#### TCP 连接的建立

连接的建立经历以下 3 个步骤，通常称为三次握手：

![image-20211219154554463](..\images\image-20211219154554463.png)

连接建立前，服务器进程处于 LISTEN 状态，等待客户的连接请求：

1. 客户机的 TCP 首先**向服务器的 TCP 发送连接请求**报文段

   这个特殊报文段的首部中的**同步位 SYN 置 1**，同时**选择一个初始序号 seq = x**

   SYN 报文段**不能携带数据，但要消耗掉 1 个序号**；TCP 客户进程进入同步已发送 SYN-SENT 状态

2. 服务器的 TCP 收到连接请求报文段后，如同意建立连接，则**向客户机发回确认**，并**为该 TCP 连接分配缓存和变量**

   在确认报文段中，把 **SYN 位和 ACK 位都置 1**，**确认号是 ack = x + 1**，同时**选择一个初始序号 seq = y**

   确认报文段**不能携带数据，但要消耗掉 1 个序号**；TCP 服务器进程进入同步收到 `SYN-RCVD` 状态

3. 当客户机收到确认报文段后**向服务器给出确认**，并**为该 TCP 连接分配缓存和变量**

   确认报文段的 **ACK 位置 1，确认号 ack = y + 1，序号 seq = x + 1**

   该报文段**可以携带数据**，若**不携带数据则不消耗序号**；TCP 客户进程进入已建立连接 ESTABLISHED 状态

TCP 提供的是全双工通信，因此**通信双方的应用进程在任何时候都能发送数据**

注意：由于服务器比客户端早一步分配资源，这就使得服务器易于受到 SYN 洪泛攻击

额外：若采用两次握手：若客户端向服务端的连接请求在某个结点长时间滞留，客户端再次连接并完成传输后断开，这时滞留的连接请求到达服务端，服务端返回确认报文段，但客户端认为无效并丢弃，但服务端认为连接建立，就白白消耗了资源

额外：若序号都从 1 开始：假设带数据的报文段滞留，在下个连接才到，序号又刚好在新连接的窗口内，从而被收下导致结果错误，因此新连接的序号一定要和前面的连接用过的序号不同

#### TCP 连接的释放

TCP 连接释放的过程通常称为四次握手，两边都能终止连接：

![image-20211219154814274](..\images\image-20211219154814274.png)

1. 客户机关闭连接时，向其 TCP **发送连接释放报文段**，并停止发送数据，主动关闭 TCP 连接

   该报文段的终止位 **FIN 置 1，序号 seq = u**，它是**最后一个字节的序号加 1**

   FIN 报文段即使**不携带数据，消耗掉 1 个序号**；TCP 客户进程进入终止等待1 FIN-WAIT-1 状态

2. 服务器收到连接释放报文段后即**发出确认**

   **确认号 ack = u + 1，序号 seq = v**，它是**最后一个字节的序号加 1**

   然后服务器进入关闭等待 CLOSE-WAIT 状态；<u>客户机到服务器这个方向的连接就释放了</u>

3. 若服务器没有要发送的数据了，此时发出 **FIN = 1，序号 seq = w 的连接释放报文段**

   还须重复上次已发送的**确认号 ack = u + 1**；服务器进入最后确认 LAST-ACK 状态

4. 客户机收到连接释放报文段后，必须**发出确认**

   把确认报文段中的确认位 **ACK 置 1，确认号 ack = w + 1，序号 seq = u + 1**

   经过时间最长报文段寿命 `2MSL` 后，客户机才进入连接关闭 CLOSED 状态

   额外：等待 `2MSL` 是为了防止确认报文段丢失，不然丢失后服务器会一直重发，客户端关闭了也收不到

#### 总结

1. **连接建立，分为 3 步：**
   1. SYN = 1，seq = x
   2. SYN = 1，ACK = 1，seq = y，ack = x + 1
   3. ACK = 1，seq = x + 1，ack = y + 1
2. **释放连接，分为 4 步：**
   1. FIN = 1，seq = u
   2. ACK = 1，seq = v，ack = u + 1
   3. FIN = 1，ACK = 1，seq = w， ack = u + 1
   4. ACK = 1，seq = u + 1，ack = w + 1

### TCP 可靠传输

TCP 的任务是**在 IP 层上建立一种可靠数据传输服务**，保证接收方进程收到的字节流与发送方发出的字节流完全一样

TCP 使用了**校验、序号、确认和重传**等机制来达到这一目的，其中 TCP 的校验机制与 UDP 校验一样

#### 序号

TCP 首部的序号字段用来保证**数据能有序提交给应用层**，TCP 把数据视为一个无结构但有序的字节流

TCP 连接传送的数据流中的**每个字节都编上一个序号**，序号字段的值是指本报文段所发送的数据的**第一个字节的序号**

如下图，发送缓冲区共有 `10B`，序号从 0 开始，第一个报文段的序号是 0，第二个报文的的序号是 3

![image-20211219155015917](..\images\image-20211219155015917.png)

#### 确认

TCP 首部的确认号是**期望收到对方的下一个报文段的数据的第一个字节的序号**，TCP 默认使用**累计确认**

下图中，如果接受了第一个报文段，那么发送的确认号为 3

![image-20211219155015917](..\images\image-20211219155015917.png)

发送方缓存区会继续**存储那些已发送但未收到确认的报文段**，以便在需要时重传

注意：TCP 采用的是**对报文段的确认机制**，因为它是对每个报文段进行确认，而不是对每个字节进行确认

注意：判断服务器已接受应用层数据字节的大小，可以使用最后一个的 ACK 减去第三次握手的 SEQ

#### 重传

有两种事件会导致 TCP 对报文段进行重传：超时和冗余 ACK

选择题：分组重传的最大值是发送方能发送的最大值，等于滑动窗口大小

##### 超时

TCP 每发送一个报文段，就对这个报文段**设置一次计时器**，重传时间到期但还未收到确认时，就要重传这一报文段

由于 TCP  的下层是一个互联网环境，IP 数据报所选择的路由变化很大，因而**传输层的往返时延的方差也很大**

为了计算超时计时器的重传时间，TCP 采用一种自适应算法，它记录一个报文段的往返时间 RTT

TCP **保留了 RTT 的一个加权平均往返时间 `RTTs`**，它会随新测量 RTT 样本值的变化而变化

- 如新估计 RTT = (1 - α) × (旧 RTT) + α × (新 RTT 样本)

超时计时器设置的**超时重传时间 `RTO` 应略大于 `RTTs`**，但也不能大太多，否则 TCP 不能很快重传，导致数据传输时延大

##### 冗余 ACK

超时重传的周期往往太长，因此发送方**通过注意冗余 ACK 来较好地检测丢包情况**

冗余 ACK：接收方**再次发送某个报文段的确认 ACK**，而发送方先前已经收到过该报文段的确认了

TCP 规定每当**比期望序号大的失序报文段到达时**，就**发送一个冗余 ACK** 指明下一个期待字节的序号

TCP 规定发送方**收到对同一个报文段的 3 个冗余 ACK 时**，就认为**被确认报文段之后的那个报文段已经丢失**

这种技术通常称为**快速重传**，冗余 ACK 还被用在拥塞控制中，[这将在后面的内容中讨论](#快重传)

注意：冗余是指，**发送了某个报文段后**，还对其前面的报文段进行确认

### TCP 流量控制

TCP 提供流量控制服务来消除**发送方发送速率太快，从而使接收方缓存区溢出**的可能性

TCP 提供一种**基于滑动窗口协议的流量控制机制**，滑动窗口在数据链路层有介绍

在通信过程中，**接收方根据自己接收缓存的大小，动态地调整发送方的发送窗口大小**来实现流量控制

- 接收窗口 rwnd：**`TCP` 报文段首部中的窗口字段值**；通过调整 rwnd，来限制发送方向网络注入报文的速率

发送方总是**根据最新收到的 rwnd 值来限制自己发送窗口的大小**，从而保证**不会使接收方的接受缓冲溢出**

如下图，建立连接时确认 rwnd 为 400，期间进行了三次流量控制，最后把窗口减小到 rwnd = 0

![image-20211219155211882](..\images\image-20211219155211882.png)

TCP 为每一个连接设有一个持续计时器，只要 TCP 连接的一方**收到对方的零窗口通知，就启动持续计时器**

若持续计时器设置的时间到期，就**发送一个零窗口探测报文段**，接收方收到探测报文段时**给出现在的窗口值**

传输层和数据链路层的流量控制的区别是：

1. 传输层定义**端到端用户之间的流量控制**，数据链路层定义两个中间的相邻结点的流量控制
2. 数据链路层的滑动窗口协议的窗口大小不能动态变化，**传输层的则可以动态变化**

### TCP 拥塞控制

拥塞控制是指**防止过多的数据注入网络，保证网络中的路由器或链路不致于过载**

出现拥塞时，端点并不了解拥塞发生的细节，对通信连接的端点来说，**拥塞往往表现为通信时延的增加**

拥塞控制与流量控制的区别：

- 拥塞控制：让网络能够承受现有的网络负荷，**是一个全局性的过程**，涉及所有与降低网络传输性能有关的所有因素
- 流量控制：对点对点的通信量的控制，**是个端到端的问题**，它抑制发送端发送数据的速率，以便接收端来得及接收

但拥塞控制和流量控制**都通过控制发送方发送数据的速率来达到控制效果**

TCP 协议要求发送方维护以下两个窗口：

1. 接收窗口 rwnd：接收方根据目前接收缓存大小来确定的最新窗口值，**反映接收方的容量**

2. 拥塞窗口 cwnd：发送方根据自己估算的网络拥塞程度而设置的窗口值，**反映网络的当前容量**

   只要网络未出现拥塞，拥塞窗口就再增大一些，以便把更多的分组发送出去

   但只要网络出现拥塞，拥塞窗口就减小一些，以减少注入网络的分组数

发送方在确定发送报文段的速率时，**既要考虑接收方的接收能力，又要考虑不要使网络发生拥塞**

因此发送窗口的上限值应取接收窗口 rwnd 和拥塞窗口 cwnd 中较小的一个，即**发送窗口的上限值 = min[rwnd, cwnd]**

因特网建议标准定义了进行拥塞控制的 4 种算法：慢开始、拥塞避免、快重传、快恢复；下面介绍发送方如何维护 cwnd

#### 慢开始和拥塞避免

##### 慢开始算法

在 TCP 刚刚连接好并开始发送 TCP 报文段时，先**令拥塞窗口 cwnd = 1**，即**一个最大报文段长度 MSS**

**每收到一个对新报文段的确认后，将 cwnd 加 1**，逐步增大发送方的 cwnd，**使分组注入网络的速率更加合理**

注意：是收到对新报文段确认才加 1，每次发送的报文段数量翻倍，所以接收到的确认翻倍，即 cwnd 翻倍

慢开始的慢是指在 TCP 开始发送报文段时先设置 cwnd = 1，然后再逐渐增大 cwnd，这对防止网络出现拥塞很有用

**每经过一个传输轮次**，即往返时延 RTT，**cwnd 就会加倍，当 cwnd 达到慢开始门限 ssthresh，就改用拥塞避免算法**

注意：这里 cwnd = 1 是方便写法，实际上 cwnd = 1 × MSS

##### 拥塞避免算法

拥塞避免算法的思路是让拥塞窗口 cwnd 缓慢增大，具体做法是：

**每经过一个往返时延 RTT 就把 cwnd 加 1**，使拥塞窗口 cwnd 按线性规律缓慢增长，这比慢开始的增长速率缓慢得多

根据 cwnd 的大小执行不同的算法，可归纳如下：

- **当 cwnd < ssthresh 时，使用慢开始算法**
- **当 cwnd > ssthresh 时，改用拥塞避免算法**
- **当 cwnd = ssthresh 时，既可使用拥塞避免算法（通常做法）**，又可使用慢开始算法

##### 网络拥塞的处理

1. 无论在慢开始阶段还是在拥塞避免阶段，只要发送方**判断网络出现拥塞（即出现超时重传）**

   就要**把慢开始门限 ssthresh 设置为出现拥塞时的发送方的 cwnd 值的一半**，但不能小于 2

2. 然后**把拥塞窗口 cwnd 重新设置为 1，执行慢开始算法**

   以便迅速减少主机发送到网络中的分组数，使得发生拥塞的路由器有足够时间把队列中积压的分组处理完

慢开始和拥塞避免算法的实现过程如下图：

1. 初始时，拥塞窗口置为 1，即 cwnd = 1，慢开始门限置为 16，即 ssthresh = 16

2. 慢开始阶段，cwnd 的初值为 1，以后发送方每收到一个确认 ACK，cwnd 加 1

   当拥塞窗口 cwnd 增长到慢开始门限 ssthresh 时，就改用拥塞避免算法，cwnd 按线性规律增长

3. 假定 cwnd = 24 时网络出现超时，更新 ssthresh 值为 12，cwnd 重置为 1，执行慢开始算法

![image-20211219155521144](..\images\image-20211219155521144.png)

注意：在慢开始阶段，**若 `2cwnd > ssthresh`，则下一个 RTT 后的 cwnd 等于 ssthresh**，而不等于 `2cwnd`

在慢开始和拥塞避免算法中使用了乘法减小和加法增大方法：

- 乘法减小：在慢开始阶段或拥塞避免阶段，<u>出现超时，就把慢开始门限值 ssthresh 设置为当前拥塞窗口的一半</u>

  **网络频繁出现拥塞时，ssthresh 值就下降得很快**，以大大减少注入网络的分组数

- 加法增大：执行拥塞避免算法后，在收到对所有报文段的确认后，即经过一个 RTT

  就把拥塞窗口 cwnd 增加一个 MSS 大小，**使拥塞窗口缓慢增大，以防止网络过早出现拥塞**

拥塞避免不是指完全避免拥塞，而是指在拥塞避免阶段把拥塞窗口控制为按线性规律增长，**使网络比较不容易出现拥塞**

#### 快重传和快恢复

快重传和快恢复算法是对慢开始和拥塞避免算法的改进

##### 快重传

[TCP 可靠传输机制中](#冗余 ACK)，快重传技术使用了冗余 ACK 来检测丢包的发生

同样，**冗余 ACK 也用于网络拥塞的检测**，因为丢包了就意味着网络可能出现了拥塞

快重传**并非取消重传计时器**，而是在某些情况下可**更早地重传丢失的报文段**

##### 快恢复

快恢复算法的原理如下：

1. 发送方连续**收到三个冗余 ACK 时，执行乘法减小算法**，把慢开始门限 ssthresh 设置为此时发送方 cwnd 的一半

2. 并**把 cwnd 值设置为慢开始门限 ssthresh 改变后的数值**，然后开始**执行拥塞避免算法**，使拥塞窗口缓慢地线性增大

   发送方认为网络很可能没有发生严重拥塞，否则就不会有几个报文段连续到达接收方也不会连续收到重复确认

由于跳过了拥塞窗口 cwnd 从 1 起始的慢开始过程，所以被称为**快恢复**

快恢复算法的实现过程如下，作为对比，虚线为慢开始的处理过程：

![image-20211219155756204](..\images\image-20211219155756204.png)

在流量控制中，发送方发送数据的量**由接收方决定**；在拥塞控制中，则由发送方**自己通过检测网络状况来决定**

总结：TCP **连接建立和网络出现超时**时，采用**慢开始和拥塞避免**算法；**接收到冗余 ACK** 时，采用**快重传和快恢复**算法

### 题目

TCP 的拥塞窗口的慢开始门限值初始为 8（单位为报文段），当拥塞窗口上升到 12 时发生超时，TCP 开始慢启动和拥塞避免，那么第 13 次传输时拥塞窗口的大小为 7

- 拥塞窗口变化为 1, 2, 4, 8, 9, 10, 11, 12, 1, 2, 4, 6, 7, 8, 9, … 第 13 次传输时拥塞窗口为 7

【研】若甲向乙发起一个 TCP 连接，最大段长 `MSS=1KB`，`RTT=5ms`，乙开辟的接收缓存为 `64KB`、则甲从连接建立成功至发送窗口达到 `32KB`，需经过的时间至少是 `25ms`。

- 至少时间就按照慢开始 2 幂次来算（最长时间按加 1 算），`32KB / MSS = 32` 故拥塞窗口要达到 32，刚开始是 1，`5ms` 后变 2，`5ms` 后变 4，到 32 共需要 `25ms`

【研】假设下图中的 `H3` 访问 Web服务器 S 时，S 为新建的 TCP 连接分配了 `20KB`（K=1024）的接收缓存，最大段长 `MSS=1KB`，平均往返时间 RTT = `200ms`。`H3` 建立连接时的初始序号为 100，且持续以 MSS 大小的段向 S 发送数据，拥塞窗口初始阈值为  `32KB`；S 对收到的每个段进行确认，并通告新的接收窗口。假定 TCP 连接建立完成后，S 端的 TCP 接收缓存仅有数据存入而无数据取出。请回答下列问题：

![image-20220824210953420](..\images\image-20220824210953420.png)

1. 在 TCP 连接建立过程中，`H3` 收到的 S 发送过来的第二次握手 TCP 段的 SYN 和 ACK 标志位的值分别是多少？确认序号是多少？

2. `H3` 收到的第 8 个确认段所通告的接收窗口是多少？此时 `H3` 的拥塞窗口变为多少？`H3` 的发送窗口变为多少？

3. `H3` 的发送窗口等于 0 时，下一个待发送的数据段序号是多少？`H3` 从发送第 1 个数据段到发送窗口等于 0 时刻为止，平均数据传输速率是多少？（忽略段的传输延时）

4. 若 `H3` 与 S 之间通信已经结束，在 1 时刻 `H3` 请求断开该连接，则从 1 时刻起，S 释放该连接的最短时间是多少？

解答：

1. 根据题目建立时的初始序号为 100，可得 SYN = 1, ACK = 1, SEQ = 101

2. 接受每个确认段，拥塞窗口会加 1，而接受窗口会减一，所以 8 个确认段后，拥塞窗口为 9 接受窗口为 12，而发送窗口为它们间的较小值为 9

3. 发送窗口为 0 时序号为 `20K` + 101 = 20 × 1024 + 101 = 20581；`H3` 从发送第一段到发送窗口为 0 需要 5 个 RTT（1 2 4 8 5 0）

   故平均传输速率为 `20KB/(5×200ms)=20.48k×8b/s=163.84kb/s`

4. 在最快情况下 `H3` 发送释放请求，S 请求释放并带上对 `H3` 的确认，`H3` 在对 S 进行确认，共 1.5 个 RTT 即 `300ms`

# 应用层

## 网络应用模型

### 客户/服务器模型

在客户/服务器 C/S 模型中，有一个**总是打开的主机称为服务器**，它服务于许多来自其他称为客户机的主机请求

其工作流程如下：

1. 服务器处于接收请求的状态
2. 客户机发出服务请求，并等待接收结果
3. 服务器收到请求后，分析请求，进行必要的处理，得到结果并发送给客户机

客户/服务器模型最主要的特征是：**客户是服务请求方，服务器是服务提供方**

- 客户程序**必须知道服务器程序的地址**，客户机上一般不需要特殊的硬件和复杂的操作系统
- 服务器上**运行提供某种服务的程序**，可同时处理多个远程或本地客户的要求，服务器程序**不需要知道客户程序的地址**

常见的 C/S 模型的应用包括 Web、文件传输协议、远程登录和电子邮件等

客户/服务器模型的主要特点还有：

1. **网络中各计算机的地位不平等**，服务器管理用户权限，使客户机不能随意存储/删除数据，或进行其他受限的网络活动

   整个网络的管理工作由少数服务器担当，因此网络的管理非常集中和方便

2. **客户机相互之间不直接通信**

3. 可扩展性不佳，受服务器硬件和网络带宽的限制，**服务器支持的客户机数有限**

![image-20211220202944500](..\images\image-20211220202944500.png)

### P2P 模型

P2P 模型的思想是整个网络中的传输内容不再被保存在中心服务器上，**每个结点的权利和义务都是大体对等的**

![image-20211220203019030](..\images\image-20211220203019030.png)

在 P2P 模型中，各计算机没有固定的客户和服务器划分，**任意一对计算机——称为对等方，直接相互通信**

P2P 模型从本质上来看仍然使用 C/S 方式，每个结点既作为客户访问资源，又作为服务器提供资源

常见的 P2P 模型的应用包括 `PPlive`、`Bittorrent` 和电驴等

与 C/S 模型相比，P2P 模型的优点主要体现如下：

1. **消除了对某个服务器的完全依赖**，将任务分配到各个结点上，因此大大提高了系统效率和资源利用率
2. **多个客户机之间可以直接共享文档**
3. 可扩展性好，不限制客户机数量
4. 网络健壮性强，单个结点的失效不会影响其他部分的结点

P2P 模型也有缺点：

- 在获取服务的同时，还要给其他结点提供服务，因此会**占用较多的内存影响整机速度**
- 经常进行 P2P 下载还会**对硬盘造成较大的损伤**
- 据统计 P2P 程序已占互联网 50%～90% 的流量，**使网络变得非常拥塞**，因此各大 `ISP` 通常都对P2P应用持反对态度

## 域名系统

域名系统 Domain Name System，DNS 是因特网使用的命名系统，用来**把域名转换为 IP 地址**

注意：DNS 系统**采用客户/服务器模型，其协议运行在 UDP 之上，使用 53 号端口**

从概念上可将 DNS 分为 3 部分：层次域名空间、域名服务器、解析器

### 层次域名空间

因特网采用层次树状结构的命名方法：任何一个连接到因特网的主机或路由器，都可以有一个唯一的层次结构名称，即域名

域是名字空间中一个可被管理的划分，**域可以划分为子域，子域也可以划分**，这样就形成了顶级域、二级域、三级域等

如下图域名，由三个标号组成，其中标号 com 是顶级域名，标号 `cskaoyan` 是二级域名，标号 `www` 是三级域名

![image-20211221131051147](..\images\image-20211221131051147.png)

关于域名中的标号有以下几点需要注意：

1. 标号中的**英文不区分大小写**
2. 标号中**除连字符 - 外不能使用其他的标点符号**
3. 每个**标号不超过 63 个字符**，多标号组成的**完整域名最长不超过 255 个字符**
4. **级别最低的域名写在最左边，级别最高的顶级域名写在最右边**

顶级域名 Top Level Domain，`TLD` 分为如下三大类：

1. 国家顶级域名：国家和某些地区的域名，如 `.cn` 表示中国 `.us` 表示美国 `.uk` 表示英国
2. 通用顶级域名：常见的有公司 .com、网络服务机构 .net、非营利性组织 `.org`、国家或政府部门 .gov 等
3. 基础结构域名：这种顶级域名只有一个，即 `arpa`，用于反向域名解析，因此又称反向域名

国家顶级域名下注册的二级域名均由该国家自行确定；下图展示了域名空间的树状结构：

![image-20211221131203055](..\images\image-20211221131203055.png)

域名系统中，**每个域由不同的组织进行管理**，每个组织将域再分成一定数目的子域并委托给其他组织去管理

如管理 `CN` 域的中国将 `EDU.CN` 子域授权给中国教育和科研计算机网来管理

### 域名服务器

因特网的域名系统被设计成一个**联机分布式的数据库系统**，并采用客户/服务器模型

- 域名到 IP 地址的解析是由运行在域名服务器上的程序完成的，**一个服务器所负责管辖的范围称为区**
- **每个区设置相应的权限域名服务器**，用来保存该区中的所有主机的域名到 IP 地址的映射

注意：IP 到域名不是一一对应的关系，一个 IP 可以有多个域名

每个域名服务器不但能够进行一些域名到 IP 地址的解析，而且还**必须具有连向其他域名服务器的信息**

当自己不能进行域名到 IP 地址的转换时，能够知道到什么地方去找其他域名服务器

DNS 使用了大量的域名服务器，它们以层次方式组织，**因特网上所有主机的映射分布在所有的 DNS 上**

主要有 4 种类型的域名服务器：

![image-20211221131319745](..\images\image-20211221131319745.png)

#### 根域名服务器

根域名服务器是最高层次的域名服务器，所有的根域名服务器都**知道所有的顶级域名服务器的 IP 地址**

本地域名服务器**对因特网上的域名无法解析时，就首先要求助于根域名服务器**，它是最重要的域名服务器

因特网上有 13 个根域名服务器，每个服务器都是冗余服务器的集群，以提供安全性和可靠性

注意：根域名服务器用来管辖顶级域（如 .com），通常它只**返回相应的顶级域名服务器的 IP**，而不返回代查询域名的 IP

#### 顶级域名服务器

这些域名服务器负责**管理在该顶级域名服务器注册的所有二级域名**

收到 DNS 查询请求时，就给出相应的回答，可能是代查询域名的 IP，也可能是相应的授权域名服务器的 IP

#### 授权域名服务器

每台有域名的主机**都要在授权域名服务器处登记**，为了更加可靠地工作，一台主机最好至少有两个授权域名服务器

实际上，许多域名服务器都同时充当本地域名服务器和授权域名服务器（权限域名服务器）

授权域名服务器**总能将其管辖的主机名转换为该主机的 IP 地址**

#### 本地域名服务器

本地 DNS 对域名系统非常重要，每个因特网服务提供者，或一所大学甚至里面的一个系，都可以有一个本地 DNS

当一台**主机发出 DNS 查询请求时**，这个查询请求报文就**发送给该主机的本地域名服务器**

我们在 Windows 系统中配置本地连接时，就需要填写 DNS 地址，这个地址就是本地 DNS 的地址

### 域名解析过程

域名解析：**把域名映射成为 IP 地址或把 IP 地址映射成域名的过程**，前者称为正向解析，后者称为反向解析

客户端需要域名解析时，用本机的 DNS 客户端构造一个 DNS 请求报文，以 UDP 数据报方式发往本地域名服务器

域名解析有两种方式：递归查询、递归与迭代相结合的查询

![image-20211221131435930](..\images\image-20211221131435930.png)

递归查询：本地域名服务器**只需向根域名服务器查询一次**，后面要做的事交给根 DNS，根 DNS 又交给其它 DNS，由于**该方法给根域名服务造成的负载过大**，所以在实际中几乎不使用

递归与迭代相结合的查询方式：该方式分为两个部分：

1. 主机向本地域名服务器的查询采用的是递归查询

   主机向本地 DNS 发送请求后，**所有的事都交由本地 DNS 处理**，由它向根 DNS 发送请求，而不是由自己发送

2. 本地域名服务器向根域名服务器的查询采用迭代查询

   假定某客户机想获知域名为 `y.abc.com` 主机的 IP 地址，域名解析的过程如下：

   1. 客户机**向其本地域名服务器发出 DNS 请求报文**
   2. 本地域名服务器收到请求后，**查询本地缓存**，若没有该记录，则**向根域名服务器发出解析请求报文**
   3. 根域名服务器收到请求后，判断该域名属于.com 域，**返回对应的顶级域名服务器 `dns.com` 的 IP 地址**
   4. 本地域名服务器**向顶级域名服务器 `dns.com` 发出解析请求报文**
   5. 顶级域名服务器收到请求后，判断该域名属于 `abc.com` 域，**返回对应的授权域名服务器 `dns.abc.com` 的 IP 地址**
   6. 本地域名服务器**向授权域名服务器 `dns.abc.com` 发起解析请求报文**
   7. 授权域名服务器 `dns.abc.com` 收到请求后，**将查询结果返回给本地域名服务器**
   8. 本地域名服务器**将查询结果保存到本地缓存，同时返回给客户机**

   注意：如果是 `z.y.abc.com` 的话授权域名服务器 `dns.abc.com` 会返回授权域名服务器 `dns.y.abc.com` 的 IP，要多迭代一次

为了提高 DNS 的查询效率，并减少因特网上的 DNS 查询报文数量，在域名服务器中广泛地使用了高速缓存（主机也有）

因为主机名和 IP 地址之间的映射不是永久的，所以 DNS 服务器将**在一段时间后丢弃高速缓存中的信息**

## 文件传输协议

### FTP 的工作原理

文件传输协议 File Transfer Protocol，FTP 是因特网上使用得最广泛的文件传输协议

FTP 提供交互式的访问，**允许客户指明文件的类型与格式**，并**允许文件具有存取权限**

它**屏蔽了各计算机系统的细节**，因而适合于在异构网络中的**任意计算机之间传送文件**

FTP 提供以下功能：

1. 提供**不同种类主机系统之间的文件传输能力**
2. 以用户权限管理的方式提供**用户对远程 FTP 服务器上的文件管理能力**
3. 以匿名 FTP 的方式**提供公用文件共享的能力**

FTP 采用 C/S 的工作方式，它**使用 TCP** 可靠的传输服务，一个 FTP 服务器进程**可同时为多个客户进程提供服务**

FTP 的服务器进程由两大部分组成：一个**主进程，负责接收新的请求**；另外有若干**从进程，负责处理单个请求**

其工作步骤如下：

1. **打开控制端口 21**，使客户进程能够连接上
2. **等待客户进程发连接请求**
3. **启动从属进程来处理客户进程发来的请求**（处理完客户请求后终止）
4. **回到等待状态**，继续接收其他客户进程的请求

FTP 服务器必须**在整个会话期间保留用户的状态信息**，服务器必须追踪用户在远程目录树上的当前位置

### 控制连接与数据连接

FTP 在工作时使用两个并行的 TCP 连接：一个是**控制连接端口号 21**，一个是**数据连接端口号 20**

使用两个不同的端口号可**使协议更加简单和更容易实现**

![image-20211221192942605](..\images\image-20211221192942605.png)

#### 控制连接

服务器监听 21 号端口，等待客户连接，建立在这个端口上的连接称为控制连接

控制连接用来传输控制信息（如连接请求、传送请求等)，并且**控制信息都以 7 位 ASCII 格式传送**

FTP 客户发出的传送请求，通过控制连接发送给服务器端的控制进程，但**控制连接并不用来传送文件**

在传输文件时还可以使用控制连接（如中止传输的命令），因此**控制连接在整个会话期间一直保持打开状态**

#### 数据连接

服务器端的控制进程在接收到 FTP 客户发来的文件传输请求后，就创建数据传送进程和数据连接

数据连接用来**连接客户端和服务器端的数据传送进程**，数据传送进程完成文件的传送后关闭数据传送连接并结束运行

数据连接有两种传输模式：主动模式 PORT 和被动模式 PASV

- PORT 模式的工作原理：

  客户端要读取数据时，客户端**随机开放一个端口，并发送命令告知服务器**

  服务器收到 PORT 命令和端口号后，**通过 20 端口和客户端开放的端口连接**，发送数据

- PASV 模式的工作原理：客户端要读取数据时，**发送 PASV 命令到服务器**，服务器在本地**随机开放一个端口，并告知客户端**，客户端**连接到服务器开放的端口**进行数据传输

- 可见，用 PORT 模式还是 PASV 模式，**选择权在客户端**

主动模式传送数据：**服务器连接到客户端的端口**；被动模式传送数据：**客户端连接到服务器的端口**

------

因为 FTP 使用了一个分离的控制连接（两个连接），所以也称 **FTP 的控制信息是带外传送 Out-of-band 的**

使用 FTP 时，若要修改服务器上的文件，则需要先将文件传送到本地，修改完再发回去，来回传送耗费很多时间

而网络文件系统 NFS 则在该**文件的某个特定位置**开始读写数据，仅**发送用户当前使用的小块数据**

## 电子邮件

### 电子邮件系统的组成结构

电子邮件是一种异步通信方式，通信时**不需要双方同时在场**

电子邮件<u>把邮件发送到收件人使用的邮件服务器</u>，并放到收件人邮箱中，<u>收件人可以随时到邮件服务器进行读取</u>

一个电子邮件系统应具有三个最主要的组成构件：**用户代理 User Agent、邮件服务器、电子邮件使用的协议**

1. 用户代理：**用户与电子邮件系统的接口**

   向用户**提供很友好的接口**来发送和接收邮件，至少应当具有撰写、显示和邮件处理的功能

   通常情况下，用户代理就是一个**运行在 PC 上的程序**，常见的有 Outlook 和 `Foxmail` 等

2. 邮件服务器：它的功能是**发送和接收邮件**，还要**向发信人报告邮件传送的情况**，如已交付、被拒绝、丢失等

   邮件服务器采用 C/S 方式工作，但它必须**能够同时充当客户和服务器**

   负责**发送邮件的 SMTP 进程就是 SMTP 客户**，而负责**接收邮件的 SMTP 进程就是 SMTP 服务器**

3. 电子邮件使用的协议：由邮件发送协议和读取协议组成

   邮件发送协议：用于**用户代理向邮件服务器发送邮件**或在**邮件服务器之间发送邮件**，如 SMTP

   邮件读取协议：用于**用户代理从邮件服务器读取邮件**，如 POP3

   注意：**SMTP 用的是推的通信方式**，SMTP 客户将邮件推送到 SMTP 服务器；**POP3 用的是拉的通信方式**，用户代理从邮件服务器拉取用户邮箱中的邮件

![image-20211222160814393](..\images\image-20211222160814393.png)

电子邮件的发送、接收过程可简化为如图所示：

![image-20211222160940649](..\images\image-20211222160940649.png)

电子邮件的收发过程：

1. 发信人**用用户代理来撰写和编辑邮件**，用户代理**用 SMTP 把邮件传送给发送端邮件服务器**
2. 发送端邮件服务器将邮件**放入邮件缓存队列中**，等待发送
3. 发送端邮件服务器的 SMTP 客户进程，发现邮件缓存中有待发送的邮件，**向接收端 SMTP 服务器发起建立 TCP 连接**
4. 连接建立后，**向接收端 SMTP 服务器发送邮件**，发完后关闭 TCP 连接
5. 接收端 SMTP 服务器收到邮件后，**将邮件放入收信人的用户邮箱**，等待收信人在方便时进行读取
6. 收信人打算收信时，**调用用户代理**，使用邮件读取协议，**将邮件从接收端邮件服务器的用户邮箱中取回**

注意：若 POP3 地址设置错误，则会导致用户无法接收邮件；SMTP 地址错误会导致无法发送邮件；E-mail 地址错误时，可能会发错人，也可能会导致投递失败

### 电子邮件格式与 MIME

#### 电子邮件格式

一个电子邮件分为**信封和内容**两大部分，邮件内容又分为**首部和主体**两部分

RFC 822 规定了邮件的首部格式，而邮件的主体部分则让用户自由撰写

用户写好首部后，<u>邮件系统自动地将信封所需的信息提取出来并写在信封上</u>，用户不需要亲自填写信封上的信息

邮件内容的**首部包含一些首部行**，首部行由**关键字: 值**组成，有些关键字是必需的，有些则是可选的：

1. To 是必需的关键字，后面填入**一个或多个收件人的电子邮件地址**

   电子邮件地址的格式：**收件人邮箱名@邮箱所在主机的域名**，其中**收信人邮箱名在邮件服务器上必须是唯一的**

2. Subject 是可选关键字，是**邮件的主题**，反映了邮件的主要内容

3. From 是必填的关键字 ，发送者的邮箱地址，**由邮件系统自动填入**

首部与主体之间用一个空行进行分割，典型的邮件内容如下：
$$
\begin{aligned}&\left.\begin{aligned}&From:hoopdog@hust.edu.cn\\&To:abc@cskaoyan.com\\&Subject:Say\ hello\ to\ Internet\end{aligned}\right\}首部\\\\&\left.\begin{aligned}&blahblah\cdots\\&\cdots\end{aligned}\right\}主体\end{aligned}
$$

#### 多用途网际邮件扩充 MIME

由于 **SMTP 只能传送一定长度的 ASCII 码**，为了传输非 ASCII 码的数据，提出了多用途网络邮件扩充 MIME

MIME 的意图是**继续使用目前的格式**，但增加了邮件主体的结构，并**定义了传送非 ASCII 码的编码规则**

MIME 并未改动 SMTP 或取代它，MIME 邮件可在现有的电子邮件程序和协议下传送：

![image-20211222161205419](..\images\image-20211222161205419.png)

MIME 主要包括以下三部分内容：

1. **5 个新的邮件首部字段**：MIME 版本、内容描述、内容标识、传送编码、内容类型
2. **定义了许多邮件内容的格式**，对多媒体电子邮件的表示方法进行了标准化
3. **定义了传送编码**，可对任何内容格式进行转换，而内容不会被邮件系统改变

### SMTP 和 POP

#### SMTP

简单邮件传输协议 SMTP 是提供**可靠且有效**的电子邮件传输的协议，它**控制两个相互通信的 SMTP 进程交换信息**

**SMTP 用的是 TCP 连接，端口号为 25**，SMTP 通信有以下三个阶段：

##### 连接建立

发件人的邮件发送到发送方邮件服务器的邮件缓存中

1. SMTP 客户就**每隔一定时间对邮件缓存扫描一次**
2. 若发现有邮件，就使用 SMTP 的熟知端口号 25 **与接收方邮件服务器的 SMTP 服务器建立 TCP 连接**
3. 连接建立后，接收方 SMTP 服务器**发出 220 Service ready**
4. 然后 SMTP 客户向 SMTP 服务器**发送 `HELO` 命令，附上发送方的主机名**

SMTP **不使用中间的邮件服务器**，接收方邮件服务器出故障不能建立连接时，发送方的邮件服务器**等待一段时间后再次连接**

##### 邮件传送

连接建立后，就可开始传送邮件：

1. 邮件的传送从 MAIL 命令开始，格式为 **MAIL 发件人的地址**

2. 若 SMTP 服务器已准备好接收邮件，则**回答 250 mail accepted**

3. SMTP 客户端发送**一个或多个** RCPT 命令，格式为 **RCPT TO:<收件人地址>**

4. 每发送一个 RCPT 命令，都应有相应的信息从 SMTP 服务器返回，**如 250 recipient accepted 或 550 no such user here**

   RCPT 命令的作用是，防止发送了很长的邮件后才知道地址错误，进而避免浪费通信资源

5. 获得 OK 的回答后，客户端就**使用 DATA 命令，表示要开始传输邮件的内容**

6. 正常情况下 SMTP 服务器回复的信息是 **354 Start mail input; end with \<CRLF\>.\<CRLF\>**，\<CRLF\>表示回车换行

7. 此时 SMTP 客户端就可**开始传送邮件内容**

8. 传输完成后**用 \<CRLF\>.\<CRLF\> 表示邮件内容的结束**

##### 连接释放

邮件发送完毕后，SMTP 客户**发送 QUIT 命令**

SMTP 服务器**返回的信息是 221**，表示 SMTP 同意释放 TCP 连接，**邮件传送的全部过程就此结束**

##### 具体过程

```
A: 220 beta.gov simple mail transfer service ready
B: HELO alpha.edu
A: 250 beta.gov
B: MAIL FROM:<smith@alpha.edu>
A: 250 mail accepted
B: RCPT TO:<jones@beta.gov>
A: 250 recipient accepted
B: RCPT TO:<green@beta.gov>
A: 550 no such user here
B: RCPT TO:brown@beta.gov
A: 250 recipient accepted
B: DATA
A: 354 start mail input; end with <CR><LF>.<CR><LF>
B: Date:Fri 27 May 2011 14:16:21 BJ
B: From:smith@alpha.edu
B: …
B: \r\n.\r\n
A: 250 OK
B: QUIT
A: 221 beta.gov service closing transmission channel.
```

#### POP3 和  IMAP

邮局协议 Post Office Protocol，POP 是一个非常简单但功能有限的邮件读取协议，现在使用的是它的第 3 个版本 POP3：

- POP3 采用的是拉的通信方式，当用户读取邮件时，用户代理向邮件服务器发出请求，**拉取用户邮箱中的邮件**
- POP 也使用 C/S 的工作方式，在**传输层使用 TCP，端口号为 110**
- 接收方的**用户代理上必须运行 POP 客户程序**，而接收方的**邮件服务器上则运行 POP 服务器程序**
- 选择题：POP3 协议在传输层使用明文来传输密码，并不对密码进行加密

POP 有两种工作方式：下载并保留和下载并删除：

- 下载并保留：**读取邮件后，邮件依然会保存在邮件服务器上**，用户可再次从服务器上读取该邮件
- 下载并删除：**邮件一旦被读取，就被从邮件服务器上删除**，用户不能再次从服务器上读取

另一个邮件读取协议是因特网报文存取协议 IMAP，它比 POP 复杂得多：

- IMAP 为用户提供了创建文件夹、在文件夹间移动邮件、在文件夹中查询邮件等联机命令，它**维护了会话用户的状态信息**

- IMAP **允许用户代理只获取报文的某些部分**，如可以只读取一个报文的首部，或多部分 MIME 报文的一部分

  这非常适用于低带宽的情况，用户可能并不想取回邮箱中的所有邮件，尤其是包含很多音频或视频的大邮件

随着万维网的流行，目前出现了很多基于万维网的电子邮件，如 `Hotmail`、`Gmail` 等：

- **用户浏览器与 `Hotmail` 或 `Gmail` 的邮件服务器之间**的邮件**发送或接收使用的是 HTTP**
- 仅在**不同邮件服务器之间传送邮件时才使用 SMTP**

## 万维网 WWW

### WWW 的概念与组成结构

万维网 World Wide Web，WWW 是一个分布式、联机式的信息存储空间，在这个空间中：**一个有用的事物称为一个资源**

这些资源由**全域统一资源定位符 URL** 标识，并通过**超文本传输协议 HTTP** 发给使用者，使用者通过单击链接来获取资源

万维网使用链接可以方便地**从因特网上的一个站点访问另一个站点**，从而主动地按需获取丰富的信息

超文本标记语言 HTML 使得万维页面可以使用超链接方便地**链接其他万维页面**，并在计算机屏幕上显示这些页面

万维网的内核部分是由三个标准构成的：

1. 统一资源定位符 URL：负责**标识万维网上的各种文档**，每个文档**具有唯一的标识符 URL**

   对因特网上可得到的**资源的位置和访问方法的一种简洁表示**，相当于一个文件在网络上的名字

2. 超文本传输协议 HTTP：**使用 TCP 的应用层协议**，是万维网客户程序和服务器程序之间**交互所必须遵守的协议**

3. 超文本标记语言 HTML：一种**文档结构的标记语言**，它使用一些约定的标记对页面上的各种信息、格式进行描述

URL 的一般形式是：**<协议>://<主机>:<端口>/<路径>**

1. <协议>：用什么协议来获取万维网文档，常见的协议有 HTTP、FTP 等
2. <主机>：存放资源的主机在因特网中的**域名或 IP 地址**
3. <端口> 和 <路径> 有时可省略
4. 注意：**URL 中不区分大小写**

万维网**以 C/S 方式工作**，浏览器是万维网**客户程序**，万维网文档所驻留的主机（万维网服务器）运行服务器程序

客户程序向服务器程序发出请求，服务器程序返回客户所要的万维网文档，工作流程如下：

1. Web 用户**使用浏览器与 Web 服务器建立连接**，并**发送浏览请求**
2. Web 服务器**把 URL 转换为文件路径**，并**返回信息给 Web 浏览器**
3. 通信完成，关闭连接

万维网是**无数个网络站点和网页的集合**，它们在一起**构成了因特网最主要的部分**（因特网还包括电子邮件等）

### 超文本传输协议 HTTP

HTTP 定义了浏览器怎样向万维网服务器请求万维网文档，以及服务器怎样把文档传送给浏览器

从层次的角度看，HTTP 是**面向事务的应用层协议**，它规定了在**浏览器和服务器之间的请求和响应的格式与规则**

这是万维网上能够可靠地交换文件（包括文本、声音、图像等各种多媒体文件）的重要基础

#### HTTP 的操作过程

从协议执行过程来说，浏览器要访问 WWW 服务器时，**首先要完成对 WWW 服务器的域名解析**

一旦获得了服务器的 IP 地址，浏览器就**通过 TCP 向服务器发送连接建立请求**

万维网的大致工作过程如下：

1. 每个万维网站点都有一个服务器进程，它不断地**监听 TCP 的端口 80**
2. 当监听到连接请求后便与浏览器建立 TCP 连接
3. 浏览器就**向服务器发出 HTTP 请求**
4. 服务器收到请求后，将**构建所请求 Web 页的必需信息**，并通过 HTTP 响应返回给浏览器
5. 浏览器对信息进行解释，然后将 Web 页显示给用户
6. 最后，TCP 连接释放

![image-20211222214649474](..\images\image-20211222214649474.png)

HTTP 有两类报文：**请求报文（浏览器 → 服务器）和响应报文（服务器 → 浏览器）**

用户在浏览器输入 http://www.tsinghua.edu.cn/chn/index.htm 并回车后发生的事件如下：

1. 浏览器**分析链接指向的页面的 URL**
2. 浏览器向 DNS 请求**解析 www.tsinghua.edu.cn 的 IP 地址**
3. 域名系统 DNS **解析出 IP 地址并发送给浏览器**
4. 浏览器**与服务器建立 TCP 连接**（默认 80 端口）
5. 浏览器**发出 HTTP 请求**：`GET /chn/index.htm`
6. 服务器通过 HTTP 响应**把文件 `index.htm` 发送给浏览器**
7. **释放 TCP 连接**
8. 浏览器解释文件 `index.htm`，并**将 Web 页显示给用户**

#### HTTP 的特点

HTTP 使用 TCP 作为运输层协议，以便不必考虑数据在传输过程中被丢弃后要怎样被重传

**HTTP 本身是无连接的**，即通信的双方在交换 HTTP 报文之前**不需要先建立 HTTP 连接**

**HTTP 是无状态的**，即一个客户两次访问一个服务器得到的响应相同，因为服务器不会去记忆访问的客户

HTTP 的无状态特性**简化了服务器的设计**，使服务器**更容易支持大量并发的 HTTP 请求**

在实际应用中，通常**使用 Cookie 加数据库的方式来跟踪用户的活动**，Cookie 的工作原理：

1. 用户浏览使用 Cookie 的网站时，该网站服务器就**为用户产生一个唯一的识别码**，如 123456

   接着**在响应报文中添加一个首部行 Set-cookie: 123456**

2. 用户收到响应后，就在它管理的**特定 Cookie 文件**中添加这个**服务器的主机名和 Cookie 识别码**

3. 当用户再浏览这个网站时，会**取出这个网站的识别码**，并放入请求报文的 Cookie 首部行 Cookie: 123456

4. 服务器**根据请求报文中的 Cookie 识别码从数据库中查询到该用户的活动记录**，进而执行一些个性化的工作

5. 注意：Cookie 内放的唯一识别码叫 `SessionID`，Cookie 不是唯一的，且可以放很多东西

HTTP 既可以使用非持久连接，也可以使用持久连接（HTTP/1.1 支持）：

- 非持久连接：每个网页元素的传输都需要**单独建立一个 TCP 连接**，第三次握手中**捎带了客户对万维网文档的请求**

  请求一个万维网文档所需的时间是该**文档的传输时间**加上**两倍往返时间 RTT**（建立连接 + 请求和接收文档）

  **每个对象都导致 2 × RTT 的开销**，且每**建立新的 TCP 连接都要分配缓存和变量**，使万维网服务器的负担很重

  ![image-20211222214849978](..\images\image-20211222214849978.png)

- 持久连接：万维网服务器在发送响应后**仍然保持这条连接**，以便可以继续在这条连接上**传送后续的 HTTP 请求和响应报文**

  ![image-20211222214922153](..\images\image-20211222214922153.png)

持久连接又分为非流水线和流水线两种方式：

1. 非流水线方式：客户在**收到前一个响应后才能发出下一个请求**，上图就是非流水线方式

   服务器发送完一个对象后，其 TCP 连接就处于空闲状态，浪费了服务器资源

2. 流水线方式：客户**每遇到一个对象引用就立即发出一个请求**不需要等待响应，HTTP/1.1 的默认方式

如果所有的请求和响应都是连续发送的：

1. 流水线方式：所有引用的对象**共计经历 1 个 RTT 延迟**
2. 非流水线方式：**每个引用都必须有 1 个 RTT 延迟**

#### HTTP 的报文结构

HTTP 是面向文本的，因此**报文中的每个字段都是一些 ASCII 码串**，并且每个字段的长度都是不确定的

有两类 HTTP 报文：

- 请求报文：从客户向服务器发送的请求报文
- 响应报文：从服务器到客户的回答

![image-20211222215021476](..\images\image-20211222215021476.png)

HTTP 请求报文和响应报文都由**开始行、首部行、实体主体**组成，这两种报文格式的区别就是开始行不同

1. 开始行：用于**区分是请求报文还是响应报文**

   - 在请求报文中的开始行称为**请求行**，请求行有三个内容：**请求方法、请求资源的 URL、HTTP 的版本**
   - 在响应报文中的开始行称为**状态行**，状态行有三个内容：**HTTP 版本、结果状态码，状态码相应的短语**

   开始行的三个字段之间**用空格分隔**，最后的 CR 和 `LF` 分别代表回车和换行

   请求方法是**对所请求对象进行的操作**，这些方法实际上也就是一些命令：

   ![image-20211222215137245](..\images\image-20211222215137245.png)

2. 首部行：用来**说明浏览器、服务器或报文主体的一些信息**，首部可以有几行，但也可以不使用

   在每个首部行中都有**首部字段名和它的值**，每一行在结束的地方都要有**回车和换行**

   整个首部行结束时，还有**一空行将首部行和后面的实体主体分开**

3. 实体主体：在请求报文中**一般不用这个字段**，而在响应报文中也**可能没有这个字段**

下图为使用 `Wireshark` 捕获的 HTTP 请求报文，结合前面的内容对请求报文进行分析

![image-20211222215216323](..\images\image-20211222215216323.png)

1. 数据链路层：

   1 ~ 6 字节为目的 MAC 地址，如果是主机发的话它是默认网关地址，即 `00-0f-e2-3f-27-3f`

   7 ~ 12 个字节为本机 MAC 地址，即 `00-27-13-67-73-8d`

   13 ~ 14 个字节 08 00 为类型字段，表示上层使用的是 IP 数据报协议

2. 网络层：15 ~ 34 个字节为 IP 数据报的首部（`20B`）

   27 ~ 30 个字节为源 IP 地址，即 `db-df-d2-70`（219.223.210.112）

   31 ~ 34 个字节为目的 IP 地址，即 `71-69-4e-0a`（113.105.78.10）

3. 传输层：35～54 个字节为 TCP 报文段的首部（`20B`）

4. 应用层：55 个字节开始是 TCP 数据部分，即从应用层传递下来的数据

   GET 对应请求行的方法，`/face/20.gif` 对应请求行的 URL，HTTP/1.1 对应请求行的版本

   还有首部行，如 `Host: bbs.szhome.com\r\n` 表示服务器的主机，一般会带有这个首部行

### 应用层协议小结

![image-20211223182951324](..\images\image-20211223182951324.png)

DNS 与主机在同一个局域网，当主机要给 Internet 上的 HTTP 服务器发送请求：

1. 使用 ARP 获取 DNS 的 MAC
2. 请求 DNS 解析 HTTP 服务器的域名
3. DNS 响应 HTTP 服务器的 IP（期间可能通过路由器访问根域名服务器）
4. 使用 ARP 获取路由器 IP
5. 发送 HTTP 请求

